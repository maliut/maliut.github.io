<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Mの综合研究]]></title><description><![CDATA[somewhere about myself]]></description><link>https://maliut.space</link><generator>GatsbyJS</generator><lastBuildDate>Sun, 31 Jan 2021 09:17:21 GMT</lastBuildDate><item><title><![CDATA[立即执行函数的另一个作用]]></title><description><![CDATA[之前发了一个有关 JavaScript 中立即执行函数（IIFE）的想法，但还想多写一点东西。立即执行函数是 JavaScript 中很特殊的一种用法。由于 JavaScript…]]></description><link>https://maliut.space/p/iife-statement-to-expression/</link><guid isPermaLink="false">https://maliut.space/p/iife-statement-to-expression/</guid><pubDate>Sun, 31 Jan 2021 17:00:00 GMT</pubDate><content:encoded>&lt;p&gt;之前发了一个有关 JavaScript 中&lt;em&gt;立即执行函数（IIFE）&lt;/em&gt;的想法，但还想多写一点东西。立即执行函数是 JavaScript 中很特殊的一种用法。由于 JavaScript 原生没有成熟的模块化机制，立即执行函数曾被广泛地用于编写独立的模块和库，以防止全局变量的名称冲突，但随着 ES6 标准对于模块化和块级作用域支持的完善，这种用法也逐渐退出了历史舞台，顶多出现在被 Polyfill 转译的代码里。&lt;/p&gt;
&lt;p&gt;在网上的讨论中，提到立即执行函数的作用，基本上都是说用于隔离作用域，防止全局命名空间冲突。但在实践中我发现了它的另一个作用，即将任意 &lt;strong&gt;statement&lt;/strong&gt; 转化为 &lt;strong&gt;expression&lt;/strong&gt; 的能力。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;statement 与 expression&lt;/h2&gt;
&lt;p&gt;在学习编程时，我们就学到过 statement 和 expression 这两个概念，但是当时我完全没有在意这些偏理论性的名词，因为觉得直接看代码就很直观了，不讨论这些名词也不妨碍我写代码。一直到代码经验比较多了，且接触了各种不同语言的语法和一些奇技淫巧，才逐渐意识到区分这两者的重要性。&lt;/p&gt;
&lt;p&gt;为了写这篇文章，我特意 Google 了一下 statement 和 expression 的准确定义，但发现网上也是众说纷纭，有把它们作为两个对等的概念的，也有说是包含关系的。但抛开这些定义上的细节不同，大家对两者的差别还是有共识的：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;expression 是一段执行以后会返回一个值的代码，而 statement 只是执行一段逻辑，并不产生一个返回值。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在大多数语言中，expression 主要包括数字、字符串等字面量以及连接它们的运算符，而 statement 会包含一些赋值与控制流语句。例如：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// expressions:&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;expression&quot;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; Math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; x 

&lt;span class=&quot;token comment&quot;&gt;// statements:&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;将 statement 转化为 expression&lt;/h2&gt;
&lt;p&gt;让我们关注一个常见的使用场景：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some other logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这段代码根据 &lt;code class=&quot;language-text&quot;&gt;id&lt;/code&gt; 的值不同，执行不同的逻辑，并将计算后的值赋给 &lt;code class=&quot;language-text&quot;&gt;this.name&lt;/code&gt; 变量。&lt;code class=&quot;language-text&quot;&gt;switch&lt;/code&gt; 语句是典型的 statement ，它根据值的不同进入不同的分支。但很多时候每个分支的逻辑是类似的，例如上面的例子，我们计算的结果最终都是为了赋值，那这个赋值的操作就被重复了多次，引起了代码冗余，很不优雅。&lt;/p&gt;
&lt;p&gt;有些语言中支持一种名为 switch expression 的语法，顾名思义，这种语法支持将 &lt;code class=&quot;language-text&quot;&gt;switch&lt;/code&gt; 语句变成一个 expression，执行完后返回一个值。用这种语法改写后的代码形如：（伪代码）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; 
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some other logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到确实简洁了很多。&lt;/p&gt;
&lt;p&gt;JavaScript 目前并不支持这样的做法，但通过立即执行函数，我们可以变通地实现这一功能。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some other logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得益于它是一个函数，不仅是 &lt;code class=&quot;language-text&quot;&gt;switch&lt;/code&gt; 语句，条件判断、循环等语句，甚至是更加复杂的逻辑，都可以使用这种方式转化为一个 expression 。&lt;/p&gt;
&lt;h2&gt;这样做有意义吗？&lt;/h2&gt;
&lt;p&gt;从功能的角度，确实原本的 &lt;code class=&quot;language-text&quot;&gt;switch&lt;/code&gt; 语句功能也完全够用了，要说代码冗余也不是很严重，这么做并没有特别明显的好处。但是从代码的优雅与可读性的角度，我认为改写成 expression 的形式确实更好一些。&lt;/p&gt;
&lt;p&gt;一个佐证是 Java 在 JDK 12 中也增加了对 switch expression 的支持。作为一门被广泛使用的工业级语言，Java 并不一直追求最时髦的语言特性，甚至被人诟病语法繁琐臃肿（虽然最近已经大大加快了迭代的节奏）。连 Java 中都如此高优先级地对这一语法做了支持，足以说明这一功能在程序员中的呼声是很大的。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; today &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;day&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; SAT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SUN&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Weekend day&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MON&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; TUS&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; WED&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; THU&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FRI&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Working day&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Invalid day: &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; day&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 JavaScript 中，除了与其他语言相同的应用场景之外，还有一个场合可能会用到立即执行函数封装后的 expression，那就是 React 的 JSX 语法。我们经常需要根据条件渲染 JSX 元素，但在 JSX 中混入逻辑代码时，代码的内容必须为 expression，这时我们就可以用上这个技巧。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-jsx line-numbers&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CompA&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;B&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CompB&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;C&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CompC&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CompA&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;从更宏观的角度来说，这实际上是需不需要将任何语句都设计为 expression 的问题。将代码分为 statement 和 expression 并不是理所当然的设计。例如，在函数式编程中，就没有 statement，只有 expression，通过 expression 的串联使代码更为简洁流畅。&lt;/p&gt;
&lt;p&gt;有些面向对象的语言也借鉴了这一思路，例如 Ruby 中几乎一切都是 expression，连类定义和方法定义也不例外。即使在传统的 OO 设计中，也涌现出了 Fluent interface 之类的设计，通过将 setter 改写为返回上下文的 expression 来实现优雅的流式接口调用。&lt;/p&gt;
&lt;p&gt;我个人还是很喜欢这样的设计理念的。当然这个话题比较大，就不离题下去讲了。&lt;/p&gt;
&lt;h2&gt;为什么是匿名函数？&lt;/h2&gt;
&lt;p&gt;回到 JavaScript ，也许有人会说，这没什么特别的，完全可以把逻辑抽取到一个独立的函数中来实现相同的效果。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getNameById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;some other logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getNameById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样做当然可以。一般来说，如果是多次出现的可复用的逻辑，都是建议单独抽取成函数，减少代码重复。但函数也并不是拆分得越细越好的。如果这段逻辑与上下文关联比较紧密，拆分的成本会比较高，而且在阅读代码时需要上下文切换，理解多个参数之间的对应关系，降低了代码的可读性。而且函数的命名也是一个经常困扰开发者的问题。&lt;/p&gt;
&lt;p&gt;总的来说，虽然使用匿名函数来实现的原理和拆分函数是一样的，但是在这里我们不要过于纠结它的本质原理，而是充分利用 JavaScript 提供的简洁语法，将其作为一种语法糖来使用。（可以类比同样 JavaScript 中的 &lt;code class=&quot;language-text&quot;&gt;!!&lt;/code&gt; 语法，虽然从原理上来说并没有什么特别之处，但也经常出现在 x 个不为人知的 JavaScript 小技巧中。）&lt;/p&gt;
&lt;h2&gt;迁移到其他语言&lt;/h2&gt;
&lt;p&gt;其他语言中没有 JavaScript 的立即执行函数语法，那么它们能借鉴这一思路实现类似的功能吗？并不是不行。这里我们给出一个低版本的 Java 语言实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;some logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;some other logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; logic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们使用 Java 中的匿名内部类来实现将 statement 转化为 expression 。&lt;code class=&quot;language-text&quot;&gt;Callable&lt;/code&gt; 老实说在 Java 中并不是很常用，可以理解为拥有了返回一个值的能力的 &lt;code class=&quot;language-text&quot;&gt;Runnable&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;可以对比一下与 JavaScript 版本的区别。在 Java 版本中，匿名内部类的语法相对比较繁冗，虽然可以利用 Java 8 的 lambda 进一步简化，但终究省不了一些方法名和关键字的出现，而这会对阅读代码产生一定的视觉干扰；而 JavaScript 的立即执行函数配合箭头函数，全是由符号组成的，我们在阅读代码时可以很轻松地将其省略，聚焦到核心的逻辑上。&lt;/p&gt;
&lt;p&gt;另外 Java 中匿名内部类引用外部变量时，必须要把外部变量声明为 &lt;code class=&quot;language-text&quot;&gt;final&lt;/code&gt;  即不可变的，虽然很严谨不过写起来也会觉得比较麻烦。&lt;/p&gt;
&lt;p&gt;再次，Java 在编译时会把匿名内部类编译为一个单独的类，逻辑比较重，因此虽然这样写有一定好处，但并没有好到能够无视它的代价，去肆无忌惮使用的程度。&lt;/p&gt;
&lt;p&gt;其他语言中有没有类似的做法，我就不太清楚了。也许它们都比不上 JavaScript 中那么优雅简洁，不过本身也不失为一种有趣的用法，有兴趣的同学可以在项目中尝试一下。&lt;/p&gt;
&lt;h2&gt;结论&lt;/h2&gt;
&lt;p&gt;本文探索了一种通过立即执行函数来实现将任意 statement 转化为 expression ，以减少重复代码，提升可读性的方式，是一个鲜为人知但非常实用的技巧，很适合在 JavaScript 中使用。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[【译】JavaScript 游戏循环详解]]></title><description><![CDATA[前言：游戏循环（Game Loop）是做游戏时绕不开的一个话题。网上已经有很多文章讲解了如何在网页中使用 JavaScript 实现游戏循环，但基本上都只提到  就完事了。这只能用来做个 demo…]]></description><link>https://maliut.space/p/javascript-game-loop/</link><guid isPermaLink="false">https://maliut.space/p/javascript-game-loop/</guid><pubDate>Wed, 23 Dec 2020 21:58:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;前言：游戏循环（Game Loop）是做游戏时绕不开的一个话题。网上已经有很多文章讲解了如何在网页中使用 JavaScript 实现游戏循环，但基本上都只提到 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 就完事了。这只能用来做个 demo ，对一个完整的游戏来说是远远不够的。正好之前毕设时查阅了相关资料，对比之下这篇文章讲的最为全面。因此我翻译了这篇文章，希望能给大家带来帮助。&lt;/p&gt;
&lt;p&gt;原文链接：&lt;a href=&quot;http://isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing&quot;&gt;http://isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!--more--&gt;
&lt;p&gt;在任何状态随时间改变的应用中，主循环都是核心的部分。在游戏中，主循环一般被称为&lt;em&gt;游戏循环&lt;/em&gt;，既要负责计算物理与 AI，也要把计算出来的画面渲染在屏幕上。很不幸，在网上能找到的大多数主循环的实现 —— 尤其是以 JavaScript 来编写的 —— 都存在着一些计时上的问题。不瞒你说，我自己也写过不少错误的实现。这篇文章旨在告诉你为什么这么多主循环需要被修正，以及如何实现一个正确的主循环。&lt;/p&gt;
&lt;p&gt;如果你不想看讲解，而只是想直接拿正确的代码来用，可以使用我的开源库 &lt;a href=&quot;https://github.com/IceCreamYou/MainLoop.js&quot;&gt;MainLoop.js&lt;/a&gt; 。&lt;/p&gt;
&lt;h2&gt;初次尝试&lt;/h2&gt;
&lt;p&gt;我们即将来编写一个“游戏”。简单起见，只是来画一个会左右来回移动的方块。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-html line-numbers&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;box&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;让它展示出来：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-css line-numbers&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;#box&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;background-color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; red&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 50px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 150px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; absolute&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 10px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 50px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;看上去还不错。接下来我们来搭建 JavaScript 应用的脚手架。首先，我们的方块需要一些属性来控制它的位置和速度。我们用一个 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 函数来渲染它的位置。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; box &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;box&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 方块&lt;/span&gt;
    boxPos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 方块的位置&lt;/span&gt;
    boxVelocity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 方块的速度&lt;/span&gt;
    limit &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 方块跑多远以后调头&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    box&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;style&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;left &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; boxPos &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;px&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后是游戏的逻辑。我们希望方块来回移动，所以要给它加个速度。你很快就会发现，从这里就慢慢开始出错了。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    boxPos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; boxVelocity&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 如果跑过头了，就让方块调头&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;boxPos &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; limit &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; boxPos &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; boxVelocity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;boxVelocity&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;现在让我们把游戏跑起来。为了跑这个游戏，我们需要一个循环，不停地调用 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 函数让方块移动，然后调用 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 函数把移动后的位置渲染在屏幕上。我们要怎么做到这一点呢？&lt;/p&gt;
&lt;p&gt;如果你用其他语言写过游戏，你或许会想到使用 &lt;code class=&quot;language-text&quot;&gt;while&lt;/code&gt; 循环：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然而，JavaScript 是单线程的，这意味着如果你这么写，那么浏览器在这个页面里就做不了其他任何事了。几秒钟后浏览器会卡住，然后告诉用户出错了，问是否要终止程序。你肯定不想你的游戏只能跑几秒钟，所以这么搞肯定不行。我们需要一种方法，让游戏循环把控制权移交给浏览器，直到浏览器准备好再次执行我们的工作。&lt;/p&gt;
&lt;p&gt;如果你熟悉 JavaScript，你也许会想到 &lt;code class=&quot;language-text&quot;&gt;setTimeout()&lt;/code&gt; 或是 &lt;code class=&quot;language-text&quot;&gt;setInterval()&lt;/code&gt;。这两个方法允许你在指定时间之后继续执行代码。这看上去行得通，不过在浏览器中我们有更好的做法：&lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame()&lt;/code&gt;。这是个较新的函数但已经得到了良好的浏览器支持（在本文写作时的 2015 年，除 IE9 及以下的浏览器都支持它）。你向这个函数传递一个回调，它会在浏览器下次准备执行渲染时执行这个回调。在一台 60Hz 显示器上，一个优化良好的应用每秒可以更新画面（绘制帧）60 次。所以，为了达到最佳的 60 帧帧率，你的主循环有 1 / 60 = 16.667 毫秒的时间做完一次循环的工作。在后文中我们会对 node.js/io.js 和低版本浏览器做兼容。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;记住大多数显示器每秒不能展示大于 60 帧（FPS）。人类是否能够区分出高分辨率的区别要取决于应用类型，不过可以作为参考的是，电影一般是 24FPS，其他视频 30FPS，大多数游戏 30FPS 以上都可以接受，虚拟现实也许需要 75FPS 才能感觉自然。有些游戏显示器最高能到 144FPS。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;好了，让我们用 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame()&lt;/code&gt; 来实现主循环！&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;token comment&quot;&gt;// 入口点&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;跑起来了！&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/NyLKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;p&gt;注意 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法是在 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法之后调用的，这是因为我们希望能尽可能渲染出应用最新的状态。（注：有些基于 canvas 的应用需要在首帧，即任何更新都没有发生之前，渲染出应用的的初始状态。我们会在后文中探讨一种实现方式。）网上有些文章猜测在 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 的回调中先渲染再做逻辑会使屏幕绘制更快，但实际上并非如此。即使是，那也只是在绘制当前帧更快和下一帧更快之间做一个权衡。当 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 下一次调用时就无所谓了，毕竟一次只能更新一帧，但我觉得这样在逻辑上是更顺畅的。&lt;/p&gt;
&lt;h2&gt;计时问题&lt;/h2&gt;
&lt;p&gt;目前为止，我们的 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法有个问题，便是它依赖于帧率。换句话说，如果你的游戏跑的慢（即每秒内能够执行的帧数较少），那么方块移动的也越慢；而如果你的游戏跑的快（每秒内能够执行的帧数较多），那么方块移动的也越快。我们不希望出现如此不可预测的行为，尤其是在多人游戏中。没人会希望他们的游戏角色行动迟缓，只因他们电脑的配置没那么好。即使是在单机游戏中，游戏速度也会显著影响难度。在考验反应的游戏里，游戏速度越低就会更简单，而速度越高就会难，甚至没法玩下去。&lt;/p&gt;
&lt;p&gt;针对这个问题，我们来加入一个控制 FPS 的能力。我们可以利用 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame()&lt;/code&gt; 函数的能力，为回调提供一个时间戳。每次循环执行时，我们确认下是否达到了一段最小时间。如果是，我们就渲染这一帧，如果不是，我们就跳过这次循环，等待下一帧。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 上一轮循环运行的时间&lt;/span&gt;
    maxFPS &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 我们想要限制的最大 FPS&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 控制帧率   &lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestamp &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; maxFPS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;你可以看到现在它的移动如此之慢：&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/3yLKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;p&gt;我们可以做的更好。这个问题在于我们的应用并不和现实时间挂钩，该怎么去修正呢？&lt;/p&gt;
&lt;p&gt;首先让我们尝试用速度乘以两帧之间的时间差（&lt;em&gt;delta&lt;/em&gt;）。我们把 &lt;code class=&quot;language-text&quot;&gt;boxPos += boxVelocity&lt;/code&gt; 替换成 &lt;code class=&quot;language-text&quot;&gt;boxPos += boxVelocity * delta&lt;/code&gt;。修改 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 方法，从主循环中接收 &lt;em&gt;delta&lt;/em&gt; 这个参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 调整速度，使它不与 FPS 挂钩&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; boxVelocity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.08&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    delta &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 增加 delta 参数&lt;/span&gt;
    boxPos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; boxVelocity &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; delta&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 速度现在与时间相关&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
 
    delta &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; lastFrameTimeMs&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 获取当前时间与上一帧的时间差 delta&lt;/span&gt;
    lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;delta&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 传入 delta 参数&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;结果相当不错！现在我们的方块看上去不受帧率影响，随时间移动恒定的距离。&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/VyLKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;p&gt;如果它的表现与你预期不符……好吧，接着看。&lt;/p&gt;
&lt;h2&gt;物理问题&lt;/h2&gt;
&lt;p&gt;尝试把速度值上调，例如 0.8 。你会注意到有几秒种这个方块运动得很不平稳，也许会从可视范围里跑出去。这是不应该出现的。是哪里有问题呢？&lt;/p&gt;
&lt;p&gt;问题在于，之前方块每帧运动相同的距离，而现在我们加入了 delta 以后，每帧运动的距离都有所不同，而这些距离有时会相当大。在游戏中，这一现象可能会让玩家穿墙，或是阻碍他们跳过障碍物。&lt;/p&gt;
&lt;p&gt;另一个问题是，因为方块每帧移动的距离不同，在计算过程中一些小的四舍五入的误差，会随着时间推移而累积，造成方块位置的漂移。没有两个人可以玩到相同的游戏，因为他们的帧率不同，造成的误差也不同。这听起来挺微不足道的，但是实践中，哪怕是在正常帧率下，也只要几秒钟就能让误差变得可被玩家感知。这不仅对玩家不好，也对测试不好，因为我们希望给定相同的输入时，程序也能给出相同的输出。换句话说，我们希望程序是具有&lt;em&gt;确定性&lt;/em&gt; 的。&lt;/p&gt;
&lt;h2&gt;一种解决方案&lt;/h2&gt;
&lt;p&gt;解决这一物理问题的关键点在于我们想要两全其美：既要在每次执行 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 方法时模拟相等的游戏时间，又要模拟两帧之间并不每次都相等的现实时间。事实证明我们可以做到，只需在两帧之间以固定大小的 delta 值多次运行 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 方法，直到我们模拟完整段现实时间。让我们稍稍调整下主循环：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 每次调用 update 时只模拟 1000 ms / 60 FPS = 16.667 ms 的时间&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; timestep &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// 计算我们累积下来的还没有被模拟过的时间&lt;/span&gt;
    delta &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; timestamp &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; lastFrameTimeMs&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 注意这里是 += &lt;/span&gt;
    lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// 以固定大小的步长模拟整段 delta 时间&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;delta &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; timestep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        delta &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; timestep&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们把两帧之间的现实时间分隔成了小段，多次传递给 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法。&lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法本身无需修改，只要改变传递给它的参数，这样每次 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 时都会模拟相等的游戏时间。&lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法会在一帧之内调用多次以模拟完这一帧距离上一帧经过的真实时间。（如果这一帧距离上一帧经过的时间比单次 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 模拟的时间还要小，我们在这一帧就不调用 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法了。如果有剩余未被模拟的时间，我们就把它累积起来放到下一帧去模拟。这就是我们需要通过 &lt;code class=&quot;language-text&quot;&gt;+=&lt;/code&gt; 计算 &lt;code class=&quot;language-text&quot;&gt;delta&lt;/code&gt;，而不是直接赋值给它的原因，因为我们需要记录上一帧剩余下来没被模拟的时间。）这种方式避免了四舍五入不一致导致的误差错误，也保证了两帧之间不会出现大到能穿墙的巨大跨越。&lt;/p&gt;
&lt;p&gt;让我们实际看一看：&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/NEIKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;p&gt;如果你调整 &lt;code class=&quot;language-text&quot;&gt;boxVelocity&lt;/code&gt; 的值，你会看到方块会正确地呆在它应该在的地方。不错！&lt;/p&gt;
&lt;p&gt;注意： timestep 值的选择并不是任意的。分母有效地限制了用户能够感知的每秒帧数（除非绘制是插值的，如下所述）。当实际 FPS 低于最大值时，降低 timestep 会增加可感知到的最大 FPS，但代价是每一帧执行 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 的次数会更多。由于执行 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 越多，消耗的时间也越多，这就又会降低帧率。如果帧率降的太多，就可能会陷入一种死亡螺旋。&lt;/p&gt;
&lt;h2&gt;死亡螺旋&lt;/h2&gt;
&lt;p&gt;遗憾的是我们又引入了一个新问题。在我们的初次尝试中，如果一帧花费了比较长的时间执行更新和渲染，帧率就会自然地降低，直到每一帧花费的时间足够更新和渲染完成。然而，现在我们的更新依赖于时间。如果某一帧花费了较长时间来模拟，那么下一帧会需要模拟更长的时间。这意味着我们需要更多次执行 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法，而这进一步意味着这新的一帧需要花费更多的时间来模拟，如此往复……直到整个应用无法响应然后挂掉。这就是死亡螺旋。&lt;/p&gt;
&lt;p&gt;一般来说，只要我们把 timestep 的值设的足够高，每次执行 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 的开销都比它模拟的时间要短，这样就不会有问题。但执行开销在不同的硬件和负载上都是不一样的。而且我们讨论的是 JavaScript 环境，意味着我们对执行环境只有很微小的控制权。如果用户切换到另一标签页，浏览器就会停止当前标签页的渲染，当用户再切回来时，我们就累积了很长一段时间要去做模拟。如果这消耗了太多时间，浏览器就会挂起。&lt;/p&gt;
&lt;h3&gt;合理性检查&lt;/h3&gt;
&lt;p&gt;我们需要一个逃生通道。让我们在 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 的循环中加入一个合理性检查：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; numUpdateSteps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;delta &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; timestep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        delta &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; timestep&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// Sanity check&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;numUpdateSteps &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;240&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 出现了异常情况，需要做修复&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// 跳出循环&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在我们的 panic 方法中要做些什么呢？这得看情况。&lt;/p&gt;
&lt;p&gt;回合制多人游戏用了一种叫“锁步”的网络技术，它可以保证所有的玩家以相同步调进行游戏。这意味着所有玩家体验到的都是最慢的那个人的速度。如果一个玩家实在落后太多，他就会掉线，这样就不会拖慢其他玩家。因此，在锁步的游戏中，这个玩家就掉线了。&lt;/p&gt;
&lt;p&gt;在一个没有使用锁步的多人游戏，比如第一人称射击游戏中，一般都会有一个服务器维持着游戏的“权威状态”。也就是说，服务器会接收所有玩家的输入，并计算出游戏世界应有的样子，以避免玩家作弊。如果一个玩家的本地游戏距离权威状态太远，即 panic 的状态，那么这个玩家需要被拉回权威状态。（在实践中，如果直接把玩家拉回去会令人很迷惑，所以一般会有一个替代的 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 方法，让客户端能够更加平滑地回到服务端的权威状态。）一旦我们把用户拉回了最新的状态，我们就不需要再去本地模拟这一堆剩下的时间了，因为我们已经把这些时间高效快进掉了。因此我们可以把它们丢弃掉：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    delta &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 丢弃未模拟的时间&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ... 把玩家同步到权威状态&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果在服务端这么干，会引起不确定性的行为，不过只有服务端需要保证游戏运行的确定性，所以在多人游戏的客户端这么做是完全可以的。&lt;/p&gt;
&lt;p&gt;在单机游戏中，我们可以让游戏继续运行一会看看游戏运行速度能不能赶上来。但当游戏在中间状态过渡时，游戏会看上去在几帧之内运行得飞快。另一种可以接受的方法是，直接丢弃未模拟的时间，就像我们前面在非锁步的多人游戏中做的那样。这会引入不确定性的行为，不过你可能觉得这是个极端情况，可以另当别论。&lt;/p&gt;
&lt;p&gt;无论如何，如果游戏持续出现 panic 的情况，而且也不是因为标签页在后台引起的，这可能提示了游戏的主循环运行得实在太慢了。也许你需要增大 timestep 的值。&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/UvLKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;h3&gt;FPS 控制&lt;/h3&gt;
&lt;p&gt;另一种可以避免死亡螺旋（总的来说，避免低帧率）的方法是监控游戏的运行帧率，并在帧率过低时，调整主循环中的行为。往往在 panic 状态发生前，我们就能检测到掉帧的情况，可以由此来预防 panic 。&lt;/p&gt;
&lt;p&gt;有许多监测帧率的方式，其一是在一段时间内（比如最近 10 秒）持续监测每秒渲染的帧数，并取平均值。然而这稍微有点吃性能，而且我们希望最近几秒钟的帧数能获得更高的权重。一种简单做法是，使用&lt;em&gt;加权平均&lt;/em&gt;来计算权重：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; fps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    framesThisSecond &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    lastFpsUpdate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
 
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestamp &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; lastFpsUpdate &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 每秒更新一次&lt;/span&gt;
        fps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.25&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; framesThisSecond &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; fps&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 计算新 FPS&lt;/span&gt;
 
        lastFpsUpdate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        framesThisSecond &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    framesThisSecond&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里的 &lt;code class=&quot;language-text&quot;&gt;0.25&lt;/code&gt; 是衰减系数 - 这本质上体现了最近几秒钟的权重有多大。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fps&lt;/code&gt; 变量保存了我们估算出来的 FPS。我们该拿它做什么用呢？首先可以想到的是把它显示出来：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 假设我们在 HTML 中增加了 &amp;lt;div id=&quot;fpsDisplay&quot;&gt;&amp;lt;/div&gt; 这个元素&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; fpsDisplay &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fpsDisplay&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    box&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;style&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;left &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; boxPos &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;px&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    fpsDisplay&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;textContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fps&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos; FPS&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 展示 FPS&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;成功了：&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/VEIKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;p&gt;我们可以把 FPS 派上更多的用场。如果 FPS 太低了，我们可以退出游戏，降低画质，停止或减少主循环之外的行为，例如事件处理器、音频播放；降低非关键更新的频率，或增加 timestep。（注意这是最不得已的情况，因为这会导致每次 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 调用模拟更多的时间，进而使程序有更多的不确定性，因此应谨慎使用。）如果 FPS 回升了，就恢复这些行为。&lt;/p&gt;
&lt;h3&gt;开始与结束&lt;/h3&gt;
&lt;p&gt;在主循环开始和结束时分别调用一个回调方法（让我们叫它们 &lt;code class=&quot;language-text&quot;&gt;begin()&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;end()&lt;/code&gt; 方法）来做初始化和清理工作是很有用的。一般来说，&lt;code class=&quot;language-text&quot;&gt;begin()&lt;/code&gt; 可以用于在 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 执行前处理输入（例如当玩家按下开火键时刷出子弹）。如果需要对用户输入执行长时间运行的操作，那么在主循环中分块处理这些操作，而不是在事件处理程序中一次处理这些操作，可以避免帧的延迟。而 &lt;code class=&quot;language-text&quot;&gt;end()&lt;/code&gt; 方法则可以增量地执行不受时间影响的、需要较长运行时间的更新，以及根据 FPS 的变化作调整。&lt;/p&gt;
&lt;h3&gt;选择 timestep&lt;/h3&gt;
&lt;p&gt;一般来说，1000/60 在大多数情况是个好选择，因为大多数显示器以 60Hz 运行，如果你发现你的程序十分吃性能，也许你可以将其设为 1000/30。这有效地限制了你的可感知帧率为 30FPS（除非使用了插值，如后文所述）。注意帧率会根据你的显示器和显卡驱动进行调节，因此你设置的最大值可能与实际运行时测得的值不相同。如果你的游戏运行流畅，且你希望模拟得更加精确，你可以考虑使用高端游戏显示屏的 FPS，如 75、90、120 和 144。再高的话最终运行速度可能反而就会变慢了。&lt;/p&gt;
&lt;h2&gt;性能考量&lt;/h2&gt;
&lt;p&gt;如果程序的性能并不尽如人意，你可以使用插值绘制和 Web Worker 这两种重构方式来获得实实在在的性能提升。&lt;/p&gt;
&lt;h3&gt;插值绘制&lt;/h3&gt;
&lt;p&gt;在每次 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 结束之后，在 &lt;code class=&quot;language-text&quot;&gt;delta&lt;/code&gt; 中经常会有一段小于一整个 timestep 的剩余时间。将这段尚未被模拟的剩余时间所占 timestep 的百分比传入 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法就可以在两帧之间做一个插值。即使在高帧率下，这种视觉上的平滑效果也有助于降低画面的卡顿。&lt;/p&gt;
&lt;p&gt;卡顿之所以会出现，是因为 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法模拟的时间与两个 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法经过的时间往往是不同的。进一步说，假如 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 发生在下面第一行的每条竖线所代表的时间点，而 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 发生在下面第二行的每条竖线所代表的时间点，那么在 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法发生渲染的时间点，总会有一些剩余时间还没有被 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法所模拟：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;update() timesteps:  |  |  |  |  |  |  |  |  |
draw() calls:        |   |   |   |   |   |   |&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;为了使 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 对方块移动做插值以进行渲染，必须保留上次 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 之后对象的状态，并将其用于计算中间状态。注意这意味着渲染最多落后一次 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 。这仍然比外推（推测对象在下一次 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 之后的状态）要好，因为后者可能会产生奇怪的结果。要注意存储多个状态实现起来比较困难，而且这个过程也是耗时操作，可能会导致帧率下降。因此除非你观察到了卡顿现象，否则这么做很可能是不值得的。&lt;/p&gt;
&lt;p&gt;我们可以这样对我们的方块进行插值：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; boxLastPos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    boxLastPos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; boxPos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 保存上一次 update 时方块的位置&lt;/span&gt;
    boxPos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; boxVelocity &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; delta&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;interp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    box&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;style&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;left &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;boxLastPos &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;boxPos &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; boxLastPos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; interp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;px&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 进行插值&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainLoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;delta &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; timestep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 传入插值的百分比&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;把所有的代码放在一起：&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/UEIKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;h3&gt;使用 Web Worker 来更新&lt;/h3&gt;
&lt;p&gt;与主循环中的任何事物一样，&lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法的执行时间直接影响了帧率。如果 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法花费的时间足够长，以至于帧率低于预期，那么我们可以将 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 方法中无需在每帧之间执行的部分放入 Web Worker 中。（网上的很多地方有时会建议使用 &lt;code class=&quot;language-text&quot;&gt;setTimeout()&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;setInterval()&lt;/code&gt; 来进行调度。这些方法只需对现有的代码进行较小的改动，但由于 JavaScript 是单线程的，这些改动仍然会阻止渲染并降低帧率。使用 Web Worker 需要做更大的改动，但它们在单独的线程中执行，故可以为主循环释放出更多时间。）&lt;/p&gt;
&lt;p&gt;这里列举了部分在使用 Web Worker 时需考虑的内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在迁移到 Web Worker 前分析你的代码。也许渲染过程才是瓶颈，此时你首先应当考虑的是降低场景的视觉复杂度。&lt;/li&gt;
&lt;li&gt;将 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 中的所有内容都迁移到 Web Worker 中是不可取的，除非你的 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法能够像我们之前讨论的那样进行插值。最容易移出 &lt;code class=&quot;language-text&quot;&gt;update()&lt;/code&gt; 的是后台更新（比如在城镇建造游戏中计算市民的幸福指数）、不影响场景的物理效果（比如风中飘动的旗帜）和任何被遮挡或是离场景很远的事物。&lt;/li&gt;
&lt;li&gt;如果 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法需要基于 Web Worker 中的行为对物理做插值，那么 Web Worker 需要把插值结果传回主线程，使其在 &lt;code class=&quot;language-text&quot;&gt;draw()&lt;/code&gt; 方法中可用。&lt;/li&gt;
&lt;li&gt;Web Worker 不能访问主线程中的状态，因此它们不能直接修改你场景中的物体。与 Web Worker 之间传递数据是一个痛点。最简单的办法是使用 Transferable Objects：你可以传递一个 ArrayBuffer 给 Web Worker，并销毁原始引用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;你可以在 &lt;a href=&quot;https://www.html5rocks.com/en/tutorials/workers/basics/&quot;&gt;HTML5 Rocks&lt;/a&gt; 中了解更多有关于 Web Worker 和 Transferable Objects 的信息。&lt;/p&gt;
&lt;h2&gt;启动与停止&lt;/h2&gt;
&lt;p&gt;目前，一旦我们的游戏启动了主循环，我们是没有任何方法停止的。让我们引入 &lt;code class=&quot;language-text&quot;&gt;start()&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;stop()&lt;/code&gt; 函数来管理游戏的运行。首先我们要找到停止 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 的方法。一种方式是维持一个 &lt;code class=&quot;language-text&quot;&gt;running&lt;/code&gt; 的布尔变量来控制主循环下一次是否要继续调用 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt;。一般来说没啥问题，不过如果游戏开始后立马停止，那么无论如何都有一帧会被运行，无法取消。因此我们需要一个能够真正取消渲染循环的方法。幸运的是我们有 &lt;code class=&quot;language-text&quot;&gt;cancelAnimationFrame()&lt;/code&gt; 方法。当调用 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 时会返回一个 frame ID，可以传递给&lt;code class=&quot;language-text&quot;&gt;cancelAnimationFrame()&lt;/code&gt; 方法。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;frameID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;切记如果你做了 FPS 控制，别忘了在 FPS 控制的节流条件中也做下改动，记录 frame ID。&lt;/p&gt;
&lt;p&gt;现在我们来实现 &lt;code class=&quot;language-text&quot;&gt;stop()&lt;/code&gt; 方法：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; running &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    started &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;stop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    running &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    started &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;cancelAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;frameID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;此外，当主循环暂停时，也要暂停事件处理和其他的后台任务（比如通过 &lt;code class=&quot;language-text&quot;&gt;setInterval()&lt;/code&gt; 执行的任务或是 Web Worker 中的任务）。这通常不难，因为它们只要检查下 &lt;code class=&quot;language-text&quot;&gt;running&lt;/code&gt; 变量就可以决定自身是否要执行了。另一个需要注意的点是，在多人游戏中暂停会导致该玩家的客户端失去同步，因此一般要让他们退出游戏，或是在主循环再次启动时把玩家拉到最新的位置（在确认玩家是否真的想要暂停之后）。&lt;/p&gt;
&lt;p&gt;开始游戏循环会更为棘手一些。我们需要关注以下四点。首先，如果主循环已经在运行，我们不能允许它再次运行，否则会导致同时请求多帧渲染，降低运行速度。其次，我们需要确保快速地切换游戏的开始和停止不会造成错误。再次，我们需要在游戏尚未发生任何更新时渲染出游戏的初始状态，因为我们主循环的 &lt;code class=&quot;language-text&quot;&gt;draw&lt;/code&gt; 是在 &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; 之后调用的。最后，当游戏暂停时，我们需要重置一些变量的值，以防暂停时我们记录的需要模拟的时间仍然在流逝。另外，在游戏重新启动后，事件处理和后台任务也要恢复运行。这是我们的代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;started&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 防止多次启动&lt;/span&gt;
        started &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// 第一帧来获取时间戳，并绘制初始画面.&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// 记录 frame ID 用于停止&lt;/span&gt;
        frameID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 首次渲染&lt;/span&gt;
            running &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// 重置一些记录时间相关的变量&lt;/span&gt;
            lastFrameTimeMs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            lastFpsUpdate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            framesThisSecond &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// 真正启动主循环&lt;/span&gt;
            frameID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;requestAnimationFrame&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainLoop&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;效果：&lt;/p&gt;
&lt;iframe width=&quot;100%&quot; height=&quot;300&quot; src=&quot;//jsrun.net/JEIKp/embedded/all/light&quot; allowfullscreen=&quot;allowfullscreen&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
&lt;h2&gt;Node.js/IO.js 与 IE9 支持&lt;/h2&gt;
&lt;p&gt;现在我们代码的主要问题，是 &lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame()&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;cancelAnimationFrame()&lt;/code&gt; 缺乏对 node.js/IO.js 环境，和 IE9 以及更早的浏览器的兼容（如果你还关心那些浏览器的话）。我们可以利用 timer 做一个 polyfill：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 代码来自于 MIT 协议的 https://github.com/underscorediscovery/realtime-multiplayer-in-html5&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; requestAnimationFrame &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; requestAnimationFrame &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; requestAnimationFrame &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; lastTimestamp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            now&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            timeout&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            now &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; timestep &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; lastTimestamp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            lastTimestamp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; now &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; timeout&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token function&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; timeout&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; timeout&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 
    cancelAnimationFrame &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; cancelAnimationFrame &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; cancelAnimationFrame &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; clearTimeout&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们使用了 &lt;code class=&quot;language-text&quot;&gt;Date.now()&lt;/code&gt; 以减少兼容性问题，但这在 IE8 中是不支持的。如果你真的需要支持 IE8，可以使用 &lt;code class=&quot;language-text&quot;&gt;+new Date()&lt;/code&gt; 代替，但这会产生一堆临时对象，增加垃圾回收的负载，进而导致你的游戏卡顿。此外 IE8 本身也很慢，很难支持有较多 JavaScript 逻辑的应用运行。&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;我们需要考虑的东西很多。如果你想简单地实现游戏循环，只要用我的 &lt;a href=&quot;https://github.com/IceCreamYou/MainLoop.js&quot;&gt;MainLoop.js&lt;/a&gt; 开源库就可以了。这样你就不用担心上面这么多的问题。&lt;/p&gt;
&lt;p&gt;如果你自己动手，那么还可以做一些通用性的代码优化。例如，可以把小方块封装在自己单独的类中。整个脚本应该被包裹在一个 &lt;a href=&quot;https://en.wikipedia.org/wiki/Immediately_invoked_function_expression&quot;&gt;IIFE（立即执行函数）&lt;/a&gt; 中，仅暴露接口给外部，以防止污染浏览器的全局命名空间，或是把代码打包成 CommonJS 或 AMD 的模块。MainLoop.js 已经把这些都做好了（甚至做得更好），不过总而言之我们已经做得相当不错了。&lt;/p&gt;
&lt;p&gt;最后，我要感谢 Glenn Fiedler 编写了经典的 &lt;a href=&quot;http://gafferongames.com/game-physics/fix-your-timestep/&quot;&gt;Fix your timestep!&lt;/a&gt; 一文，它是本文中如此多工作的起点。也感谢 &lt;a href=&quot;https://github.com/statico&quot;&gt;Ian Langworth&lt;/a&gt; 为我审阅了我在&lt;a href=&quot;https://www.packtpub.com/game-development-with-three-js/book&quot;&gt;关于制作 3D 页游的书&lt;/a&gt;中包含的本文的简略版本，并提出了 Web Worker 相关的一些建议。最后的最后，如果你仍然想寻找关于这个话题的更多资源，也许可以考虑看下 &lt;a href=&quot;http://gameprogrammingpatterns.com/game-loop.html&quot;&gt;Game Programming Patterns&lt;/a&gt; 这本书，或者 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Games/Anatomy&quot;&gt;MDN&lt;/a&gt; 上一篇相对简略的文章。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CoC 7th 模组 - 天使百分百]]></title><description><![CDATA[模组简介 CoC 7th ，现代，推荐 2~…]]></description><link>https://maliut.space/p/100-percent-angel/</link><guid isPermaLink="false">https://maliut.space/p/100-percent-angel/</guid><pubDate>Sun, 16 Feb 2020 22:57:00 GMT</pubDate><content:encoded>&lt;h2&gt;模组简介&lt;/h2&gt;
&lt;p&gt;CoC 7th ，现代，推荐 2~3 人。调查员身份可以是学生、校友等，能与学校扯上关系即可。无战斗。推荐图书馆、机械维修等技能。也许智力、教育也高一点会比较好？&lt;/p&gt;
&lt;p&gt;因为本身是一个偏玩梗的团，所以适合的玩家比较局限，以效实中学学生为佳，如果经历过百年校庆，尤其是看过那部微电影，就再好不过了。别的人玩可能会比较懵逼吧。&lt;/p&gt;
&lt;h2&gt;模组导入&lt;/h2&gt;
&lt;p&gt;2012年，效实中学即将迎来百年校庆。在校庆之际，效实园里却流传起了一个神秘的言论 ——「只要考到100分，你就能见到天使」。为了揭开这个传言背后的真相，调查员们决定来到效实中学开始调查……  &lt;/p&gt;
&lt;h2&gt;模组下载&lt;/h2&gt;
&lt;p&gt;由于还没跑过，还需要完善，暂不开放。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[明日方舟作业帮]]></title><description><![CDATA[顾名思义，即方便明日方舟玩家抄作业的工具，点此进入。不过很遗憾，目前已经停止维护。 开这个坑的背景是：随着游戏干员数量变多以及能力的差异化， 未来抄作业将越来越难，因此希望提供一个工具，能根据自己现有的 Box…]]></description><link>https://maliut.space/p/arknights/</link><guid isPermaLink="false">https://maliut.space/p/arknights/</guid><pubDate>Sun, 16 Feb 2020 22:35:00 GMT</pubDate><content:encoded>&lt;p&gt;顾名思义，即方便明日方舟玩家抄作业的工具，&lt;a href=&quot;https://maliut.space/arknights/&quot;&gt;点此进入&lt;/a&gt;。不过很遗憾，目前已经停止维护。&lt;/p&gt;
&lt;p&gt;开这个坑的背景是：随着游戏干员数量变多以及能力的差异化， 未来抄作业将越来越难，因此希望提供一个工具，能根据自己现有的 Box 快速筛选适合自己的作业。&lt;/p&gt;
&lt;p&gt;这个工具分为两个部分，对于用户端，工具提供了一个可以选择关卡和干员的界面。只要玩家选择自己想上的干员和自己没有的干员，便可以一键筛选出符合要求的作业。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.ax1x.com/2020/02/16/39NaJs.jpg&quot; alt=&quot;用户端&quot;&gt;&lt;/p&gt;
&lt;p&gt;而这些作业是怎么录入进去的呢？由于本人并没有这么强的水平从 B 站直接爬所有的作业，然后提取出里面的干员，因此不得不采用人工录入的方式。在此也感谢 &lt;a href=&quot;https://github.com/FinZhang&quot;&gt;@Fin&lt;/a&gt; &lt;a href=&quot;https://github.com/Xraigor&quot;&gt;@Xraigor&lt;/a&gt; 两位帮我录入。同时 &lt;a href=&quot;https://github.com/FinZhang&quot;&gt;@Fin&lt;/a&gt; 同学也是这个项目本身创意的提出者，且为后续优化提供了不少宝贵建议。为了简化录入，我开发了一个 Chrome 插件，可以自动提取当前作业的一些基本信息，且方便录入者在同一个页面完成输入和提交工作，无需频繁切换页面。&lt;/p&gt;
&lt;p&gt;对于干员的录入，一开始我并没有什么好办法，如果要截取视频画面并完成图片分类，我没有这些技能不说，即使有，那也是十分费时费力的工作。不过后来灵光一闪，干员选取的界面里，有每个干员的名字，而 OCR 已经是一项成熟的能力了，最关键的是，QQ 截图里就有现成的功能。这样只需一次截图框选，就可以把干员的名字都提取出来了。然后再对一些常见的识别错误稍加处理，OCR 的准确程度几乎能有 99%。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.ax1x.com/2020/02/16/39NUij.jpg&quot; alt=&quot;录入端&quot;&gt;&lt;/p&gt;
&lt;p&gt;在技术上面，由于这个工具也是纯前端网页，因此保存作业数据、查询的功能就放在了 LeanCloud 上面（结果发现复杂查询的时候有 bug，不过影响不大，暂时不提）。另外值得一提的是，以前因为不会设计，也懒得为小项目去引入一些大规模的框架，因此做出来的工具都是毫无样式的纯 HTML 页面。而这次则尝试使用了从现在的眼光来看已经完全过时了的 Bootstrap 。虽然大一在学校做项目时接触过一次，但那时并没有懂它怎么玩的，而现在用起来才发现真香。虽然已经是个过时东西，但是对我这种小规模追求快速开发的小工具再合适不过了，只需引入几个 CSS JS 完事。最终的效果不仅美观，也天然拥有了适应移动端的能力。&lt;/p&gt;
&lt;p&gt;话说回来，最后这个项目还是弃坑了，原因是虽然我已经最大程度简化了作业录入的流程，但需要人工录入作业终究是一个绕不过去的坎。另一方面，明日方舟目前的难度和多样性，也远没有达到需要为每个人个性化定制作业的程度。这种情况下，花费大量时间去做作业录入终究还是显得吃力不讨好。&lt;/p&gt;
&lt;p&gt;不过也许是因为我在 Github 上写了明日方舟被人搜索到了吧，我的站长统计显示这个站还是有过自然流量的，这不禁令我感到一丝欣慰。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[SimPow - 简洁强大的 Hexo 博客主题]]></title><description><![CDATA[没错，就是你现在正在浏览的这个网站的主题。 在经历了从各种 XX 空间到自建 WordPress 再到静态博客，尝试了各种主题之后，终于也不可避免地走到了看各种主题皆丑陋，不得不自己写一个独一无二的主题的程度了。 这个主题具体什么时候开始使用的已不可考，虽说有 Git…]]></description><link>https://maliut.space/p/hexo-theme-simpow/</link><guid isPermaLink="false">https://maliut.space/p/hexo-theme-simpow/</guid><pubDate>Sun, 16 Feb 2020 21:41:00 GMT</pubDate><content:encoded>&lt;p&gt;没错，就是你现在正在浏览的这个网站的主题。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;在经历了从各种 XX 空间到自建 WordPress 再到静态博客，尝试了各种主题之后，终于也不可避免地走到了看各种主题皆丑陋，不得不自己写一个独一无二的主题的程度了。&lt;/p&gt;
&lt;p&gt;这个主题具体什么时候开始使用的已不可考，虽说有 Git 的提交记录，但也不完全准确。当然，目前的功能也还在完善当中。&lt;/p&gt;
&lt;p&gt;让我直接说重点，即这个主题的最主要的设计诉求。首先我对主题的偏好是简洁，拒绝了所有多栏的布局，力图保留最纯粹的阅读体验。而由于自己在浏览博客时，主要的场景是在 PC 端，主流屏幕分辨率 16：9 较宽，但博客的文本一般则是竖向细长型的，此为一个不和谐因素。而很多主题（包括我之前使用的）会使用一个框把文本的内容左右框起来，这看上去就更凸显了这一不和谐因素，而显得博客小家子气。因此我的主题希望打破文章与容器的边界，体现一种浑然一体的感觉。&lt;/p&gt;
&lt;p&gt;当然，我是一个设计白痴，只能直觉地判断最终效果顺不顺眼。因此也必然借鉴了不少他人的优秀主题。在此需要感谢这些我的灵感来源们：从网上看到的大神 &lt;a href=&quot;https://orzfly.com/&quot;&gt;orzFly 的博客&lt;/a&gt;借鉴了页面布局，从以前的主题 &lt;a href=&quot;https://otakism.com/hexo-theme-typescript/&quot;&gt;Typescript&lt;/a&gt; 借鉴了字体和配色，对于朋友的朋友的博客  &lt;a href=&quot;https://doubilee.com/&quot;&gt;BUWAI LEE&lt;/a&gt; 亦有借鉴。&lt;/p&gt;
&lt;p&gt;说到这个主题的名字 SimPow ，即 Simple &amp;#x26; Powerful ，简洁且强大。简洁相信不用多说大家都能看得出来，而强大则体现在，虽然它是一个静态网页，但动态网页能干的事情它也能干。得益于现在 SaaS 的兴起，并不需要自己购买或搭建服务器，我就可以实现一些动态化的功能。这里必须提一嘴博客的评论功能，起初我是想利用 SaaS 服务自己写一个的，后来发现了一个好用的插件 &lt;a href=&quot;https://valine.js.org/&quot;&gt;Valine&lt;/a&gt; ，它的实现思路和我的一模一样，而功能已经很完善了，因此我就拿过来稍加魔改便使用了。另外就是我想做的一个想法功能，初衷是无需繁琐的发布过程，能随时随地把自己的一些有趣的小点子小句子记录下来，这也需要动态化的能力。当然，要想实现重型的比如注册登录功能也是可以的，只是我目前没这个需求罢了。&lt;/p&gt;
&lt;p&gt;总的来说现在用起来还挺满意的。最后记录几个 TODO 项吧，虽然短时间应该懒得去做：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;主界面 Logo - 没有做 Logo 的能力，比起丑的 Logo ，还是纯文字顺眼一点&lt;/li&gt;
&lt;li&gt;有人评论时，使用 Submail 等服务提示作者或被 @ 的人 - 纯粹懒得搞，毕竟并没有人来评论&lt;/li&gt;
&lt;li&gt;文章内图片下方支持小字备注&lt;/li&gt;
&lt;li&gt;“项目”分类下的文章使用图片瀑布流展示 - 之前搞过一下不过效果总归不太理想&lt;/li&gt;
&lt;li&gt;“想法”分类，即上文提到的功能&lt;/li&gt;
&lt;li&gt;支持手机版 - 有生之年&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[工科生的音乐浪漫 - Sonic Pi]]></title><description><![CDATA[说起音乐创作，大多数人立刻就会将其划入艺术的范畴。而除非有专门学过相关的才艺，对于大多数像我们这样的工科生来说，中间仿佛横亘着一条巨大的鸿沟。但今天，我想向大家介绍一款神奇的软件，它在两者之间架起了一座桥梁。 这款软件叫做 Sonic Pi…]]></description><link>https://maliut.space/p/sonic-pi/</link><guid isPermaLink="false">https://maliut.space/p/sonic-pi/</guid><pubDate>Sun, 22 Dec 2019 23:07:00 GMT</pubDate><content:encoded>&lt;p&gt;说起音乐创作，大多数人立刻就会将其划入艺术的范畴。而除非有专门学过相关的才艺，对于大多数像我们这样的工科生来说，中间仿佛横亘着一条巨大的鸿沟。但今天，我想向大家介绍一款神奇的软件，它在两者之间架起了一座桥梁。&lt;/p&gt;
&lt;p&gt;这款软件叫做 Sonic Pi ，来自剑桥大学计算机实验室，目前支持 Windows、Mac、树莓派三个平台。它也是一款开源软件，在 Github 上获得了 5k+ stars 。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;从功能上来说，它可以被视为一个简单的 DAW（Digital Audio Workstation ，数字音频工作站），类似 Cubase 和 FL Studio 等的下位替代。但它的特点在于，使用编写代码而不是输入音符的方式来完成乐曲的制作（←但用到的代码很简单）。它的设计旨在于简单、强大和富有乐趣间取得平衡，而它也的确做到了。一方面，它被用于校园之中， 在创造乐曲的过程中教授学生以编程思维；另一方面，它强大的实时编码作曲能力，也被不少专业的艺术家和 DJ 作现场表演和音乐可视化等用途。&lt;/p&gt;
&lt;p&gt;我花了点时间用 Sonic Pi 简单复刻了一首我非常喜欢的 BGM —— 来自《塞尔达传说 旷野之息》的 Kass&apos; Theme，但加入了些电音的风格。不如让我们在音乐声中，探索一下 Sonic Pi 的独特之处吧。&lt;/p&gt;
&lt;audio src=&quot;/54f35cf360f66012e580707d99ff9d4d/kasstheme.mp3&quot; controls=&quot;controls&quot;&gt;
你的浏览器不支持播放音乐
&lt;/audio&gt;
&lt;h2&gt;简单易上手的程序设计&lt;/h2&gt;
&lt;p&gt;阻碍大众进入音乐世界的第一道坎就是识谱了，各种五花八门的符号往往令人望而却步。不少人或许会觉得自己与音乐缘尽于此，但其实不然，作为艺术的音乐却与理工科有着不可分割的联系。让我们回想起曾经学过的知识。声音的本质是机械波。音乐的三要素中，响度对应波的振幅，音调对应波的频率，音色虽复杂些，但也逃不过是波形和频率的组合。而一首乐曲，无非是一系列声音在时间维度上的排列罢了。而五线谱，就是描述这一种排列的 DSL(Domain Specific Language, 领域特定语言)。能被沿用至今，它形象直观、信息密度大，一定程度上代表了业界的最佳实践。&lt;/p&gt;
&lt;p&gt;但这东西毕竟还有不小的学习成本，而且在如今的信息时代，五线谱的图形化特征却也带来数字化表示与传播上的不便。那该怎么办呢？改用代码实现便再自然不过了。我们早已熟悉使用代码对全世界建模，区区一个音乐当然更是不在话下。随时间流淌的音符，是顺序结构；有时会有整段的重复，那就加个循环；重复中又会带点变化，一个 if-else 了事。Sonic Pi 使用 Ruby 作为它的宿主语言，利用它灵活、可读性强的优势，封装了一整套用于音乐制作的 API，即使对代码知之甚少的用户也能很快理解它的含义。而对熟悉代码的用户而言，能够编写代码，就意味着强大的可扩展性、无限的可能性。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 710px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2f252303dda4385b8166d542724a069a/7131f/sonic1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.26108374384237%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDElEQVQoz6WQyU7DMBRFs6JpnDgJTRSo62dnIiiUQSpDF0hs+AU+H1RVDX9hX9wKViyg7eLIlvx8dGyPstZeU4uqq2xYNwi5RpiU+2JZvLtnvcW0x9vdlX1+bcCWHRhzB2mJ74F/8SPbrp4fKzvmCqOxtmmqkeT7yX4VnmcKL9UUl8UM8+UFutsGPjvo2Tu8yanCjZhhSVOoM0IuKzB+hLCYKDySQFvIXR21NcbREcLcCZ+UwIMUUKRRUIWAHyc09yTMYiZM35eGutq4QhMm2riP3ovtHS9zhXMhITMCdQ1EWSOIDqtjsSsMYv1xEqmVz2k9CuTGZ3JgMQ0Bp88/2M4MjNPGsXb7VZTo9y+YGfmgRmK0hwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;example&quot;
        title=&quot;example&quot;
        src=&quot;/static/2f252303dda4385b8166d542724a069a/7131f/sonic1.png&quot;
        srcset=&quot;/static/2f252303dda4385b8166d542724a069a/2efce/sonic1.png 203w,
/static/2f252303dda4385b8166d542724a069a/1d180/sonic1.png 405w,
/static/2f252303dda4385b8166d542724a069a/7131f/sonic1.png 710w&quot;
        sizes=&quot;(max-width: 710px) 100vw, 710px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;一段演奏旋律的代码，即使不懂含义，也能猜个八九不离十吧&lt;/p&gt;
&lt;br&gt;
&lt;h2&gt;以随机性激发灵感&lt;/h2&gt;
&lt;p&gt;Sonic Pi 并不只是一个冷冰冰的代码编辑器而已，相反，它为了让初学者顺利进入音乐的世界，准备了齐全的教程，事无巨细地讲解了各类音乐和代码的基础知识，以及软件使用的技巧。作者鼓励大家多做尝试，他的口头禅是 &lt;em&gt;there are no mistakes, only opportunities&lt;/em&gt; 。&lt;/p&gt;
&lt;p&gt;在教程中，我印象最深刻的是作者花了不小的篇幅讲解在音乐制作过程中随机数的应用。在学会软件的基础操作后，我们除了临摹现成的曲子，如果想要自己创作些新的旋律出来，往往会容易陷入无从下手，没有灵感的局面。这时候随机性就可以派上用场了，我们可以让计算机随机演奏，毫不费力地就可以让计算机帮我们擦出灵感的火花。Sonic Pi 也很贴心地为我们封装了好几种随机函数，免去了我们从零开始自己处理随机数的麻烦。&lt;/p&gt;
&lt;p&gt;可能有人会问，我自己随便乱弹琴，不也能达到类似的效果么？且不说你的个人习惯是不是真的能让你的弹奏那么随机（想想自己乱按键盘的时候，是不是翻来覆去也就那么几个类似的 pattern），就算是有灵感产生了，过段时间以后你还确保自己能记得当时的旋律吗？但计算机的随机数就不一样了，它是一种伪随机数，只要设定相同的随机种子，得到的随机数序列永远是一样的，再也不用担心相同的旋律无法复现的问题。你甚至可以把它分享给朋友，让他们也能听到你的灵光一闪。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/316d9d4086b1642efda7db536dd8354c/5a190/sonic2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.39901477832512%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABJNAAASTQHzl8SnAAACgklEQVQ4y51UWW/TQBD2f+XXwQNPUGirxknjNEBFq1ZqoXGSxk5tx2d8H+vjY2edmCLBCyN9mvHO7Jw7lvb7PUzTFIjjGG3bous6FEWBIAhgGIbgWZaJ8zzPxTfdI7ieJ3RRFCFNU0gk5Pyy73uwLAse52VZgihJEgGyCcMQO9uG47hCH0cxWMVQ5AVC7piCmDy4NBmNcaXMIJ/K+Dad48tkNjiSZRmKomDGMZ/PIY9GuJyM8XV+hfFYxkSZQJ5NIU+nuFTmOD27gOT7PhZPC6wNHw2rwcoKTd0IVFwmUCY9r4SeMYbcjZEtHWSqi8QMeLsSnnUCiTKh2gvWYKAO/6aDztmY+P5Jwc2JguDFHtQSNflo1LWdkLumRc2zJVCmdH5Ey3VE25WGi/cnuJtcw33UURsJOtb2Dsmoa387JCdRGAlQ8+lbBCKndR+dnW+QvzlD824JGAUaPeQOm95h0zRD9E6g+yOro06g7ltjLjRM357iZnYNO3RRo31V8n/QRtfw4fNHjOQR7N1ODJSqkOhROrYDfaNB03XsVlvkNyaMZx2apmGr6dCP4DZbneuzHAmfauD5sK0dl+ND2zpIdEldqHj68RNLVcX6YQHvVsNGXWO9WuF5xflyheWTKjh9uzyBKAiRp5nose96iKnfYQyJNoDeYsm3RTSbUv8bpfw8Ynx9+OTjEizIhyEeiYYn0aq5jiP2kg6oHBrMMNUDwAeVxikil9vFldjr4V0eRCpbMs8fcHt3j/vbHuvlWry/qqiGTem3pEbK+733AlRpIbalKnsw4tyeypdCy8fOsmG+8D+OYSHwAxGpZs2wgg2X27pFkRV8oraogmyaVzaUBK3oL30NdEuCL60ZAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;interface&quot;
        title=&quot;interface&quot;
        src=&quot;/static/316d9d4086b1642efda7db536dd8354c/5a190/sonic2.png&quot;
        srcset=&quot;/static/316d9d4086b1642efda7db536dd8354c/2efce/sonic2.png 203w,
/static/316d9d4086b1642efda7db536dd8354c/1d180/sonic2.png 405w,
/static/316d9d4086b1642efda7db536dd8354c/5a190/sonic2.png 800w&quot;
        sizes=&quot;(max-width: 800px) 100vw, 800px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;Sonic Pi 的界面，有黑白两种模式可选&lt;/p&gt;
&lt;br&gt;
&lt;h2&gt;互操作性与工作流&lt;/h2&gt;
&lt;p&gt;Sonic Pi 毕竟不是十全十美的软件，我在使用过程中也遇到一些问题，例如音源种类太少且难以加入新的音源、软件本身也不太稳定等。而且它毕竟是个小众软件，如果想要拿它认真做点东西，也要考虑到和主流软件的互操作性。换句话说，如果我们能把 Sonic Pi 的作品放入功能更加强大的软件中进行二次加工，那像音源或是功能缺失的问题都将不再是问题。&lt;/p&gt;
&lt;p&gt;那么如何做到这一点呢？容易想到利用 MIDI 这一通用的计算机音乐格式。Sonic Pi 本身支持作为 MIDI 的输入或输出设备，但一般连接的都是实体的设备。理论上来说，我们也可以将另一个软件作为 Sonic Pi 的虚拟 MIDI 输出端，但本人对这方面实在是知之甚少，做了些尝试但都不算成功，不同系统下的区别也比较大。但换个思路想， MIDI 本来就是记录音乐的一种格式而已，只要我们知道它的格式定义，就可以把文件写出来，而写 MIDI 文件的方法，想必有现成的轮子可用。果然我找到了 MidiWriterJS 这个开源库，亲测可用。至于具体的用法我就不详细介绍了，有需要的朋友可以留言私下交流。&lt;/p&gt;
&lt;br&gt;
&lt;h2&gt;替代品&lt;/h2&gt;
&lt;p&gt;使用代码编写音乐的工具并非只有 Sonic Pi 一个。正如有句名言所说：“任何可以使用 JavaScript 来编写的应用，最终都会由 JavaScript 编写。” 有一个开源库 Tone.js 也可以实现同样的目标。但相比于 Sonic Pi，它就简陋了很多。它更像是 Three.js 之于 WebGL，是对 Web Audio API 的一层简单封装。如果你事先没有对 Web Audio API 的概念有一定了解的话，将会很难上手使用，更不用说没有 GUI 与各种音源、效果了。至于优点嘛，就是无需下载客户端，以及可以更方便地与我上文提到的 MidiWriterJS 互相调用。有进阶编程经验的同学可以尝试一下。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;附本文介绍的各种工具地址：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://sonic-pi.net&quot;&gt;Sonic Pi&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/grimmdude/MidiWriterJS&quot;&gt;MidiWriterJS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/Tonejs/Tone.js&quot;&gt;Tone.js&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[BotIM - 跑团辅助平台]]></title><description><![CDATA[BotIM 是一个为网络跑团设计的平台，也适用于其他需要在即时聊天应用中使用机器人的场景。 项目使用了腾讯云 IMSDK…]]></description><link>https://maliut.space/p/botim/</link><guid isPermaLink="false">https://maliut.space/p/botim/</guid><pubDate>Sun, 08 Dec 2019 18:48:00 GMT</pubDate><content:encoded>&lt;p&gt;BotIM 是一个为网络跑团设计的平台，也适用于其他需要在即时聊天应用中使用机器人的场景。&lt;/p&gt;
&lt;p&gt;项目使用了腾讯云 IMSDK 的免费额度，客户端模拟机器人逻辑，优点是完全合法，配置简单，且完全免费，无维护成本。缺点是只适合小规模的使用。关于具体的项目背景与搭建方法，后续会在单独的文章中详细介绍。届时大家都可以搭建自己的跑团平台。&lt;/p&gt;
&lt;p&gt;跑团中的核心功能就是骰子。目前本项目的骰子集成了如下功能：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;基础的 CoC 骰子规则，并支持骰子指令的四则运算。&lt;del&gt;甚至可以拿它当计算器使用&lt;/del&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;跑团记录自动录制功能。这是因为大家都有记录跑团 log 的需求，复制聊天记录再人工处理太麻烦，而这正好是适合交给程序的事情。&lt;/p&gt;
&lt;p&gt;在录制这个功能上能玩的花样很多。由于我们是程序记录，能够记录到原始的结构化数据，而不是单纯的文本数据，因此我们可以自由选择导出的格式，可以是普通文本，也可以是 HTML + CSS 直接导入 markdown ，还可以是 JSON 格式，以便后续进一步处理。&lt;/p&gt;
&lt;p&gt;也可以对记录的内容进行预处理，例如合并连续消息，选择消息要展示的字段，还可以事先对消息进行重排序，这尤其适用于网团中大家发言顺序混乱的场合。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;感谢 @Fin 同学在使用中提出的大量宝贵建议，大家若有建议，也欢迎留言提出。&lt;/p&gt;
&lt;p&gt;未来的优化点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;考虑把控制面板的 UI 优化一下，使用现代的 UI 框架&lt;/li&gt;
&lt;li&gt;聊天界面本身完善，跑团中一些图片素材的快速查阅等&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[树]]></title><description><![CDATA[…]]></description><link>https://maliut.space/p/nice-tree/</link><guid isPermaLink="false">https://maliut.space/p/nice-tree/</guid><pubDate>Sun, 20 Oct 2019 00:05:00 GMT</pubDate><content:encoded>&lt;p&gt;又到了一年秋季，上班的路上，总能闻到桂花的独特芬芳。&lt;/p&gt;
&lt;p&gt;我不是一个善于分辨植物的人，看着路边形态各异的树木和鲜花，也叫不出它们的名字。即使这次强行记住了，没过多久也会忘记。也无法通过鸟叫声来区分鸟的品种，虽然它们并不是植物。而偏偏很容易就能分辨出桂花，也仅仅是因为它的香味太过独特了。而闻到桂花香，也为我带来了秋天终于到来了的实感。&lt;/p&gt;
&lt;p&gt;总而言之，桂花就是这么一种独特的存在。但桂花之于我的意义，除了提醒秋天已经到来以外，还有便是唤起了我对一篇快要鸽了四年的文章的回忆。没错，就是现在的这一篇，即使这四年里我未曾落下一笔，但对它的思路和内容却从未模糊半分。&lt;/p&gt;
&lt;p&gt;那还要追溯到四年前的秋天，我来到复旦大学张江校区。从食堂到二教，沿着斜穿草坪的小径，每一天都能闻到一股熟悉的香味——路边那仅此一棵的孤零零的桂花树散发的香味。无需多想便能记起这熟悉感的来源。在效实时，从教室到食堂的路上也同样立着这样一棵桂花树，每个秋天都能闻到这浓郁的花香。虽然当时每天都是匆匆忙忙地经过，从未驻足欣赏过一次，也从未与同学朋友谈论起它，但经由这香味，它早已潜移默化地进入我的记忆深处，成为我回忆里效实不可分割的一部分。&lt;/p&gt;
&lt;p&gt;桂花树毕竟是足够独特，以至于大家都能凭借嗅觉把它们分辨出来。可是大多数的树都默默无闻了许多，无论是在路边站岗还是在公园里错落，它们都几乎无法赢得路人游客的一丝注意力，仿佛只是理所当然地杵在那里罢了。当然这些也有可能是我的错觉，大家都很喜欢看树也说不定。至少对我来说，我对树的审美的觉醒，其实是有一个清晰的节点的。那应该也是在初入效实的某年初夏。从公交车站走到学校，路边是两排整齐的行道树。路早已熟悉到闭着眼睛都不会走错，路边的行道树自然也是熟视无睹。然而就在某一瞬间，也不知道为什么，这些树就突然变得可爱了起来。褐色的躯干，透着稳重的气息，但颜色又不至于深到令人乏味。错落有致的叶子，透过清晨的阳光，仿佛可以看到叶脉中流动着的水分子，翠绿色只能让人想到健康。树叶的绿色与树干的褐色又交织在一起，是顶级艺术家恰到好处的配色，挑不出半点瑕疵。一时间，我的目光完全无法从这些树中移开，腿也无法移动半分。当然后半句是编的，毕竟上学还是要上的。&lt;/p&gt;
&lt;p&gt;自此以后每次走在上学路上，我都会用目光对这些行道树完成一次检阅。随着四季变迁，这些树木的形态和颜色逐渐褪去了我一见钟情时的那么可爱，但仍然有着那一份独属于树的独特美感。它们再也不是我以前从来不会为之投去注意力的平凡生物了。再后来，我将这些树写进了我的周记，虽然我贫乏的文字天赋并不能表现出它们的美感。虽然再优美的文字也不能表现出你亲眼见到它们时所能带来的美感。&lt;/p&gt;
&lt;p&gt;自此以后，我对身边的树们也多多关注了起来。无论是上文说到的桂花树还是行道树，我与它们的结缘都与效实脱不了干系。可说到效实，就不能不说最能代表效实的树，效实的校树，银杏。&lt;/p&gt;
&lt;p&gt;银杏，又称为树中活化石，植物中的大熊猫，是十分濒危的物种。这些都是我小时候在百科全书上看到的。所以当我后来在各地都看到了许多银杏，甚至拿它们当行道树时，我不禁十分疑惑——说好的濒危物种呢？不过好像也没什么不好的，就释然了。至于银杏为什么能成为效实的代表，好像是因为效实的老校区里就种着两棵标志性的银杏。当然这我是无从得见了。我所能拥有的印象，就是现在的校园里那一片郁郁葱葱的银杏林。&lt;/p&gt;
&lt;p&gt;效实的银杏林的格局，是和别处不同的。都是依靠着学生必经之路旁的大草坪，树林之间见缝插针地立着童第周的雕像，当然最近也多了不少别人的。每每大考的时候，雕像前就会多出一些柚子、零食之类的东西，寄托着虔诚的学生希望取得佳绩的质朴心愿，虽然最终都被教务处笑纳。倘肯多花一些钱，就可以在毕业了以后认领其中一棵，在树底下插一块“ xx 届 xx 校友认栽”的小蓝牌子。不仅如此，每当学生毕业，大家都会三三两两自发聚在一起，以这些银杏树为背景留下高中最后的合影。&lt;del&gt;每当校庆时分，又会有一个女主角躺在银杏树的脚下，透过指缝散落的阳光让自己睡着从而穿越到过去。&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;后来我去了清华和复旦，在那里我也见到了许多银杏。这两个校园里的银杏是何其相似：在一个巨大的、无比气派的、正对着学校大门的广场上，两排，或是不止两排的银杏树，整整齐齐地，就像接受检阅的士兵一样，一字排开，乖乖地呆在水泥瓷砖地面中特意为它们挖好的坑洞里面。那一瞬间我有点可怜它们。如果它们长在效实园里，它们不必如此刻板、拘谨。效实的银杏林的草坪足够大，足够让它们自由生长，自由发挥。虽然这些完全都是我的主观印象，但我想这确实是效实为我的思想带来的一些烙印。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;银杏是效实园里当之无愧的主角，但&lt;del&gt;就像在一个有很多妹子的氪金手游里面很多人都会找一个不那么热门的角色来主推一样，&lt;/del&gt;我偏爱的还是另一棵树。那棵树，就是一棵普通的平平无奇的树，我相信每个人都无数次地见过它的同类，但我从来叫不出它究竟叫什么名字。可这又有什么关系呢？我喜欢的只是那一株。我为它起好了特别的名字。我称它为「好树」。&lt;/p&gt;
&lt;p&gt;「好树」并不是我脑子一热，随便取的名字。顾名思义，它是一棵很好的树，但也只是普通的好，并没有某一部分好的特别突出，能让我用更有针对性的名字来命名它。确切来说，它就是一棵树最标准的样子，因此它不是那么起眼，但如果你注意到了它，它的颜色，它的体型，它树冠的大小，都是恰到好处，让你感到非常舒服。&lt;/p&gt;
&lt;p&gt;可作为一个理性人，舒服与否只是我的主观感受。有时候我就问自己，世界上的树这么多，凭什么我就认定它是一棵树的标准样式呢？后来我想了想，或许这和 Minecraft 有关。有段时间我疯狂迷恋这款游戏，直到现在我也只是因为开始晕 3D 才冷落了它。而作为一个 Minecraft 玩家，谁会不喜欢一棵树呢？当你两手空空地来到这个世界，没有树你就寸步难行，而哪怕只有一棵树，你就可以用它打造出整个世界。整个世界，用着默认材质包，开着最低特效，被某些人嘲笑玩的什么游戏。但我喜欢看着方形的太阳缓缓升起，金色的阳光撕裂浅蓝色的天空，越过锯齿状的河流，洒落在一片程序生成的橡树林里，在某一棵树下 Steve 举起右手，一个新世界在这里诞生。那些橡树，刨去一切随机要素的影响，本应该是一个模子刻出来的完全一致，但在&lt;del&gt;也许并不那么&lt;/del&gt;精巧的算法安排下，此刻它们错落有致，共同组成了这一片有机、真实的丛林。它们都是好树。&lt;/p&gt;
&lt;p&gt;大抵是每个人年少时，都觉得身边的世界充满了未曾见过的新鲜事物，声色犬马，它们无时不刻地拉扯着你有限的注意力。而只有在长大以后，面对周围一成不变、早已失去了新鲜感的现实，才能慢慢感受到平凡中蕴藏的美好。&lt;/p&gt;
&lt;p&gt;大抵是每个人年轻时，都觉得自己会是花园里那独一无二的一株鲜花，是人们心中毋庸置疑的焦点。而只有在长大以后，才能将自己代入角落里那不太起眼的一棵树，接受自己只是树林里平庸的一份子的现实，但仍有着自己的坚持。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/660181cc9104807b9b3fe4f04965c5e1/7bf67/tree.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 133.4975369458128%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAbABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMEBQb/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABtkVKk1IsXKrnKFk8j//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMQERIT/9oACAEBAAEFAvZYrHqXvopaUKv0tj9QagL6etYBj//EABcRAAMBAAAAAAAAAAAAAAAAAAAQERL/2gAIAQMBAT8Bqhk//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAERMRASQVH/2gAIAQEABj8CLnGskoT9NmWdKz//xAAeEAACAgICAwAAAAAAAAAAAAABEQAhEDFBUWGBwf/aAAgBAQABPyE+U+ops1XgiBLkQFLrjuC06NGEsW6A6jD9Q0FXFjFCAlT/2gAMAwEAAgADAAAAEGMoc//EABkRAAIDAQAAAAAAAAAAAAAAAAABEBExcf/aAAgBAwEBPxB0caOj/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREP/aAAgBAgEBPxDKyn//xAAcEAEBAQEAAgMAAAAAAAAAAAABEQAhMZFBUXH/2gAIAQEAAT8QFwWbJjlkSqtwc1ayBbzd5mDvw/Wp2TKRLiCFcI5jtZEXj1o0Y8cWYYse3NQQ+q4g7v/Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;好树&quot;
        title=&quot;好树&quot;
        src=&quot;/static/660181cc9104807b9b3fe4f04965c5e1/7bf67/tree.jpg&quot;
        srcset=&quot;/static/660181cc9104807b9b3fe4f04965c5e1/efcb5/tree.jpg 203w,
/static/660181cc9104807b9b3fe4f04965c5e1/02e66/tree.jpg 405w,
/static/660181cc9104807b9b3fe4f04965c5e1/7bf67/tree.jpg 680w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;知道你们好奇是哪棵树，但请不要对我充满强烈个人主观的审美体验抱有过高的期望&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;那棵「好树」，大学毕业时我又回去看了它一次，今已亭亭如盖矣。我见证了它这几年的成长，正如同它见证了我的成长一样。褪去了初见时的青涩和稀疏，如今的它更加茂密且翠绿了，它依然是那棵「好树」。&lt;/p&gt;
&lt;p&gt;它依然是一棵好树。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[4.22.23.06]]></title><link>https://maliut.space/p/4-22-23-06/</link><guid isPermaLink="false">https://maliut.space/p/4-22-23-06/</guid><pubDate>Mon, 22 Apr 2019 23:06:00 GMT</pubDate><content:encoded>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</content:encoded></item><item><title><![CDATA[第三方收发微信消息主流技术小结]]></title><description><![CDATA[一篇水文。最近因为需要去了解了一下如何通过第三方技术收发微信的消息，以至于实现一些更复杂的功能。由于微信实际上并没有开放这方面的 API…]]></description><link>https://maliut.space/p/wechat-crack/</link><guid isPermaLink="false">https://maliut.space/p/wechat-crack/</guid><pubDate>Sun, 03 Mar 2019 21:33:36 GMT</pubDate><content:encoded>&lt;p&gt;一篇水文。最近因为需要去了解了一下如何通过第三方技术收发微信的消息，以至于实现一些更复杂的功能。由于微信实际上并没有开放这方面的 API ，所以通俗来讲，就是研究了下如何破解微信的体系。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;大体的思路也比较好理解，就是通过微信的各个端入手来模拟。主流的做法大概有以下几种：&lt;/p&gt;
&lt;h2&gt;Android 端 Hook&lt;/h2&gt;
&lt;p&gt;原理： Android 中有著名的 Xposed 框架，可以 Hook 任何 App 的方法，在调用前后插入自己的逻辑。&lt;/p&gt;
&lt;p&gt;对于收发微信消息来说，收消息相对比较简单，因为可以通过 Hook 数据库插入的方法来实现。而微信的数据库使用 wcdb ，表结构为了稳定也不会轻易变化。也就是说，只要能找到数据库插入的操作，稳定的 Hook 方式便可以一直存在。但是 Hook 发消息就没那么容易了。发消息是一组复杂的方法调用，当涉及到消息类型为图片、语音等复杂类型时还会更为复杂。找到发消息的方法已经是难事了，更何况混淆过后的代码还和天书一样，没有十足的耐心根本找不到线索。更甚，混淆后的方法名每个版本都不一样，可能你辛辛苦苦破解了一个版本，到了下一个版本，哪怕源码做了一丁点改动，你也要花费很大的工作量去适配。&lt;/p&gt;
&lt;p&gt;从市面上来看，使用 Xposed 破解微信的主要用途还是在于消息防撤回和一些 UI 上的定制化，对于发消息的需求并不算多。另一方面，针对发消息的 Hook 开源代码也比较少，且不太成熟，有些人在兜售成熟的解决方案，尚不知道是否有用。尝试了一些开源代码以后，我找到个 &lt;a href=&quot;https://github.com/Blankeer/WechatBotXposed&quot;&gt;WechatBotXposed&lt;/a&gt;（基于微信 6.6.6 版本） 还是比较靠谱的。&lt;/p&gt;
&lt;p&gt;由于使用 Xposed 需要 Root 手机比较麻烦，这里也提供了一个尝试代价小的方案可供试玩：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;手机安装 &lt;a href=&quot;https://vxposed.com/&quot;&gt;VirtualXposed&lt;/a&gt; 。&lt;/li&gt;
&lt;li&gt;VirtualXposed 安装微信 6.6.6 版本（旧版本的微信可以通过豌豆荚安装，这不是广告）&lt;/li&gt;
&lt;li&gt;VirtualXposed 安装上述插件&lt;/li&gt;
&lt;li&gt;启用插件并重启 VirtualXposed &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/379b5adaa0b81c21c7de80b245fe2520/wechat1.gif&quot; alt=&quot;Demo&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果想进一步开发，也可以看&lt;a href=&quot;https://blankeer.github.io/2018/05/09/%E5%88%A9%E7%94%A8-Xposed-%E5%BF%AB%E9%80%9F%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA/&quot;&gt;这篇讲 WechatBotXposed 的思路的文章&lt;/a&gt;，学习如何反编译分析微信的方法。&lt;/p&gt;
&lt;p&gt;不过，对于这种破解方式，微信的打击还是比较厉害的。去年年中微信封禁了一波使用 Xposed 的帐号，据称是为了打击世界杯赌球。根据网上能看到的传闻，微信可能会读取手机中已安装应用的列表，判断手机是否被 Root 、是否安装了 Xposed 应用。也有一种方式是判断方法的调用栈中是否存在 Xposed 相关。当然，微信也存在一套行为分析的系统，会通过你登录频次、消息发送频次、设备信息等因素，判断帐号是否存在异常行为。&lt;/p&gt;
&lt;p&gt;个人认为，对于这种方式，微信还是比较容易判断出来的。收消息暂且不论，对于发消息，本来是需要用户手动点击发送按钮，而现在一定会有某个函数触发了发消息的逻辑，一定能通过调用栈判断出来。事实上，我用这种方式玩了两天以后，微信就限制了我的帐号在低版本上的登录，必须让我在新版本上才能登录了。&lt;/p&gt;
&lt;h2&gt;使用 Android 上的辅助功能&lt;/h2&gt;
&lt;p&gt;原理： Android 上的辅助功能，原本是给残障人士所使用，帮助他们更好地使用手机上的功能。但我们也可以利用这些功能来做到辅助读屏、模拟点击的功能。&lt;/p&gt;
&lt;p&gt;获取屏幕上的控件或点击对应的按钮，需要我们知道界面元素的资源 ID ，所幸这并不需要什么高超的破解技巧，只要使用旧版的 DDMS 对手机界面进行 Dump 就可以了。虽然每次微信升级后，由于混淆的原因，资源 ID 会发生变化，但重新适配的成本也比 Xposed 方案低的多。再退一步讲，即使不知道界面元素的资源 ID ，也可以通过按钮的文字等来区分，这样就完全不需要破解或 Dump 之类的工作了。&lt;/p&gt;
&lt;p&gt;辅助功能的适用场景正好和 Xposed 方案相反。对于发消息，它的实现非常容易，只要你能找到正确的发送对象，接下来输入框和发送按钮都是固定的，直接模拟点击即可。在 Github 上也可以找到&lt;a href=&quot;https://github.com/Clearlee/AutoSendWeChatMsg&quot;&gt;现成的实现&lt;/a&gt;。但如何判断收消息就困难了不少，因为你很难去监测收到消息这一不是我们主动触发的行为。在网上找到了两种不同的思路，其一是&lt;a href=&quot;https://blog.csdn.net/u014651216/article/details/52525009&quot;&gt;通过监测通知栏的变动&lt;/a&gt;，其二是&lt;a href=&quot;https://www.cnblogs.com/cxk1995/p/6366273.html&quot;&gt;通过监测聊天界面的改变&lt;/a&gt;。但两种方式的缺陷也很明显，前者通知栏的推送并不稳定，同时多条通知处理起来也比较麻烦；后者则必须停留在某人的聊天界面中才能监测到。&lt;/p&gt;
&lt;p&gt;也正是因为这样的特点，使用辅助功能的玩法一般用于实现各类微信群发助手。群发助手天然符合它的长处：一方面只管发消息，不管收消息；另一方面，对于所有人发送消息，也避免了判断发送对象是否正确的烦恼。&lt;/p&gt;
&lt;p&gt;这种玩法最大的优势在于完全合法，无需考虑被微信打击的因素。但缺点也很明显，模拟点击的原理使得你不得不为操作加上一些延迟，一些从代码层面来看很简单的操作（比如获取微信号 etc）也需要绕很大的圈子才能做到。同时它受外界影响极大，一旦手机出现些不可预知的卡顿，或其他界面弹出，或同时交流的人数过多，界面变化频繁时，自动执行的操作就会被打断，甚至产生消息发错对象的尴尬。这使它注定只能作为玩具，而无法成为大规模商业化的应用。&lt;/p&gt;
&lt;h2&gt;使用微信网页版 API&lt;/h2&gt;
&lt;p&gt;原理： Web 即意味着不设防，相比于其他客户端， Web 永远是防御力最薄弱的那个。另外 Web 并不是微信的主打方向，因此迭代速度较慢，版本适配难度也较低。只要破解了 Web API ，就可以模拟登录网页版微信收发消息了。&lt;/p&gt;
&lt;p&gt;这个方法实在没有什么好说的，原理简单粗暴，以前的 Web QQ 也遭遇过这样的毒手。现在基于 Web 微信的机器人程序已经形成了一个庞大而成熟的开源社区，有着完善而优雅的 RESTful API 、命令行工具等。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/chatie/wechaty&quot;&gt;&lt;img src=&quot;/128ea3b4800b6e243af1dc52a3d99567/wechat2.svg&quot; alt=&quot;Wechaty&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;相比前面两种方法，我认为这种做法是目前最成熟且具有可行性的。虽然这也属于破解的范畴，但是由于 Web 端的特定使然，微信并不能做出什么很有针对性的防御。不过微信并非没有采取措施。正如 Web QQ 现在已经被废弃一样，微信也一刀切地禁止了所有新注册帐号的 Web 端登录权限，坊间也一直有微信会取消 Web 版的传言。但即使微信不会取消 Web 版，光是新注册帐号无法登录这一举措，就使得这一方法未来的潜力大打折扣，沦为部分爱折腾的存量用户的玩具。另外，微信的风控体系，也会对那些明显超出频次调用接口的帐号进行临时的封禁，以阻止用户的为所欲为。&lt;/p&gt;
&lt;p&gt;除了以上提到的几点， Web 版本身的功能也是有限的。除了简单的收发消息，进阶的功能比如收发红包、朋友圈等并没有相关的 API ，对于野心更大的开发者来说是个局限。另外，由于 Web 端走 HTTP 协议，对于收发消息的稳定性会比 Native 端略低。&lt;/p&gt;
&lt;h2&gt;其他途径&lt;/h2&gt;
&lt;p&gt;上述提到的三种是目前的主流技术，但可以看到都有比较大的局限性，因此也有不少人在探索新的解决方案，例如基于 iPad 版和 PC 版的破解。当然，也曾见到技术实力较高的团队，通过自行定制 Android ROM 的方式，提供软硬件一体的解决方案，对微信做大规模的 Hack 。不过以上方案在网上都鲜有公开的资料流出，一方面是为了低调防打击，另一方面也是将其作为商业化的手段。&lt;/p&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;作为普通用户的我们难以想象基于微信这一看似封闭的 App 衍生出了多大的产业链。朋友圈的微商、公众号，还有现在的小程序和小游戏，已经完全可以支撑起一个像样的创业团队。也因此，对微信的破解成了一件十分有利可图的事，吸引了不少人前仆后继。对于时长脑洞大开的开发者如我，自然希望微信可以像 Telegram 那样开放出更多的 API ，以便把更多创意落到实处，但也理解关系链之于微信的重要性，明白这几乎就是天方夜谭。只是，对于那些把身家性命放在微信破解上的公司和开发者，就好像空中楼阁，被微信反手就能玩死，也未免太可悲了。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[如何寻找 YaHaHa ？]]></title><description><![CDATA[我第一次发现 YaHaHa…]]></description><link>https://maliut.space/p/how-to-find-yahaha/</link><guid isPermaLink="false">https://maliut.space/p/how-to-find-yahaha/</guid><pubDate>Tue, 05 Jun 2018 20:45:16 GMT</pubDate><content:encoded>&lt;p&gt;我第一次发现 YaHaHa ，是在初始高地的沼泽。半截中空的木桩通过铁链连接着沉入沼泽底部的大铁球。“铁球的大小，似乎刚好可以立在木桩之上”。刚学会磁铁能力的我对周围可以操作的事物充满了新鲜感，恨不得将它们通通把玩一番，于是怀着这样近乎恶作剧般的心态，我吸起铁球，放到了木桩之上。&lt;/p&gt;
&lt;p&gt;&quot;Ya-ha-ha! You found me!&quot; 突如其来的场景吓了我一跳。&lt;/p&gt;
&lt;!-- more --&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 810px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/04d82386be02916f68007c8602b8ae0f/a2510/yahaha1.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.15763546798029%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAgAB/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB06MEp1H/xAAaEAABBQEAAAAAAAAAAAAAAAABAAIQESIy/9oACAEBAAEFAql3IGV//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Bqv/EABYQAAMAAAAAAAAAAAAAAAAAAAEQIP/aAAgBAQAGPwKAv//EABoQAAMBAAMAAAAAAAAAAAAAAAABESEQMUH/2gAIAQEAAT8hTCrudOGiVxdfeP/aAAwDAQACAAMAAAAQ7w//xAAWEQEBAQAAAAAAAAAAAAAAAAARACH/2gAIAQMBAT8QMZv/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEx/9oACAECAQE/EB9jV//EABsQAAMAAgMAAAAAAAAAAAAAAAABESFBUWFx/9oACAEBAAE/EGNzpmdcU9E5CKbhpqOCsL2tZpH/2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Yahaha！&quot;
        title=&quot;Yahaha！&quot;
        src=&quot;/static/04d82386be02916f68007c8602b8ae0f/627f4/yahaha1.jpg&quot;
        srcset=&quot;/static/04d82386be02916f68007c8602b8ae0f/efcb5/yahaha1.jpg 203w,
/static/04d82386be02916f68007c8602b8ae0f/02e66/yahaha1.jpg 405w,
/static/04d82386be02916f68007c8602b8ae0f/627f4/yahaha1.jpg 810w,
/static/04d82386be02916f68007c8602b8ae0f/a2510/yahaha1.jpg 1000w&quot;
        sizes=&quot;(max-width: 810px) 100vw, 810px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;我第二次发现 YaHaHa ，是在路边的峭壁上。峭壁上的三个小立方体组成了一个缺了个角的大正方形，而另一个小立方体则落在地上。“它们正好能拼成一个完整的正方形诶”，我把小立方体放到缺了的角上——又一个 YaHaHa 。&lt;/p&gt;
&lt;p&gt;YaHaHa 的学名其实是克洛格，是《塞尔达传说 - 旷野之息》中的一种收集要素，它遍及整个大陆，有 900 个之多，但却都极为隐蔽，若是匆匆赶路，你完全不会意识到它们的存在，但如果你感到地图某处有说不出来的不对劲，往往就藏着它们的身影。&lt;/p&gt;
&lt;p&gt;随着游戏的进行，我寻找 YaHaHa 越来越熟练：见到三棵树就会去摘苹果，见到荷叶就去跳水，爬到山顶看到石头就会去搬一搬。《旷野之息》很好玩，寻找 YaHaHa 也令人乐此不疲，只是，这过程中再没有多少思考。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;再一次受到 YaHaHa 的惊喜，已经是游戏的后期。主线早已通关，而神庙也都找全。DLC 中有件“克洛格的面具”道具，能提示你周围还未找到的 YaHaHa 。有个同学告诉我卡卡利科村的村口响起了提示，但无论如何也找不到。我在周围上蹿下跳了半天也未果。&lt;/p&gt;
&lt;p&gt;周围的一草一木，已经是再清楚不过了，它到底藏在哪里呢？我不得不放弃了徒劳无功的搜索，转而停下来思考。突然我灵光一闪——村口大门的横梁上有村子的标志，而四周歪歪扭扭地射了好几根箭。我第一次来到这个村庄的时候，箭还是稀有物品，我甚至还试图爬到上面去把这些箭都拔下来。现在想想，一个与世无争的村子，大门上被射了好多箭，这难道不奇怪吗？&lt;/p&gt;
&lt;p&gt;正对着中间的标志射了一箭。&quot;Ya-ha-ha! You found me!&quot; 熟悉的场景应声而出。&lt;/p&gt;
&lt;p&gt;又一次，同学告诉我海利亚大桥上有个 YaHaHa 找不到。同样地来回绕桥探索但一无所获。我注意到桥洞下放着个小树枝。这个小树枝，其实我早已发现，但一直没放在心上，毕竟，满地图捡武器的塞尔达里，地上有个小树枝也是再正常不过的事情。然而再仔细一想，在茫茫大湖之上，全是石头做成的大桥，却出现了一个小树枝，也未免太突兀了吧。&lt;/p&gt;
&lt;p&gt;捡起树枝，果然又是熟悉的场景。&lt;/p&gt;
&lt;p&gt;尽管那个时候的我早已对游戏的各种机制都烂熟于心，见怪不怪，但当 YaHaha 蹦出来的那一瞬间，我的心还是不由自主地震颤了一下。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 810px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5bca02f30809210a9e733bd052a0e60f/eea4a/yahaha2.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.15763546798029%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAZI6ZTI0A//EABcQAAMBAAAAAAAAAAAAAAAAAAABIRD/2gAIAQEAAQUCINUef//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAgEBPwHSv//EABYQAAMAAAAAAAAAAAAAAAAAABAgIf/aAAgBAQAGPwIRP//EABoQAAIDAQEAAAAAAAAAAAAAAAERABBBITH/2gAIAQEAAT8hQ2ciO9FQ7tf/2gAMAwEAAgADAAAAEOA//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPxBayH//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCj/8QAGhABAAIDAQAAAAAAAAAAAAAAAQARITFBYf/aAAgBAQABPxBQoD7GxVHL3AdC4rMocOoAgxYLhqf/2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;海利亚大桥&quot;
        title=&quot;海利亚大桥&quot;
        src=&quot;/static/5bca02f30809210a9e733bd052a0e60f/627f4/yahaha2.jpg&quot;
        srcset=&quot;/static/5bca02f30809210a9e733bd052a0e60f/efcb5/yahaha2.jpg 203w,
/static/5bca02f30809210a9e733bd052a0e60f/02e66/yahaha2.jpg 405w,
/static/5bca02f30809210a9e733bd052a0e60f/627f4/yahaha2.jpg 810w,
/static/5bca02f30809210a9e733bd052a0e60f/78959/yahaha2.jpg 1215w,
/static/5bca02f30809210a9e733bd052a0e60f/eea4a/yahaha2.jpg 1280w&quot;
        sizes=&quot;(max-width: 810px) 100vw, 810px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;海利亚大桥，游戏中 Yahaha 密度最高的区域之一&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;作为在同伴中，收集个数最多的那一个，我也时常被问到该如何寻找 YaHaHa 。可是，在最开始时，我甚至不知道 YaHaHa 的存在，我去做那些事情纯粹是因为觉得有趣，觉得“它们应该是这样的”。而 YaHaHa 的出现，就像是玩家与游戏设计师的会心一笑，是设计师告诉玩家“你想的没错，恭喜你发现了这个小彩蛋”，是玩家与设计师之间跨越时空的心照不宣。但后来，收集 YaHaHa 成了目的，而我们也似乎逐渐陷入思维定势，觉得似乎 YaHaHa 就只有这么固定的几种，而忽略了 YaHaHa 设计的初心。&lt;/p&gt;
&lt;p&gt;海拉鲁大陆 900 个 YaHaHa ，我踏遍世界，收集到的不过三分之一。想必，还有不少就隐藏在了那些被忽视了的非类型化的去处。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;我觉得 YaHaHa 的设计其实就像是整个《旷野之息》的一个缩影：没有强制性的任务要求，也没有地图上明晃晃的提示点，它需要的是你像孩子一样敏锐的观察力和旺盛的好奇心，凭着本能发现这细节中隐藏的奥秘。而在网上无数玩家对《旷野之息》的溢美之词中，也都像个孩子一样倾诉着自己神奇的小发现、独一无二的探索旅程，仿佛三天三夜也说不完；也都不约而同地提到了这作是现在市面上无数套路式的、 checklist 式的所谓开放世界游戏中的一股清流，甚至于，重新定义了“开放世界”。&lt;/p&gt;
&lt;p&gt;当然，天下苦 checklist 游戏久矣。无论是开放世界游戏中的任务点、收集点，还是平日里氪金手游中的日常周常等等，都是通过激发玩家的强迫症，而异化了最初玩游戏时那种纯粹追求快乐或是放松的心情。但想要让玩家以纯粹的兴趣和好奇心来驱动游戏却并非易事。而《旷野之息》的方方面面就是这样有机地结合在了一起，为这个问题交上了一份满分的答卷。在游戏伊始，当我操纵着林克从昏暗、窄小的复苏神庙走廊中奔跑出来，我和大多数人一样，被面前整片广阔的大陆所震撼。而更为震撼的是，我在游玩过程中慢慢发现，这映入眼帘的整片大陆的整个角落，完全没有空气墙之类的障碍，只要你愿意便都可以涉足&lt;del&gt;（严格来说迷雾森林部分地方还是不行。另外想特别吐槽下 GTA5 ，虽然建筑这么多，但基本上都进不去）&lt;/del&gt;。而经过了精心设计的塔、神庙以及地形的布局，让玩家时刻都能发现视野中新的兴趣点，根本停不下来。再加上早已饱受赞誉的物理、化学系统带来的涌现式的玩法，以及简单且非强迫的主线等等，一切的一切都很好地服务了游戏的核心乐趣。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 810px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/00c04c9a5e7d1eb19e951ce8169e5e1f/29007/yahaha3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.15763546798029%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACdUlEQVQozw3O207TYAAA4D6cl8ZEEyOC2UbX/mvXfz2vO3Rt19ParS3deTA22BgDXeSMERMUwkDURGNCSCQmXhj00njrnbzAlw9RunvK4rbc2sq3duTObra9n2/vy4uH6vJrffXYWjt1N6bei4vm9ofeweVw7/zw5NPHL19vvl3//vkd0RuDTGXVX9kIBpvBcLKwtlUd79Q39zqTg97Wq8HB29Gbs/HxdHd6MTk6cesvzy6mtz8+//119e/PDYLDLOC9jN3JOd1ye2DV+lJ5qIVDszHSG+u13ri9NjGaz5XquFhbF/Vh0Jq8f3d0e31+dXmKPJzBZ2MkoEWMylNpG5N8LFuPZ+qg0JwVaxGpCQpLgjuE9irr92VvIFdGRjCq1MZebQN5jBIzODVHQIzlAS9C1QSmT7shHzTIUpW0q5RbE8J2ttnNNLqFdq/Q6Oeqy1q9Z7VXkEiaj2TScTkPDS1l6oJv0UGJcG3ac2DZhmWTXnCh5zDVChv6XOilwyAbhm6vay91EMxIJRwBM0TSEQknEy0xhMMRJZGqpAlXRFUhrvOYweEmDywR1wVo5Ugjy7p5rWEhhJPETRgvQmAzcYONm3cWg9ksXuJwhaaLDOXyuM3GiilUY9CiCAwJGCLQBFxnENym5zVuXuNRg4tpMFGGmJ0ibSplEqkcyFmpnAeVQFJaWdLhE4aYsATMpEmHTRgccpdBDSGiQsInCJ+OyklSBlwxLqrJtJGUTEiqc3HxKZ+H/qKuN9WkJUQUEjUI3CEQ0hWJShKzCeCSURVEmTlORVMSEPM0p8cEa55UZp4kHty7/0i3pVZfDrpaQueeZSi0CP4D+MRUVcFqKgIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;BoTW&quot;
        title=&quot;BoTW&quot;
        src=&quot;/static/00c04c9a5e7d1eb19e951ce8169e5e1f/d7542/yahaha3.png&quot;
        srcset=&quot;/static/00c04c9a5e7d1eb19e951ce8169e5e1f/2efce/yahaha3.png 203w,
/static/00c04c9a5e7d1eb19e951ce8169e5e1f/1d180/yahaha3.png 405w,
/static/00c04c9a5e7d1eb19e951ce8169e5e1f/d7542/yahaha3.png 810w,
/static/00c04c9a5e7d1eb19e951ce8169e5e1f/d56b5/yahaha3.png 1215w,
/static/00c04c9a5e7d1eb19e951ce8169e5e1f/29007/yahaha3.png 1600w&quot;
        sizes=&quot;(max-width: 810px) 100vw, 810px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;是的，目之所及之处，你都可以去探索、去涉足&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;关于《旷野之息》的设计经验和哲学，网上早已经有一大把分析文了。我也不是专业的游戏评论者和开发人员，无意再深入地探讨下去。我只想谈谈我自己的游玩感受。《旷野之息》，它真的是那种，那种很少见的那种，可以让人完全沉浸的游戏。我相信大家但凡是游戏玩的多了以后都有这样的感受：每遇到一个新游戏，便将它归为某一类，然后用之前在其他相同类型游戏中学到的经验套上去，边玩边开始分析哪里设计好、哪里不好。基本体验完一遍核心流程，做出个“剧情 x/10，画面 x/10，音乐 x/10，总评 x/10”的套路评价，就将其盖棺定论了。这其实是人类进化过程中发展出的一个能力，能让我们以更快的方式上手、了解一件新鲜事物。但是，总觉得与游戏间多了一层距离。而《旷野之息》则不然，它就像有魔力一般，它让我忘掉了各种条条框框的设计原理，忘掉了吃饭，忘掉了睡觉，无视了周围的一切，仿佛我真的穿越到了这片世界之中，或策马或御风遨游在大陆的各个角落。而又在事后与他人讨论起游戏来，才猛然意识到游戏中许许多多的理所当然，其实是有意为之，大巧不工，不禁慨叹设计的精巧与细节的充沛。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 810px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f8eb2e42119a0bf15ab78f6f71a058ea/c7398/yahaha4.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.66502463054187%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAZZzrNDwsG//xAAbEAABBAMAAAAAAAAAAAAAAAACAAEDERASIf/aAAgBAQABBQIJKTE1b4tDwf/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/AYj/xAAWEQADAAAAAAAAAAAAAAAAAAAAARL/2gAIAQIBAT8Btls//8QAGBAAAwEBAAAAAAAAAAAAAAAAARAxACH/2gAIAQEABj8C7FAxv//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQWGR/9oACAEBAAE/IUwBHkVYCU6+kcJYy8qcBP/aAAwDAQACAAMAAAAQRw//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPxCUv//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAECAQE/EKH/AP/EABsQAQADAQADAAAAAAAAAAAAAAEAESFRMWGB/9oACAEBAAE/EDgeUGE+zGeeVvJ2B0UThkKRQtBCCAWW57Z//9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;沃托里村&quot;
        title=&quot;沃托里村&quot;
        src=&quot;/static/f8eb2e42119a0bf15ab78f6f71a058ea/627f4/yahaha4.jpg&quot;
        srcset=&quot;/static/f8eb2e42119a0bf15ab78f6f71a058ea/efcb5/yahaha4.jpg 203w,
/static/f8eb2e42119a0bf15ab78f6f71a058ea/02e66/yahaha4.jpg 405w,
/static/f8eb2e42119a0bf15ab78f6f71a058ea/627f4/yahaha4.jpg 810w,
/static/f8eb2e42119a0bf15ab78f6f71a058ea/c7398/yahaha4.jpg 1154w&quot;
        sizes=&quot;(max-width: 810px) 100vw, 810px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;metadata&quot;&gt;沃托里村，依山面海，地图角落的世外桃源，唯一没有主线的自然村庄，也是我最喜欢的地方&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;我很想用寻找 Yahaha 就是寻找玩游戏的初心，重塑看世界的方式这样既点题又漂亮的话来结束这篇文章。但在无脑吹完这个游戏以后，总还有一些话令人不吐不快。回想起在初始之塔上我举目四望，心情是难掩的激动。光小小一个初始台地，就让我产生了数不清的惊喜，那地图上初始台地以外的那么大那么大无边无际的黑暗之中，还有多么无尽的值得探索的去处在等着我呢？而当我完成大地图的最后一块拼图，完整的界面出现在我眼前，开心之余也多了一份遗憾。这个世界再大也有边界，终有一天我会踏遍海拉鲁的每一寸土地，世界在我面前将没有秘密可言。《旷野之息》我玩了上百个小时，游戏时间能在此之上的，也只有可以重复游玩的过程生成式游戏，和与人斗其乐无穷的竞技类游戏了。近年来这样的游戏充斥着业界，毕竟它们制作成本相对较低，又能换来玩家大量的游戏时间，在这个时间就是金钱的现代社会，谁都知道这意味着什么。而《旷野之息》这样的游戏就是消耗品了，纵然你对游戏世界怀有再多的爱与不舍，在几百个小时的游戏时间过后，也将不得不陷入“拔剑四顾心茫然”的境地。&lt;/p&gt;
&lt;p&gt;曾经沧海难为水，除却巫山不是云。感谢任天堂，感谢世界，让我在最适合打游戏的时光里遇到了这样一款伟大的游戏。可是在经历完这南柯一梦以后，下一个能再唤醒我的热情，让我废寝忘食的游戏又需要等多久才会出现呢？而即使出现了又一个如此伟大的游戏，那个时候的我，过着日复一日机械生活的我，还能做到像现在这样抛开世俗的一切繁冗，忘情地享受这一切吗……&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 298px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7a8988915e05c2e4d4cba33c2f49a331/300b8/yahaha5.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 90.14778325123154%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQCA//EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAY8nOVOJJtm72B//xAAZEAEAAwEBAAAAAAAAAAAAAAABAAIRMjH/2gAIAQEAAQUCmynK4XriBj0ez//EABkRAAEFAAAAAAAAAAAAAAAAAAEAAhAREv/aAAgBAwEBPwFxsrU//8QAGBEAAgMAAAAAAAAAAAAAAAAAABEBEBP/2gAIAQIBAT8BSgzv/8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEhEBEgMUH/2gAIAQEABj8CjVOEMumiXh//xAAcEAEBAAICAwAAAAAAAAAAAAABABEhMUFRcYH/2gAIAQEAAT8hO4dMDzIQuEmgRuAD3O0PrNicZDwX/9oADAMBAAIAAwAAABBYL4L/xAAYEQEAAwEAAAAAAAAAAAAAAAABABAhEf/aAAgBAwEBPxAcYkzl/wD/xAAYEQEAAwEAAAAAAAAAAAAAAAABABARIf/aAAgBAgEBPxDeMA9W/wD/xAAdEAACAgIDAQAAAAAAAAAAAAABEQAhQWExUcHw/9oACAEBAAE/EGLAT2NS9eFPUttRQP3biRyUQvhF5GpAGaUHUDgAO/YoLLZzoTkRs3cb8Nz/2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Meme&quot;
        title=&quot;Meme&quot;
        src=&quot;/static/7a8988915e05c2e4d4cba33c2f49a331/300b8/yahaha5.jpg&quot;
        srcset=&quot;/static/7a8988915e05c2e4d4cba33c2f49a331/efcb5/yahaha5.jpg 203w,
/static/7a8988915e05c2e4d4cba33c2f49a331/300b8/yahaha5.jpg 298w&quot;
        sizes=&quot;(max-width: 298px) 100vw, 298px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[meta.js - JavaScript 元编程工具库]]></title><description><![CDATA[meta.js 为 Javascript 语言扩充了一些元编程功能，在使用 ES6 的 class 语法定义类时，你能够以更加直观自然的方式，像一门原生就是基于类的语言那样，使用这些元编程功能。 可以在这里获取它的使用文档与源代码。 开发这个库的灵感来源于之前阅读的《Ruby…]]></description><link>https://maliut.space/p/metajs/</link><guid isPermaLink="false">https://maliut.space/p/metajs/</guid><pubDate>Fri, 24 Nov 2017 23:44:00 GMT</pubDate><content:encoded>&lt;p&gt;meta.js 为 Javascript 语言扩充了一些元编程功能，在使用 ES6 的 class 语法定义类时，你能够以更加直观自然的方式，像一门原生就是基于类的语言那样，使用这些元编程功能。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;可以&lt;a href=&quot;https://github.com/maliut/meta.js&quot;&gt;在这里&lt;/a&gt;获取它的使用文档与源代码。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;开发这个库的灵感来源于之前阅读的《Ruby 元编程》一书。考虑到 JavaScript 语言与 Ruby 同为动态语言，灵活度相似（具体的读后感与对比可以参考&lt;a href=&quot;/p/javascript-metaprogramming&quot;&gt;这篇文章&lt;/a&gt;），且在 JavaScript 开发中也会经常遇到一些需要语言动态性的场景以简化代码。而在 JavaScript 中操作这些动态性，就免不了与 prototype 打交道，而在最新的 ES6 语言规范中，class 等语法糖的引入，也表明了这门语言希望尽量淡化 prototype 之类的概念，降低新手的学习门槛与熟悉了其他语言的开发者们的知识迁移成本。故在这基础之上，我的元编程库也把这些细节封装起来，以便大家能用更自然的方式使用这些元编程功能。&lt;/p&gt;
&lt;p&gt;开发这个库的另一个动机则是对于 &lt;code class=&quot;language-text&quot;&gt;method_missing&lt;/code&gt; 在 JavaScript 中的实现。&lt;code class=&quot;language-text&quot;&gt;method_missing&lt;/code&gt; 是讲解 Ruby 语言动态性的一个典型例子，在实际开发中也不乏实用性。JavaScript 在 ES6 中引入了 Proxy，使得实现 &lt;code class=&quot;language-text&quot;&gt;method_missing&lt;/code&gt; 功能也成为了可能。但遗憾的是，网上所有讲解“如何在 JavaScript 中实现 &lt;code class=&quot;language-text&quot;&gt;method_missing&lt;/code&gt;” 的文章全是有问题的。它们只是简单演示了一下对 Proxy 的使用，却丝毫没有真正去使用过它。所以我在这个库中尽量严谨地实现了这个功能，以供大家参考。&lt;/p&gt;
&lt;p&gt;代码本身不长，也很简单，欢迎大家多多使用反馈。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Smalltalk 入门学习]]></title><description><![CDATA[旧笔记补档，原来是为 2017-10-06 线下 MAP 活动做的笔记 2018-08-02 第一版 2020-08-06 第二版 前言 为什么要学习 Smalltalk？Smalltalk…]]></description><link>https://maliut.space/p/smalltalk/</link><guid isPermaLink="false">https://maliut.space/p/smalltalk/</guid><pubDate>Thu, 05 Oct 2017 20:00:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;旧笔记补档，原来是为 2017-10-06 线下 MAP 活动做的笔记&lt;/p&gt;
&lt;p&gt;2018-08-02 第一版&lt;/p&gt;
&lt;p&gt;2020-08-06 第二版&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!--more--&gt;
&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;为什么要学习 Smalltalk？Smalltalk 是一门历史悠久的语言，虽然如今我们几乎没有机会再去使用它，但它的不少开创性的理念，仍影响了许多现代的编程语言和思想。尤其是如今主流的面向对象语言 C++ 和 Java，它们本身并不是纯粹的、适合教学的「面向对象」语言，导致初学者往往陷入一些细枝末节导致理解困难。而学习 Smalltalk，我们能从语言的演进中更精准地理解一些重要概念的沿革，也可以从打破固化思维，得到一些新的编程灵感。&lt;/p&gt;
&lt;p&gt;如今中文互联网上关于 Smalltalk 的资料相对较少，且大多比较老，或是直接机翻的外文博客。大概三年前我出于个人爱好对 Smalltalk 进行了一些入门了解，并和小伙伴们做了线下分享。这回也是把当时的一些笔记整理后发到网上，算是添砖加瓦吧。&lt;/p&gt;
&lt;p&gt;本文脉络主要参考了 &lt;a href=&quot;http://www.eli.sdsu.edu/courses/spring01/cs635/readingSmalltalk.pdf&quot;&gt;I Can Read C++ and Java But I Can’t Read Smalltalk&lt;/a&gt; 以及 &lt;a href=&quot;http://www.vaikan.com/why-i-love-smalltalk/&quot;&gt;Why I love smalltalk&lt;/a&gt; 。不过并不是照搬，而是加入了一些个人的理解&lt;del&gt;夹带私货&lt;/del&gt;。希望我的引申能够使读者更容易地理解这一有趣的语言。&lt;/p&gt;
&lt;h2&gt;基础语法&lt;/h2&gt;
&lt;p&gt;现代编程语言的语法往往大同小异，但 Smalltalk 和如今的语言语法差距还是不小，这也是大多数人第一眼看到代码觉得难以理解的原因之一（想看到实际的代码例子可以&lt;a href=&quot;https://github.com/gnu-smalltalk/smalltalk/tree/master/examples&quot;&gt;点击这里&lt;/a&gt;）。但虽然写法不同，编程语言的常规要素还是大差不差的，我们先浮光掠影地看一下这些基础语法，便能够读懂大部分的代码内容。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;注释：用双引号包围。 e.g. &lt;code class=&quot;language-text&quot;&gt;&amp;quot;这是注释&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;字符串：用单引号包围。 e.g. &lt;code class=&quot;language-text&quot;&gt;&amp;#39;这是一个字符串&amp;#39;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;单个字符：e.g. &lt;code class=&quot;language-text&quot;&gt;$c&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;符号（Symbol）：e.g. &lt;code class=&quot;language-text&quot;&gt;#thisIsASymbol&lt;/code&gt;
大家也许对符号这个概念比较陌生。简单来说，如果两个符号的值一样，那么它们在内存中也是相同的对象。后面的 Ruby 等语言也继承了这一设计。&lt;/li&gt;
&lt;li&gt;变量声明：e.g. &lt;code class=&quot;language-text&quot;&gt;| a |&lt;/code&gt; ，也可以一次声明多个：&lt;code class=&quot;language-text&quot;&gt;| a b c |&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;赋值语句：e.g. &lt;code class=&quot;language-text&quot;&gt;a := 5&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;相等性与同一性：相等性使用 &lt;code class=&quot;language-text&quot;&gt;=&lt;/code&gt; ，相当于 Java 中的 &lt;code class=&quot;language-text&quot;&gt;equals()&lt;/code&gt; 。同一性使用 &lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt; ，即判断内存地址相同。&lt;/li&gt;
&lt;li&gt;返回语句：&lt;code class=&quot;language-text&quot;&gt;^ a&lt;/code&gt; 即其他语言中的 &lt;code class=&quot;language-text&quot;&gt;return a&lt;/code&gt; 。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;级联：不同于大多数语言，Smalltalk 使用 &lt;code class=&quot;language-text&quot;&gt;.&lt;/code&gt; 表示语句的末尾，而 &lt;code class=&quot;language-text&quot;&gt;;&lt;/code&gt; 用于实现级联的功能。所谓级联，就是指可以连续在同一个对象上调用方法，而不必每次都重复写出这个对象。举个例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;&lt;span class=&quot;token temporary-variables&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;/span&gt; 
p &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; Client &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;    
name&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Jack&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     
age&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     
address&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Earth&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;现代语言中 Dart 就延续了类似的设定。不过我个人倒是觉得这个语法用处不大，毕竟用 Builder 模式也可以解决问题，而无需定义新的语法。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;方法与类&lt;/h2&gt;
&lt;p&gt;来看一个 Smalltalk 中方法定义和调用的例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;&quot;定义一个方法：使物体围绕某个轴旋转一定角度&quot;&lt;/span&gt;
rotateBy&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; angle around&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vector
  &lt;span class=&quot;token temporary-variables&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;/span&gt;
  result &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;省略具体内容&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;result

&lt;span class=&quot;token comment&quot;&gt;&quot;调用这个方法&quot;&lt;/span&gt;
t rotateBy&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; a around&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;相信除了 Objective-C 程序员，大家初看到都会觉得这样的方法签名有点奇怪。不过我们可以基于主流语言的语法，来看看一个方法是以何种逻辑演化成 Smalltalk 的样子的。&lt;/p&gt;
&lt;p&gt;先从我们熟悉的形式开始：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;t-&amp;gt;rotate(a, v);  // In C++
t.rotate(a, v);   // In Java&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;省略掉一些不影响语义的符号：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;t rotate(a, v);    // 省略掉 .
t rotate a, v;     // 省略括号&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后我们发现参数的含义不太清晰，可以给每个参数前面加一个词语来使含义更加精确：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;t rotate by a around v;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;但是这样的话，哪个词语是前缀，哪个是参数就不太能分得清。因此我们给前缀加个冒号来区分：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;t rotate by: a around: v;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后，都这样了，方法名字本身也没必要单列出来，可以直接和参数前缀合并起来，就成了 Smalltalk 现在的样子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;t rotateBy: a around: v; &lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;br&gt;
让我们再来看一个复杂点的例子：
``` smalltalk
a negative | (b between: c and: d)
  ifTrue: [a := c negated]
```
它相当于其他语言中的：
``` java
if (a &lt; 0 || (c &lt; b &amp;&amp; b &lt; d)) {
    a = -c;
}
```
细品这个例子，我们可以看到很多有意思的地方。首先来看这个 `c negated` 。有人会说，直接写个 `-c` 不就完了，为什么要搞这么臃肿。表面看上去，只是写法的不同，但其实它代表着理念的不同。`-c` 代表对 `c` 这个数字做了一次数学运算，而 `c negated` 代表的是在 `c` 这个对象上调用 `negated` 方法，然后用这个方法的返回值去做下一步的操作。
&lt;p&gt;这里体现了 Smalltalk 的核心概念之一：&lt;strong&gt;一切皆是对象&lt;/strong&gt;。对比另一门同样号称一切皆是对象的语言 Java，在 Java 中你永远不可能写出 &lt;code class=&quot;language-text&quot;&gt;5.negated()&lt;/code&gt; 这种代码，而所谓的基本类型、包装类型让多少初学者陷入困惑，又让多少面试官洋洋得意。但在 Smalltalk 里，对象的概念才是真正贯穿始终，保持同一性，也避免了这种困惑。&lt;/p&gt;
&lt;p&gt;其次我们来讨论 Smalltalk 中另一个重要概念：&lt;strong&gt;消息&lt;/strong&gt;。在前文中我们看到了如何调用方法。但在 Smalltalk 中并没有调用方法的概念，而是叫做&lt;strong&gt;给对象发送消息&lt;/strong&gt;。例如 &lt;code class=&quot;language-text&quot;&gt;c negated&lt;/code&gt; 用 Smalltalk 的话说，就是给对象 &lt;code class=&quot;language-text&quot;&gt;c&lt;/code&gt; 发送了一个名为 &lt;code class=&quot;language-text&quot;&gt;negated&lt;/code&gt; 的消息。&lt;/p&gt;
&lt;p&gt;在 Smalltalk 中有三种消息，它们在上面的例子中都能体现：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一元（unary）消息：可以理解为一个无参方法，例如上面的 &lt;code class=&quot;language-text&quot;&gt;negated&lt;/code&gt; 消息。&lt;/li&gt;
&lt;li&gt;二元（binary）消息：就是常用的一组计算符号，比如四则运算符还有上面的 &lt;code class=&quot;language-text&quot;&gt;|&lt;/code&gt; 之类的。不过需要注意的是它的本质还是发送消息而不是直接运算，因此没有运算符优先级的概念。&lt;code class=&quot;language-text&quot;&gt;+&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt; 在 Smalltalk 中的优先级是相等的。&lt;/li&gt;
&lt;li&gt;Keyword 消息：就是普通的有参方法，在 Smalltalk 中就是每个参数以冒号连接来表示，比如上面的 &lt;code class=&quot;language-text&quot;&gt;rotateBy:around:&lt;/code&gt; 还有 &lt;code class=&quot;language-text&quot;&gt;between:and:&lt;/code&gt; 。这样的消息在 Smalltalk 中被称为 &lt;strong&gt;keyword&lt;/strong&gt; 。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有人可能会说，把方法调用说成是发送消息，但运行的效果是一样的，这不是换汤不换药吗？话是这么说，但用于描述的词汇的不同也会带来思维方式的不同。相比于「方法调用」，「发送消息」这个说法会显得更加泛用一些，也可以带来一些更本质的思考。&lt;/p&gt;
&lt;p&gt;举个例子，如果我们调用一个不存在的方法，那自然会报错。但如果给一个对象发送一个它不认识的消息，那非得报错吗？我大不了不处理不就行了。甚至，能不能在遇到这种情况时，有个兜底的逻辑统一处理下？—— Ruby 的 &lt;code class=&quot;language-text&quot;&gt;method_missing&lt;/code&gt; 了解一下。&lt;/p&gt;
&lt;p&gt;再比如说当我们学习面向对象时提到的所谓「三大特征」：继承、封装、多态。继承本质上是面向对象语言中实现代码重用的一种手段，但现在「组合优于继承」早已成为共识。封装是为了隐藏底层或内部的实现细节，也并不是面向对象独有的概念。而多态解释起来最为复杂，我们往往需要定义一个父类，并让两个不同的子类 override 父类的同一个方法，并编写不同的实现，来说明多态性。但是如果用发送消息的思路来解释就很简单了。给两个不同的对象发送同一个消息，这两个对象会做出不同的反应，这不是理所当然的事情吗？压根和类、继承之类的概念没关系。&lt;/p&gt;
&lt;p&gt;对面向对象这一概念的误读影响了很多人。记得几年前见过一个问题，问的是「JavaScript 是一门面向对象的语言吗？」，下面的回答也是众说纷纭。而之所以大家会有争议，是因为 JavaScript 中并没有类的概念，取而代之的是原型的概念，搞的很多人一下子就混乱了。后来 ES6 的标准里增加了 class 的语法糖，我就再也没有见过有人提这个问题了。&lt;/p&gt;
&lt;p&gt;希望读者通过学习 Smalltalk 这门面向对象的鼻祖级语言，理解一切皆是对象以及对象间通过发送消息来通信这两个核心理念，减少一些对面向对象概念的误读。&lt;/p&gt;
&lt;p&gt;在理解了 Smalltalk 的设计理念之后，我们再来看一下怎么声明一个类：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;Object subclass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;#MyClass&lt;/span&gt;      
  instanceVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  classVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  poolDictionaries&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  category&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Pupeno&apos;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;大部分编程语言都会使用 &lt;code class=&quot;language-text&quot;&gt;class&lt;/code&gt; 关键字声明一个类，并用 &lt;code class=&quot;language-text&quot;&gt;extends&lt;/code&gt; 或类似的关键字来声明继承关系。而 Smalltalk 则另辟蹊径。让我们来看看它的逻辑：首先，由于一切皆是对象，因此 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 类也是一个对象；其次，&lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 类可以接收名为 &lt;code class=&quot;language-text&quot;&gt;subclass:&lt;/code&gt; 的消息，创建一个新的对象作为它的子类。无需再引入任何特殊的语法，仅用语言本身的两个核心理念，就十分自洽地把类的概念创建了出来。&lt;/p&gt;
&lt;p&gt;不仅仅是定义类，还有我们常用的分支、循环语句等，在 Smalltalk 中都可以通过发送消息的形式来实现，而无需定义额外的诸如 &lt;code class=&quot;language-text&quot;&gt;if&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;while&lt;/code&gt; 等关键字。这或许就是 Smalltalk 把类似 &lt;code class=&quot;language-text&quot;&gt;subclass:&lt;/code&gt; 之类的带参消息都称作 keyword 的原因。它们完全可以替代其他语言中各种关键字的职能。&lt;/p&gt;
&lt;h2&gt;代码块&lt;/h2&gt;
&lt;p&gt;继续回到上一节的例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;a negative &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b between&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; c and&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  ifTrue&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; c negated&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;关注这个 &lt;code class=&quot;language-text&quot;&gt;[a := c negated]&lt;/code&gt; 。这里由中括号包围的部分，大家或许会以为就像是 C++/Java 里跟在 &lt;code class=&quot;language-text&quot;&gt;if&lt;/code&gt; 语句后面的大括号——对，但不全对。在 Smalltalk 中它被称为代码块，是语言中的一等公民，可以放在一个变量里面，自由地控制它的调用时机，也可以把它像参数一样传递。如果你熟悉 JavaScript 就一定不会感到陌生。做个简单对比：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;&quot;in Smalltalk&quot;&lt;/span&gt;
a &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token block-arguments&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;:x&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;&quot;将一个代码块赋值给 a&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a value&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;&quot;运行这个代码块并传入参数 10&quot;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-javascript line-numbers&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// in Javascript&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其实这就是匿名函数的概念，了解过函数式编程概念的朋友们看了一定不会陌生。函数式编程的理念近年来也重回大众视野，即使是 Java 也在 1.8 中加入了相关的特性。可以看到虽说 Smalltalk 的特点是纯粹的面向对象语言，但论函数式编程的能力也完全不输现代的主流语言们。&lt;/p&gt;
&lt;h2&gt;控制流&lt;/h2&gt;
&lt;p&gt;结合 Smalltalk 对象间发送消息的思想和代码块的能力，我们将变得无所不能。上文中提到 Smalltalk 无需额外的关键字就能实现 &lt;code class=&quot;language-text&quot;&gt;if&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;while&lt;/code&gt; 等的功能。在最后一节中就让我们具体地看一下如何利用这些能力来实现 &lt;code class=&quot;language-text&quot;&gt;if&lt;/code&gt; 的功能吧。这也是我当初学习 Smalltalk 时最喜欢的一个例子。&lt;/p&gt;
&lt;p&gt;首先，我们需要定义出 &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;false&lt;/code&gt; 这两个常量：&lt;/p&gt;
&lt;p&gt;先定义出 &lt;code class=&quot;language-text&quot;&gt;PBoolean&lt;/code&gt; 类，然后将 &lt;code class=&quot;language-text&quot;&gt;PTrue&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;PFalse&lt;/code&gt; 作为它的子类。&lt;code class=&quot;language-text&quot;&gt;PTrue&lt;/code&gt; 类的实例就可以认为是 &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;false&lt;/code&gt; 也是同理。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;Object subclass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;#PBoolean&lt;/span&gt;      
  instanceVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  classVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  poolDictionaries&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  category&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Pupeno&apos;&lt;/span&gt;
PBoolean subclass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;#PTrue&lt;/span&gt;      
  instanceVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  classVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  poolDictionaries&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  category&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Pupeno&apos;&lt;/span&gt;
PBoolean subclass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;#PFalse&lt;/span&gt;      
  instanceVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  classVariableNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  poolDictionaries&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;      
  category&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Pupeno&apos;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其次，我们定义 &lt;code class=&quot;language-text&quot;&gt;ifTrue:else:&lt;/code&gt; 消息。它接受两个代码块作为参数。当 &lt;code class=&quot;language-text&quot;&gt;PTrue&lt;/code&gt; 类的实例接收到消息时，它执行 &lt;code class=&quot;language-text&quot;&gt;ifTrue:&lt;/code&gt; 携带的代码块，忽略 &lt;code class=&quot;language-text&quot;&gt;else:&lt;/code&gt; 携带的代码块。反之亦然。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;&quot;PTrue 中定义&quot;&lt;/span&gt;
ifTrue&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; do else&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; notdo  
  &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; do value
  
&lt;span class=&quot;token comment&quot;&gt;&quot;PFalse 中定义&quot;&lt;/span&gt;
ifTrue&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; notdo else&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; do  
  &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; do value&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再次，我们定义一个 &lt;code class=&quot;language-text&quot;&gt;MyClass&lt;/code&gt; 类，它可以接受 &lt;code class=&quot;language-text&quot;&gt;equals:&lt;/code&gt; 消息判断两个对象是否相等。为了方便起见，我们永远返回 &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt; 。实际情况下可以自行实现其业务逻辑。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;equals&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; other  
  &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; PTrue &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后，我们就可以愉快地使用 if-else 了：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;smalltalk&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-smalltalk line-numbers&quot;&gt;&lt;code class=&quot;language-smalltalk&quot;&gt;m1 &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; MyClass &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
m2 &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; MyClass &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m1 equals&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; m2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ifTrue&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;  
  Transcript show&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;They are equal&apos;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; else&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;  
  Transcript show&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;They are not equal&apos;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;写在最后&lt;/h2&gt;
&lt;p&gt;本文介绍了 Smalltalk 中最为基础的语言规则与设计思想。在它出现的时候，它引领了面向对象、IDE 等等前沿的概念，而即使放到现在，它的语言特性也毫不过时。愿大家都能在了解 Smalltalk 的过程中有所收获。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Update Log 20171005]]></title><description><![CDATA[…]]></description><link>https://maliut.space/p/update-log-20171005/</link><guid isPermaLink="false">https://maliut.space/p/update-log-20171005/</guid><pubDate>Thu, 05 Oct 2017 19:43:00 GMT</pubDate><content:encoded>&lt;p&gt;距离上次更新也快一年了。虽说有篇元编程的文章不过也是坑着，别的文章也是坑着。一年以来也发生了很多事情（主要还是进入职场了吧喂），不过其实一直没有忘记这里，只是自己懒罢了。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;于是趁着这次一时兴起，也对网站做了次大更新。契机应该是多说的倒闭（虽说也是很久之前了），然后网传规定说评论都要实名制，于是要将网站的评论系统迁移到 Disqus 。实际上呢更新了很多东西，在这里记录一下，也算是对自己的一次 restart 和激励好了。&lt;/p&gt;
&lt;p&gt;主要做了三件事：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;网站主题换用 Typescript&lt;/p&gt;
&lt;p&gt;老的主题有些看厌了，选择了很久选中了这个主题，简洁而富有设计感。字体不再是微软雅黑了，依然很舒服。图片会有一个 114% 的放大，很适合图片的展示，甚至想把每篇文章配上一张美美的图。不过这样的话倒是有点像微信公众号了（笑）。&lt;/p&gt;
&lt;p&gt;个人感觉，这个主题放些设计的东西是很漂亮啦，放些严肃的博文倒是感觉有点怪？不过好看就是正义啦。 114% 放大效果用来展示 UML 图倒是有点谜 23333 虽说 class=small-img 就可以取消掉。&lt;/p&gt;
&lt;p&gt;为了配合这个主题没有个人展示的区域，新建了一个 about 页面，不过仍在施工中。另外配置了一下站内的搜索，为了构建成功还升级了一波 node 和 npm ，倒也是挺有趣的。&lt;/p&gt;
&lt;p&gt;此外还对这个主题做了一些魔改：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;略微放大了一下正文和 archive 页的字体。原来的字体实在小了些。&lt;/li&gt;
&lt;li&gt;修改了底部社交网络链接的图标。主要增加了原来没有的 steam 图标，也顺便删了些用不到的。依旧使用 icomoon 的服务。&lt;/li&gt;
&lt;li&gt;修改了头部的 logo ，毕竟是 blog 的名字不得不改。还好主题作者提供了原始的 psd 文件，少了很多工夫。名字变长以后， css 也要做出一定的修改。副作用是移动端上来看显得不太美观，不过先不管了。&lt;/li&gt;
&lt;li&gt;原本使用的 adobe typekit 字体貌似要收费，于是干脆弃用之。 fallback 方案看着也还行， 如果有更好的字体欢迎推荐。同样，更换了字体以后也需要小改 css 。&lt;/li&gt;
&lt;li&gt;对日期格式也做了修改。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;评论系统换用 Disqus 。需要翻墙以后才能看到。&lt;/li&gt;
&lt;li&gt;全站升级 https 。这里参考了&lt;a href=&quot;https://molunerfinn.com/hexo-travisci-https/&quot;&gt;这篇教程&lt;/a&gt;。旧文章里还有几张图片是 http 的，有空最好也做个替换。不过没有大碍，就先放进 TODO List 好了。是不是也抽空做个 favicon 呢？ emmm&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;很惭愧，就做了一些微小的工作，谢谢大家。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 元编程]]></title><description><![CDATA[最近阅读《Ruby 元编程》一书，拍案叫绝，又想到 JavaScript 语言和 Ruby 类似，相当灵活且具有一些元编程的特性，而且最近以及不久的将来都可能需要和 JavaScript 打交道，因此希望对照着这本书，探究些 JavaScript…]]></description><link>https://maliut.space/p/javascript-metaprogramming/</link><guid isPermaLink="false">https://maliut.space/p/javascript-metaprogramming/</guid><pubDate>Fri, 30 Jun 2017 20:51:39 GMT</pubDate><content:encoded>&lt;p&gt;最近阅读《Ruby 元编程》一书，拍案叫绝，又想到 JavaScript 语言和 Ruby 类似，相当灵活且具有一些元编程的特性，而且最近以及不久的将来都可能需要和 JavaScript 打交道，因此希望对照着这本书，探究些 JavaScript 元编程的特性。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1&gt;语言构件&lt;/h1&gt;
&lt;p&gt;元编程是对语言构件的操作，因此为了了解元编程，需要先了解它们语言构件的异同。&lt;/p&gt;
&lt;p&gt;在 Ruby 中，一切都是对象。一个对象则必然属于一个类。一个类是 &lt;code class=&quot;language-text&quot;&gt;Class&lt;/code&gt; 类的对象，而所有的类都是 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 类的子类（严格来说是 &lt;code class=&quot;language-text&quot;&gt;BasicObject&lt;/code&gt;）。可以用一张图来展示：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/80c1264b3ffa9bf98d891b9755130b6a/15ec7/meta1.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.30541871921182%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe3OwlQ//8QAGRAAAQUAAAAAAAAAAAAAAAAAAQIQITFB/9oACAEBAAEFAiYxNP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhABAQEAAAAAAAAAAAAAAAAAQQAg/9oACAEBAAY/Amc//8QAGRAAAwADAAAAAAAAAAAAAAAAAAEREDGR/9oACAEBAAE/IbMpwOA1XK0f/9oADAMBAAIAAwAAABCzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQEAAgMAAAAAAAAAAAAAAAERACEgMVH/2gAIAQEAAT8QE4HqmIXCexpg7FhN8L//2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/80c1264b3ffa9bf98d891b9755130b6a/15ec7/meta1.jpg&quot;
        srcset=&quot;/static/80c1264b3ffa9bf98d891b9755130b6a/efcb5/meta1.jpg 203w,
/static/80c1264b3ffa9bf98d891b9755130b6a/02e66/meta1.jpg 405w,
/static/80c1264b3ffa9bf98d891b9755130b6a/15ec7/meta1.jpg 690w&quot;
        sizes=&quot;(max-width: 690px) 100vw, 690px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在 JavaScript 中，一切依然是对象。但是它并不是基于类和继承构建的，而是基于独特的原型机制。JavaScript 的对象分为普通对象和函数。而函数除了普通调用以外，还可以通过 &lt;code class=&quot;language-text&quot;&gt;new&lt;/code&gt; 关键字调用，生成一个新的对象，而此时这个函数被称为构造函数。从形式上看，就像 Java 之类的用法。而每一个函数都会有一个 &lt;code class=&quot;language-text&quot;&gt;prototype&lt;/code&gt; 属性（除 &lt;code class=&quot;language-text&quot;&gt;Function.prototype&lt;/code&gt;），每一个对象都会有 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt;  属性指向它的 &lt;code class=&quot;language-text&quot;&gt;prototype&lt;/code&gt; 。当访问一个对象的属性时，先在这个对象自身上找，若没有则在 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性上寻找。这就是字面上“原型机制”的意义，即通过同一个构造函数构造的对象，都会表现得像这个构造函数的原型。&lt;/p&gt;
&lt;p&gt;JavaScript 的原型机制很有趣但令人费解。这里也只是蜻蜓点水，详细的解释可以参考网上的各种文章和知乎问答。只是随着 JavaScript 的用途越发广泛，对于适应了主流语言的程序员来说，很难利用它的原型机制构建起可靠的大规模应用，因此不停地有各种将 JavaScript 类化的方案。一种比较常规的做法是，将构造函数作为类，对于各个对象的属性，定义在对象自身上；而对于各个对象共享的方法，定义在类的原型对象上。对于继承，由于类的原型对象也是一个普通的对象，将其 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性指向父类的原型对象，就可以继承父类的方法了。（讲的比较简略，读者可以自己推演下。另外，这并不是完美的做法，关于 JS 的继承衍生出不下五六种方法，感兴趣可以自行搜索）&lt;/p&gt;
&lt;p&gt;面对程序员们的广泛需求，在最新的 es6 标准中引入了 class 语法糖，帮助程序员以他们熟悉的方式来编写代码。 class 的基本原理正是上述的方案（当然，总有各种细节上的注意点，具体请参考 es6 标准的解读）。模仿上面那张图可以得到：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e5734b8d7a9c7f0452a451ed93ef1e15/15ec7/meta2.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 41.87192118226601%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdyAuD//xAAXEAEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAEBAAEFArah/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGRAAAQUAAAAAAAAAAAAAAAAAAAEQITGh/9oACAEBAAY/AqUjW//EABgQAQEBAQEAAAAAAAAAAAAAAAEAIREx/9oACAEBAAE/IXoY8UlNNv/aAAwDAQACAAMAAAAQ8A//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAwEBAQAAAAAAAAAAAAABABExIWHw/9oACAEBAAE/EDM040dhQocxfdh1q8T/2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/e5734b8d7a9c7f0452a451ed93ef1e15/15ec7/meta2.jpg&quot;
        srcset=&quot;/static/e5734b8d7a9c7f0452a451ed93ef1e15/efcb5/meta2.jpg 203w,
/static/e5734b8d7a9c7f0452a451ed93ef1e15/02e66/meta2.jpg 405w,
/static/e5734b8d7a9c7f0452a451ed93ef1e15/15ec7/meta2.jpg 690w&quot;
        sizes=&quot;(max-width: 690px) 100vw, 690px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;首先 JavaScript 中并没有和 Ruby 意义类似的 Module。其次，Function 在很大程度上类似其他语言的 Class 概念。再次，我没有在图中列出 superclass 关系。如果按照 es6 的 extends 关键字，那么 superclass 一定指代正确的父类，而对于图中这三个顶层的类，若按照上文的逻辑来分析，则会显得有些奇怪。&lt;/p&gt;
&lt;p&gt;姑且称图中的 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;Function&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;MyClass&lt;/code&gt; 是顶层类。按照上文逻辑分析它们的 superclass，则都指向 &lt;code class=&quot;language-text&quot;&gt;Function.prototype&lt;/code&gt;，这是一个函数对象。而它的 superclass 指向 &lt;code class=&quot;language-text&quot;&gt;Object.prototype&lt;/code&gt;，这是一个普通对象。尽管一个普通对象不再是一个类了，但你仍然可以找到它的 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性指向 null。在网上也能找到继承这三个奇怪的东西的分析。扯得有点远了。由于我们希望对程序员隐藏 JavaScript 的原型机制，我个人并不希望将 &lt;code class=&quot;language-text&quot;&gt;Function.prototype&lt;/code&gt; 视作所有类的父类。尽管如此，你依然可以在 &lt;code class=&quot;language-text&quot;&gt;Function.prototype&lt;/code&gt; 中定义所有函数对象可以访问的属性/方法，在 &lt;code class=&quot;language-text&quot;&gt;Object.prototype&lt;/code&gt; 中定义所有对象可以访问的属性/方法。&lt;/p&gt;
&lt;h1&gt;元编程&lt;/h1&gt;
&lt;p&gt;在上文中，我们实际上已经完成了第一步：将 JavaScript 类化。接下来，不妨按照《Ruby 元编程》中所列出的各种“法术”，寻求在 JavaScript 中的实现方法。&lt;/p&gt;
&lt;h2&gt;内省&lt;/h2&gt;
&lt;p&gt;内省使对象可以在运行时查询关于自己的一些信息，例如对象的类，类的父类，对象拥有哪些属性和方法等等。我们知道 JavaScript 中的类就是一个对象的构造函数，正好 JavaScript 提供了 &lt;code class=&quot;language-text&quot;&gt;obj.constructor&lt;/code&gt; 属性来查询对象的构造函数。得到父类同样简单，根据继承的原理，一个类的父类正是这个类的原型的原型所在的类，即 &lt;code class=&quot;language-text&quot;&gt;class.prototype.__proto__.constuctor&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;至于对象身上的属性和方法， es6 提供了 Reflect 类来查询，其中很多方法来自于原先的 Object 类。将类命名为 Reflect 更好地体现了“反射”这一意图。&lt;/p&gt;
&lt;h2&gt;动态派发&lt;/h2&gt;
&lt;p&gt;调用一个对象的方法，实际上是向这个对象发送一条消息。基于这个思想，Ruby 中可以使用 &lt;code class=&quot;language-text&quot;&gt;obj.send(&amp;quot;method_name&amp;quot;, args)&lt;/code&gt;，动态地调用一个方法。方法名可以使用字符串拼装出来，因此大大提高了代码的灵活性。而在 JavaScript 中，方法不过是对象的一个函数属性，而属性本身也可以用字符串表示，也就是说，动态派发在 JavaScript 的设计中，并不是什么高级的用法，仅仅是一种再自然不过的语言特性罢了。在 Javascript 中上述代码等价于 &lt;code class=&quot;language-text&quot;&gt;obj[&amp;quot;method_name&amp;quot;]()&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;作用域绑定、define/delete、eval 和 new Function&lt;/p&gt;
&lt;p&gt;不能做的要素：类宏&lt;/p&gt;
&lt;p&gt;proxy能做的：methodmissing&lt;/p&gt;
&lt;h1&gt;一些感想&lt;/h1&gt;</content:encoded></item><item><title><![CDATA[Awesome Soccer - Rocking Soccer 游戏插件]]></title><description><![CDATA[Awesome Soccer 是为 Rocking Soccer 提供的 chrome 插件，为 chrome 用户在游戏时提供更好的体验。 你可以从此处获取插件并查看使用方法。 Rocking Soccer…]]></description><link>https://maliut.space/p/awesome-soccer/</link><guid isPermaLink="false">https://maliut.space/p/awesome-soccer/</guid><pubDate>Sat, 13 May 2017 20:15:00 GMT</pubDate><content:encoded>&lt;p&gt;Awesome Soccer 是为 &lt;a href=&quot;https://rockingsoccer.com/zh/soccer&quot;&gt;Rocking Soccer&lt;/a&gt; 提供的 chrome 插件，为 chrome 用户在游戏时提供更好的体验。&lt;/p&gt;
&lt;p&gt;你可以&lt;a href=&quot;https://github.com/maliut/awesome-soccer&quot;&gt;从此处获取插件并查看使用方法&lt;/a&gt;。&lt;/p&gt;
&lt;!--more--&gt;
&lt;br&gt;
&lt;p&gt;Rocking Soccer 是一款国外的足球经理网页游戏。相比于网络上形形色色的足球经理的游戏，它一方面比较良心，不需要氪金变强，而是靠长期的努力养成变强；另一方面，它的整个游戏系统也较为简单，无需投入很大的时间和精力去研究，适合休闲游玩。&lt;/p&gt;
&lt;p&gt;有段时间里我和群友们纷纷入坑了这个游戏，而游戏需要一些数据分析辅助决策以及优化体验，因此诞生了这个插件。&lt;/p&gt;
&lt;p&gt;在这个插件之前，还有一个 rshelper 插件，提供了球员经验分值计算的核心功能，对球员的培养选择很有帮助。但是当我们想要更多的功能时，却发现原插件的代码也比较一言难尽（也许程序员看别人的代码都是这么想的吧，看自己以前的代码也是一样的（笑））。既然如此，那就自己写一个吧——于是这个插件就诞生了。&lt;/p&gt;
&lt;p&gt;插件目前主要提供了 3 个功能：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;球员经验评分和未来经验、主属性预测。这部分基于 rshelper 插件。&lt;/li&gt;
&lt;li&gt;多货币显示。鼠标移到价格上时会显示 RSD 、日元、人民币三种价格。这是因为群友们分布在各个不同的国家，看到的价格都有所不同，需要有个统一的单位进行交流。&lt;/li&gt;
&lt;li&gt;本地表格排序。在球员界面对各个属性排序时无需刷新网页，忍受很慢的速度。相当于把服务端排序改成了客户端排序。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;虽然目前的功能还不是很多，但从开发理念上，我们希望一开始就给项目定下一个良好的框架，即对游戏中的球员、建筑等各个概念进行建模，使用面向对象的思想组织代码，而不是过程式一把梭，从而在未来增加和修改功能时能够有良好的维护性与可扩展性。&lt;/p&gt;
&lt;h2&gt;手机版&lt;/h2&gt;
&lt;p&gt;考虑到如今大部分时间大家都在手机上玩游戏了，而 chrome 插件是没法在手机上使用的，因此也萌生了手机版 Awesome Soccer 的想法。&lt;/p&gt;
&lt;p&gt;从技术上来说有两种实现方案：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;套壳浏览器：整个应用就是一个 WebView，在加载 Rocking Soccer 的网页后注入 JavaScript 代码，实现与浏览器插件同样的功能。优点是开发简单，缺点是体验较差，毕竟 Rocking Soccer 老掉牙的页面根本不支持手机展示，在手机上操作十分蛋疼。&lt;/li&gt;
&lt;li&gt;Headless 模式：即我们在手机上重新实现整个游戏的界面，而需要交互的部分就通过发请求的方式去实现。这样做的用户体验是比较好的，缺点是工作量较大，且需要一定预研。而且有些功能例如比赛直播等应该还是要跳到网页去。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;不过无论哪种模式，内在的逻辑应该都是可以与网页端的插件共用的。这也是使用面向对象进行逻辑层开发的好处。&lt;/p&gt;
&lt;p&gt;目前已经使用第一种方案做了 Android 版的应用出来，不过代码已经不可考。&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;当然，随着大家逐渐弃坑，这个项目也不再维护了。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[关于密码管理的一个想法]]></title><description><![CDATA[…]]></description><link>https://maliut.space/p/thought-for-password-management/</link><guid isPermaLink="false">https://maliut.space/p/thought-for-password-management/</guid><pubDate>Mon, 19 Sep 2016 22:26:49 GMT</pubDate><content:encoded>&lt;p&gt;密码的重要性毋庸多言，尤其是在当今人们越来越离不开互联网的情况之下。最近各种密码泄露事件层出不穷，社工技术也是比想象中厉害很多。虽说密码的原则，例如不要重复啊，要复杂啊，大家都知道，然而真正能做到的人也是少数，大多数仍然是偷懒几个密码走天下。然而这终究不是长久之计，因此一些密码管理工具诸如 1Password， LastPass 等开始流行起来。这类工具一般的做法是需要你设定一个主密码，进入后就可以查看各个网站的单独密码，也可以为你生成比较安全的密码，这样比较灵活。但它们仍然需要在本地保存各种密码（或许是用主密码作为 key 的对称加密？），并且会把这些信息加密后保存在网上。然而需要保存密码本身加之安全性全系于主密码一身，仍让人对其可靠性产生担忧。于是突发奇想，能否设计一套密码管理机制，使得我们并不需要保存每个密码，而是在需要时由其实时计算而出。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1&gt;初步设想&lt;/h1&gt;
&lt;p&gt;在这个机制中，用户输入一个自定义 key，得到一个输出，即计算出来的密码。密码计算出后可以自动复制到剪贴板，用户不需要知道密码的具体内容。&lt;/p&gt;
&lt;p&gt;假设存在这样一个系统，那么它需要保证：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;针对不同的网站，需要生成不同的密码。这个可以通过自定义 key 来保证。&lt;/li&gt;
&lt;li&gt;对于同样的自定义 key，不同的用户得到的密码应当不同。否则 key 实质就成了密码。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这个机制不需要联网，也不需要本地存储各种密码。key 实质就是一个助记符，用户需要将它记在心中，但相比于各种复杂密码，记忆的难度已经大大降低。此外，它不应该被除主人外的其他人使用，否则其他人只要知道了主人的各个 key，也就相当于知道了密码。为此我们仍然需要一个主密码。不过和传统意义上的主密码不同，由于我们的机制并不记录密码或联网，我们并不能验证主密码的正确性，而是将主密码和自定义 key 共同组成算法的输入。这样他人即使知道了主人的 key，但因为不知道主密码，得到的输出也将是错误的。为此，虽然不是必需（因为主密码只是参与运算的一个普通字符串），我们仍然建议主密码足够复杂（例如包含数字、大小写字母、特殊符号且足够长）以至于难以猜测（因为自定义 key 为了方便记忆必然是容易被猜到的）。&lt;/p&gt;
&lt;p&gt;让我们回到上文的第二点，因为同样的输入必然需要得到同样的输出，而算法本身并不能改变，除非你对每个用户都特殊定制一个软件。也不能使用什么元编程之类的手段，因为若不直接编译好，就等于公开了你的计算算法从而增加被破解的可能性。最简单的方法便是在用户第一次使用时产生一个随机数或者 UUID 加入输入。不过加入了主密码以后也就相当于解决了这个问题。然而主密码是用户自己选取的，仍然存在重复的可能，因此保险起见仍然可以加入随机数或者 UUID，将重复概率降低到约等于 0。&lt;/p&gt;
&lt;h1&gt;如何更换单个密码&lt;/h1&gt;
&lt;p&gt;更换单个密码是一个常用功能，假如怀疑某个密码遭遇到泄露可以方便地重置它而不影响其他密码。目前我们使用主密码 + key + 一次生成的随机数来唯一确定一个密码。最简单的想法是用户修改自己的 key 就行。然而 key 作为助记符，若是频繁修改，也会给用户带来记忆上的困难。而修改主密码和随机数即意味着所有的密码都要进行修改，这显然是无法接受的。照道理应该通过修改随机数实现，但为了不影响其他密码，我们必须建立每个 key 和随机数之间的映射关系，即需要保存这些 key 和对应的随机数，而这却恰恰是设计之初想要极力避免的。&lt;/p&gt;
&lt;p&gt;为此需要设计一个妥协的方案，目前的设想如下：生成一个随机数的表，这不得不保存为文件。另外将 key 和对应的随机数组合，通过非对称加密后保存为文件（可以进一步通过改变组合方式、加 salt 等增加安全性）。这样即使文件被他人得到也无法破译出 key 及对应关系。软件工作时也无从得知，而是需要穷举随机数表，加密后比对，才能确定该 key 对应了哪个随机数。此外，对于大多数密码而言，它们永远不会变化，即不需要使用新的随机数，也就不需要保存在文件中。对于一些特定的重要密码，用户也可以选择修改自己记忆中的 key 值，通过增加记忆成本来降低风险。&lt;/p&gt;
&lt;h1&gt;多端的数据一致性&lt;/h1&gt;
&lt;p&gt;需要输入密码的场合，电脑端仍是大头，然而手机端也越来越需要了，为此需要开发手机上能用的版本。移植工作简单，但对于这样一个非联网的密码管理工具，如何才能保证电脑上和手机上得到的密码是一样的？自然主密码， key 和算法都是一样的，那么只需要保证随机数表相同。然而你不能要求用户来同步整个随机数表。容易想到，我们只需要系统生成一个 appkey，再由算法利用这个 appkey 生成整个随机数表即可。用户在一个新的端第一次使用时需要输入这个 appkey，这样问题解决。&lt;/p&gt;
&lt;h1&gt;软件升级&lt;/h1&gt;
&lt;p&gt;理想状态下只要做出来就永远不会改变，然而信息技术的发展日新月异，也不能预测这个工具中使用的各种算法等是否需要更改。一旦更改则用户的全部密码都需要改变，而用户很难记起自己通过这一工具“保存”了多少密码。在此提个可行的解决方法：使用时双开前后两个版本，先用新版本得到的密码尝试，若错误则说明该网站的密码依然需要通过旧版本得到，此时用户应当及时修改密码为新版本。长此以往所有密码均被修改，版本过渡完成。&lt;/p&gt;
&lt;h1&gt;总结&lt;/h1&gt;
&lt;p&gt;相比于目前常用的密码管理工具，本工具不联网，不保存，减少密码本身被简单泄露的危险。但也丢失了灵活性，即用户不能保存自定义的密码，而是只能用计算出来的密码。不过一般来说这都是更加安全的，既然选择使用密码管理工具，就应该有这样的安全意识。&lt;/p&gt;
&lt;p&gt;这套机制中，用户需要记忆自己的主密码和各网站的 key。工具则需要提供一个随机的 appkey，以及三套算法：通过 appkey 可重复地生成随机数表、非对称加密验证 key 和随机数的对应关系、通过主密码 + key + 随机数可重复地计算出密码。&lt;/p&gt;
&lt;p&gt;那么什么时候能做出来呢？待续……&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Unity 使用多个 Android 插件与二次开发]]></title><description><![CDATA[利用 Unity 开发 Android 应用时往往需要调用 Android 原生开发的方法，或是导出 Android 工程进行二次开发。单独一个问题很容易就能在互联网上找到答案，但当需要导入多个 Jar 包（ Android 原生方法通过打成 Jar 包在 Unity…]]></description><link>https://maliut.space/p/unity-with-multiply-jars/</link><guid isPermaLink="false">https://maliut.space/p/unity-with-multiply-jars/</guid><pubDate>Wed, 16 Mar 2016 19:51:05 GMT</pubDate><content:encoded>&lt;blockquote class=&quot;warning&quot;&gt;本文的写作时间距今已久，其中涉及到的 API 可能发生了较大的变化，且 Unity 集成 Vuforia 已有了官方支持。本文的解决方案可能不再适合您当前遇到的问题，请酌情谨慎参考。&lt;/blockquote&gt;
&lt;hr&gt;
&lt;p&gt;利用 Unity 开发 Android 应用时往往需要调用 Android 原生开发的方法，或是导出 Android 工程进行二次开发。单独一个问题很容易就能在互联网上找到答案，但当需要导入多个 Jar 包（ Android 原生方法通过打成 Jar 包在 Unity 工程中使用）、又需要导出 Android 工程继续开发时，就有可能遇到问题了。&lt;/p&gt;
&lt;!--more--&gt;
&lt;blockquote&gt;
&lt;p&gt;本文记录了解决过程。想看结论及解决方案可以直接拉到最后。&lt;/p&gt;
&lt;p&gt;本文所述的解决方案不具有普适性&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1&gt;场景&lt;/h1&gt;
&lt;p&gt;场景来源于一个实际面对的任务，即在「使用高通 Vuforia 的 Unity 工程」中「调用 Android 方法（即引入新的 Jar 包）」，并「接入 KTPlay 的 SDK 」。由于 Vuforia 的 Unity SDK 本身就引入了 Jar 包，若引入新的 Jar 包，就会牵涉到如何修改共同的 XML 文件，如何处理和已有 Jar 包的关系等问题。而后者 KTPlay 的接入需要 Unity 工程导出 Android 工程继续开发。这本来并不会有问题，但事实上 Unity 使用了 Jar 包后进行二次开发的确会出现一些变化。当然这也是因为我半吊子水平，对 Unity 和 Android 开发都不够了解。不过总会有这样的时候，人也是这样过来的，网上难以轻易找到的东西，总归做个记录有利无弊。&lt;/p&gt;
&lt;h1&gt;使用第二个 Android 插件&lt;/h1&gt;
&lt;p&gt;Unity 调用单个 Android 插件的方法其实网上都找得到，主要的思路是新建一个 Android 工程，在里面编写好方法后，打成 Jar 包放入 Unity 的插件文件夹中。然后利用 Unity 中的 AndroidJavaClass 来调用 Android 工程中的方法。但是在 Vuforia 工程中本身已经用到了 Android 插件，如果把新的内容覆盖进去，别的倒是没什么，但是 AndroidManifest.xml 文件却会被覆盖掉。这个文件是对 Android 应用很关键的配置文件， Vuforia 插件显然也用到了这个文件，将其覆盖掉明显是不行的。&lt;/p&gt;
&lt;p&gt;于是我开始搜索网上的解决方案。一开始搜索的是如何在 Unity 中导入2个 Jar 包，但根本无法找到答案。倒是很多此类问题中提到了他们要解决的也是关于 Vuforia 工程导入 jar 包的问题，这启发了我，最后在 Vuforia 的官网文档中找到了官方撰写的教程。这对我也是一个启示，搜索问题时要先 specific 再 general 。&lt;/p&gt;
&lt;p&gt;我的解决参考了 &lt;a href=&quot;https://developer.vuforia.com/library/articles/Solution/How-To-Use-Android-Plugins-in-Unity-Apps&quot;&gt;官方文档&lt;/a&gt; 和 &lt;a href=&quot;http://blog.csdn.net/xv_ly15/article/details/9314199/&quot;&gt;这篇文章&lt;/a&gt; （讲的是通常调用 1 个 Jar 包的情况）。两篇文章都挺好，就是由于作者和读者的思路问题在细节上理解容易出偏差，我是综合了两篇文章并自己试验后最终成功的。&lt;/p&gt;
&lt;p&gt;具体可以顺着官方文档来，首先新建工程，但是注意&lt;strong&gt;新建工程的包名要与 Unity 工程导出 Android 应用时使用的包名一致&lt;/strong&gt;，这会省很多麻烦。官方文档似乎没说明这一点。然后导入 Unity 和 Vuforia 相关的 Jar 包。注意 classes.jar 随 Unity 版本的变化，放置的位置也有区别，需要自己找一找。编写完以后需要导出 Jar 包，在工程属性中勾选 isLibrary 然后可在工程目录中找到自动生成的 Jar 包。然后把 Jar 包复制到 Unity 插件目录下，并修改  Unity 目录下 AndroidManifest.xml 文件中的主 Activity 名。（不能直接覆盖这个xml文件，因为 Vuforia 在里面也有些配置）。以上两步官方文档都说的很好，不过它用的是一个简单的 toast 的例子。实际我们开发时往往还会用到一些第三方的 Jar 包、 so 文件等，因此也要把这些文件也放入 Unity 插件目录对应位置下；使用这些东西导致的  AndroidManifest.xml 文件修改（如增加权限等）也需要在 Unity 目录下 AndroidManifest.xml 文件中对应修改。如果有素材变动啥的最好把 res 文件夹也复制过去。这里官方文档就说把 Jar 包放过去，可能是觉得这些都是常识性问题吧，我说的就比较细了，新手说不定觉得那些第三方的 Jar 和 so 都打包进自己的 Jar 了呢？（虽说看文件大小还是很容易判断的）&lt;/p&gt;
&lt;p&gt;顺便一提，如果你自己的 Jar 用到了第三方的 Jar 包，那么做完导入 Unity 后那些第三方 Jar 包的地位和 Vuforia 的两个 Jjar 包目测是平等的。而我们在开发自己的 Jar 时并没有用到 Vuforia 那两个 Jar 包的东西，是不是说明如果我们不用 Vuforia 那两个 Jar 包里的东西，不导入那两个 Jar 包也没事？待测试。&lt;/p&gt;
&lt;p&gt;还有，至于我说为什么没有普适性，因为我们是用自己的包名、主方法名取代了 AndroidManifest.xml 原来的相应内容，看来 Vuforia 的两个 Jar 包并不需要这两个东西。因此这两个 Jar 包和我们自己写的 Jar 包有很大的区别。虽然如此，应该不会有个第三方 Jar 包需要让你修改这些才能加进去吧……&lt;/p&gt;
&lt;h1&gt;加入插件后的二次开发&lt;/h1&gt;
&lt;p&gt;其实就是关于 KTPlay ，这个游戏内社区总的来说挺好用的。接入 Unity 的过程比较奇葩，首先要在 Unity 中做相关的配置，然后还要导出 Android 工程，在主 Activity 的 onStart 等一系列方法中加入相关的代码。其实也很简单，我试验的时候也很顺利，以至于当我把导入插件后的实际项目再拿去加入 KTPlay 却发现毫无反应时，大脑简直一片空白，连大概的可能性都猜不出。后来还是顿悟了，因为测试后发现不是 KTPlay 有问题，而是二次开发加入的相关代码根本没有被执行，然后就想到了，当之前加入 Android 插件后，这个应用的主方法已经不是那个 UnityActivity 了，而是自己编写的插件中的那个 Activity （由于之前更改了 AndroidManifest.xml ）。于是问题解决。&lt;/p&gt;
&lt;p&gt;当然这样就十分有趣了，因为我编写插件在前，引入 KTPlay 在后，也就是说没引入 KTPlay 之前就加入了它的相关代码。当然这并不是一件坏事，事实上反而是一件好事，因为这样你可以直接在 Unity 中打包 apk 了，而不用再使用蛋疼的 Eclipse 。KTPlay 可以考虑下这样的用法啊。&lt;/p&gt;
&lt;h1&gt;总结&lt;/h1&gt;
&lt;p&gt;对于此类需要在 Unity 中使用多个 Android 插件，并进行二次开发的问题，需要注意：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;新建 Android 插件的工程时，确保包名与 Unity 导出 Android 的包名一致。&lt;/li&gt;
&lt;li&gt;导入 classes.jar 和其他 Unity 插件工程下的 Jar 包和 so 文件。&lt;/li&gt;
&lt;li&gt;事先观察需要二次开发的内容，把二次开发需要在主 Activity 中改动的地方事先改动好（主 Activity 就是你现在写的插件的 Activity）。&lt;/li&gt;
&lt;li&gt;工程属性下勾选 isLibrary 导出 Jar 包。&lt;/li&gt;
&lt;li&gt;把导出的 Jar 包和你开发插件过程中另外用到的第三方 jar 包和 so 文件复制到 Unity 工程的相关目录下。 res 文件夹也复制过去。&lt;/li&gt;
&lt;li&gt;相应修改 AndroidManifest.xml （而不是粗暴覆盖原有的文件）。&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[Hello World Again and Again]]></title><description><![CDATA[终于在 Github…]]></description><link>https://maliut.space/p/hello-world-again-and-again/</link><guid isPermaLink="false">https://maliut.space/p/hello-world-again-and-again/</guid><pubDate>Wed, 09 Mar 2016 00:01:04 GMT</pubDate><content:encoded>&lt;p&gt;终于在 Github 上开了静态博客。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;从知乎上看到然而找不到原文的大大曾经说过写博客的三个阶段，正好和我的经历完全吻合。曾经的百度空间，得益于百度，还有不少关键词排名靠前的文章，虽然现在看来都是些小学生烂文章罢了。其实还是挺怀念当时的心态，敢写，有自信，甚至将其当作一件很自豪的事情。虽然都是些垃圾文，然而随着百度空间的灰飞烟灭，现在就是想看也看不到了。还有那个益达，也许要不是现在在这里写这个，我已经将它永久遗忘了吧，还有我甚至也是有网友的人[破涕为笑]……别的零零碎碎也有不少吧，在当时那个博客流行的时代，随便啥网站都愿意配一个博客系统来留住用户。那个时候微博还没有被人听说，腾讯微博还叫滔滔，轻博客更是以后的事。而现在点点网早已时常抽风，只有宿舍二楼开水房墙上的告示贴纸还诉说着它曾经的辉煌。只剩下 Lofter 。&lt;/p&gt;
&lt;p&gt;后来就是自搭博客的历程了，这得从我的建站经历说起。始于小学毕业的那个暑假从 5d6d 开始，后来的 Edicy ， Weebly ， Tap.cn ……还有好多我记不起来的名字，其中好多也都消失在了历史的长河里。虽然这些本质上和提供博客的服务并无太大不同，但对于习惯了博客的我，能建立一个论坛，一个主站，还是一个非常令人激动的事情。我也忘记了我是怎么进入虚拟主机的这个大坑，很早在 6R 的某个帖子下听说了 kilu.de 并觉得以后会有用便加入了收藏夹，而又在好久以后不明但又确定地觉得它就是我所听说的那个“虚拟主机”。然后看教程，搭 Discuz! ，虽然一片陌生却也尝试成功了，渐渐开始熟悉相关的流程和概念。&lt;/p&gt;
&lt;p&gt;提到了 kilu.de 就又不得不说到 clistock 。虽然在 kilu.de 上做了很多尝试但 clistock 无疑是付出心血最大的一个，从搭建到选模板选图标选插件设置版块主站运营搞校网和贴吧然后还把走廊电脑的主页都设了一遍，虽然如今只剩下了 favicon.ico ，还有 QQ 每周一封啥都没有的数据分析邮件。还是要感谢当时的环保社还有后来的文学社我也不知道我怎么抱到的大腿总之作为圈外人士却也经历了很多事情。当时的自己还是 too naive 觉得能找到免费的资源是一件很了不起的事情然后用着那么慢的服务器，晦涩的域名，还有进入时的大幅广告，包括后来甚至被成为了危险网站。不知道那些素不相识的同学们为了提交一个三行诗还要来到这种可疑的地方忍受麻烦的服务的时候是一个什么心态，是新奇冲淡了疑惑还是心里鄙视了我好几十遍呢。不过对我来说那大概也是一段梦一般的时间吧，看着我熟悉的不熟悉的那么多人能够用上我的服务。不过有些事情，从一开始就是注定的，就像我即使用上了最好的服务也无法阻止论坛等在互联网上的整体式微。我的努力只不过是那个从 ASP 末期随各种论坛走来的一点情怀。想来这种情怀，从小六起，到了大学也没有消散。&lt;/p&gt;
&lt;p&gt;的确，有些事情，从开始就注定了。比如遇到 6R ，比如进入 xs 的随机座位，比如决定推广 MAP ，比如我接触到独立博客。不知道什么时候接触的概念，但注定了以后迟早会成为其中的一员。实话说我根本不知道独立博客有什么用，明明基本功能都是那样，都能绑独立域名，论自由度，百度空间也能自己写 CSS ，即使独立博客你可以改源文件，大多数时候我们也只是选择一个既定的主题，不会自己费力修改。相反，走独立意味着你要选择一家靠谱的服务提供商，自己上传安装程序，设定数据库，即使静态空间也要搭各种环境，处理各种匪夷所思的问题。免费空间倒的倒，难用的更加难用，我最终还是意识到没有免费的午餐。这个时候付出的还有金钱成本。我想这只能用独立精神来解释。不像各种博客服务为了留住用户努力把自己变成一个大社区，独立博客让自己成为茫茫互联网海洋中的一个孤岛，而你就是这个孤岛完全的主人，即使是孤岛，即使岛很小。（当然也有些独立博客是朝着扩大知名度建立自己品牌的方向去努力运营的，那其实就是一个普通网站了）&lt;/p&gt;
&lt;p&gt;真正开始认真建站也是在大学了，用的华夏名网的香港虚机+独立域名，各方面还是差强人意的。后来出了阿里云的云翼计划，说来也有趣，明明是针对学生的优惠计划，我却是在 RS 的广告里看到的。云翼计划实在是太优惠，价钱比虚机便宜，容量、带宽、网速却又远高。于是迅速买下一年。云主机其实就是个远程的只有命令行的 Linux ，自由度是大不少，适合经验人士。我嘛只能靠他给的自带 PHP+MySQL 环境加之少的可怜的 Linux 知识勉强搭上网站。懒得备案，因此也任由域名过期，通过 IP 访问。反正也写得不多。如果一切顺利的话我会就这样用到大学毕业然后再考虑搬去哪里，然而就在最近当我访问的时候却发现无法访问了。进后台看看，先跳出来的却是让我购买云盾服务的广告。然后我就看到主机被攻击。强行重启之后，数据库明显损坏了，我作为管理员也无法登录。真的很想以最大的恶意去揣测阿里云。总之寻找下一个落脚之处就显得非常迫切了，然后这段时间频繁看到 Hexo ，就尝试了。其实以前也不是没有过搞静态的想法，不过那时没搞成功 Jekyll ，就搁置了。这大概也算是机缘巧合吧，总之现在我还是很喜欢这个 blog 的，小规模的用静态也是正好，除了没有用户管理都能够用。&lt;/p&gt;
&lt;p&gt;行文万里，不知所云，看到这里的都是真爱。也是突然想到，时下流行的人工智能、深度学习等等，将大数据用于分析以形成总体意义上的统计学规律。然而对于我们个体而言，我们毕竟独一无二，我们也有必要独一无二。&lt;/p&gt;
&lt;p&gt;愿独立精神长存。&lt;/p&gt;
&lt;p&gt;“好巧，我也不讨厌这样的自己。”&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CSAPP:Bufbomb]]></title><description><![CDATA[from wordpress, 放 tietuku 的图都挂光了 关于 CSAPP 的各个经典的 Lab ，网上的解答已是一搜一大堆。本文的目的是记录自己亲身做完后的一些感悟，不过多探讨具体的做法，而是归纳一些平时看书不太注意的，而需要在 Lab 里理解透彻的地方，和做 Lab…]]></description><link>https://maliut.space/p/csapp-bufbomb/</link><guid isPermaLink="false">https://maliut.space/p/csapp-bufbomb/</guid><pubDate>Sat, 01 Aug 2015 00:00:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;from wordpress, 放 tietuku 的图都挂光了&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;关于 CSAPP 的各个经典的 Lab ，网上的解答已是一搜一大堆。本文的目的是记录自己亲身做完后的一些感悟，不过多探讨具体的做法，而是归纳一些平时看书不太注意的，而需要在 Lab 里理解透彻的地方，和做 Lab 时需要默认知道的一些信息和经验，以便少走弯路。在此基础上略谈各题做法。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;我的解题主要参考了&lt;a href=&quot;http://blog.sina.com.cn/s/blog_65eb367a0101exfa.html&quot;&gt;这篇文章&lt;/a&gt;，尽管网上有许多解答，但这篇图文并茂的博文给我带来的帮助显然是最大的，此外还有&lt;a href=&quot;http://blog.youlingman.info/csapp-bufbomb-lab-solve/&quot;&gt;这篇文章&lt;/a&gt;，通过对比两篇文章，我才能更好理解最后一题。在此表示感谢。&lt;/p&gt;
&lt;p&gt;在我看来，这个 Lab 的主要目的在于，使你对栈帧的结构、调用过程中的寄存器变化（&lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt;,&lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt;,&lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt;）有更加深刻的了解。在这个 Lab 里你必须要对 &lt;code class=&quot;language-text&quot;&gt;leave&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 指令的具体操作有了解，而不能仅仅像上一个 Lab:Binarybomb 那样，仅仅将它们抽象为回到调用过程前的状态。因为通过缓冲区溢出，你已经破坏了原来的栈帧结构。&lt;/p&gt;
&lt;p&gt;关于解题，你需要知道的一些知识：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;栈帧结构&lt;/p&gt;
&lt;p&gt;当调用一个过程后，栈帧结构如下所示&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;......
传入参数2
传入参数1
返回地址
旧的 %ebp
......
栈顶&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其中 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 指向旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; ， &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 指向栈顶&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;本 Lab 中输入字符串的保存位置和合法的字符串最大长度&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 函数的代码如下（图挂）&lt;/p&gt;
&lt;p&gt;其中调用了 &lt;code class=&quot;language-text&quot;&gt;Gets&lt;/code&gt; 读取输入，但这个大概和系统函数差不多，就不深究了。观察之前系统为这个函数分配了 0x38 的空间，但这并不代表字符串允许长度为 0x38 。下一行的 &lt;code class=&quot;language-text&quot;&gt;lea&lt;/code&gt; 指令计算了 &lt;code class=&quot;language-text&quot;&gt;%ebp-0x28&lt;/code&gt; 的值。这里先验地说明，这个值，即旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 往下 0x28 的空间里，才是存储字符串的地方。如果字符串超出了这个限制，则会继续向上覆盖旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; ，返回地址，etc。
同时这也说明真正合法字符串的长度并不是 PDF 给的代码中规定的值。 0x28 即十进制 40 说明最多 40 个字节，那么 41-44 字节就覆盖了旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; ， 45-48 字节覆盖了返回地址。最后一题的 &lt;code class=&quot;language-text&quot;&gt;getbufn&lt;/code&gt; 也是同理（开始做的时候直接以为是 512 但其实是 520 所以被坑死）。
那么如何查看输入的字符串？以使用 GDB 为例，在 &lt;code class=&quot;language-text&quot;&gt;0x804940d&lt;/code&gt; 设下断点，在此处可以查看 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 的值，其减去 0x28 即字符串的起始地址。也可直接查看 &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; ，先验认为从 &lt;code class=&quot;language-text&quot;&gt;Get&lt;/code&gt; 返回后， &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; 即保存了返回值的地址。查看时要注意代码为&lt;code class=&quot;language-text&quot;&gt;p (char *) %eax&lt;/code&gt;，因为 &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; 的值已经是字符串的地址，不能再在 &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; 前加 &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt; 。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;leave&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 指令&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 指令前必须要 &lt;code class=&quot;language-text&quot;&gt;leave&lt;/code&gt; ，否则无法完全恢复调用前的状态，但也可以自己手动模拟这两个指令的效果。
&lt;code class=&quot;language-text&quot;&gt;leave&lt;/code&gt; 指令等价于：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-assembly line-numbers&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;movl %ebp, %esp  # %esp 指向 %ebp 指向的位置，即旧的 %ebp
                # 由于 %esp 就是栈顶指针， pop 和 push 都相对与这个操作，
                # 所以相当于 %esp 下面的东西都没了
popl %ebp        # 注意 %esp 指向旧的 %ebp ，所以将 %ebp 恢复为旧的 %ebp
                # 同时 %esp+4，指向返回地址&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 指令的效果为从栈中弹出一个地址，并跳转到这个地址
因为此时 &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 指向返回地址，因此程序跳转到返回地址，此时 &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 继续 +4 ，指向返回地址的上一个&lt;/p&gt;
&lt;p&gt;利用 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 的性质，本 Lab 中后几题都要用到一个技巧，在这些题中我们要自己输入汇编代码，再修改 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 的返回地址，让程序执行我们输入的代码，然后再 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 到别的函数中。但先让程序跳转到我们输入的地方已经使栈帧结构荡然无存，如何再让其 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 到一个特定位置？使用如下代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-assembly line-numbers&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;push $0xabcdefg
ret&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这段代码使程序 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 到地址 &lt;code class=&quot;language-text&quot;&gt;0xabcdefg&lt;/code&gt; 处。知道了 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 的具体效果，应该不难理解它的原理。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;小端法&lt;/p&gt;
&lt;p&gt;这只是一个小提醒了，直接输入地址作为 char 时要反一下，但如果是通过反编译生成的 char 就不用了，因为编译时系统已自动生成。看一下反编译出来的 asm 文件就能明白。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;下面开始题目相关：&lt;/p&gt;
&lt;h1&gt;Level 0：Candle&lt;/h1&gt;
&lt;p&gt;要求执行完 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 后跳转到 &lt;code class=&quot;language-text&quot;&gt;smoke&lt;/code&gt; 中，只要覆盖掉返回地址就可以，把原来的返回地址改为 &lt;code class=&quot;language-text&quot;&gt;smoke&lt;/code&gt; 函数的起始地址，本机上是 &lt;code class=&quot;language-text&quot;&gt;0x08048c8c&lt;/code&gt; ，这样答案可写成&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-text line-numbers&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
00 00 00 00
8c 8c 04 08&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;前面 40 个是正常存储的字节，后 4 个是旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 区域，最后 4 个就是返回地址。前面 00 只要是除了 &lt;code class=&quot;language-text&quot;&gt;’n’&lt;/code&gt; 任意均可，最后写成 &lt;code class=&quot;language-text&quot;&gt;smoke&lt;/code&gt; 起始地址的反序。&lt;/p&gt;
&lt;h1&gt;Level 1： Sparkler&lt;/h1&gt;
&lt;p&gt;跳转到 &lt;code class=&quot;language-text&quot;&gt;fizz&lt;/code&gt; 中，但是这时要把你的 cookie 作为参数传进去。第一感觉参数放在返回地址上面，但实际上却不是。 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 完事后 &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 指向返回地址上面一个地址，然后执行 &lt;code class=&quot;language-text&quot;&gt;fizz&lt;/code&gt; 时，先 push 了 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; ，此时 &lt;code class=&quot;language-text&quot;&gt;%esp-4&lt;/code&gt;  ，即原来保存返回地址的地方，然后 &lt;code class=&quot;language-text&quot;&gt;mov&lt;/code&gt; 指令将 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 也指向 &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 指向的地方，再取了 &lt;code class=&quot;language-text&quot;&gt;%ebp+8&lt;/code&gt; 指向的值作为参数，所以参数应该保存在这个位置，即返回地址向上 2 格的位置处！&lt;/p&gt;
&lt;p&gt;（图挂）&lt;/p&gt;
&lt;p&gt;至于为什么和常识不一样，是因为我们篡改了 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 的返回地址运行 &lt;code class=&quot;language-text&quot;&gt;fizz&lt;/code&gt; ，而没有 call &lt;code class=&quot;language-text&quot;&gt;fizz&lt;/code&gt; ，因此没有另保存一个返回地址，导致了偏差。&lt;/p&gt;
&lt;p&gt;答案与上题类似，不专门给出，可以自行推算或查看我开头给的两个别人的博客。&lt;/p&gt;
&lt;h1&gt;Level 2： Firecracker&lt;/h1&gt;
&lt;p&gt;跳转到 &lt;code class=&quot;language-text&quot;&gt;bang&lt;/code&gt; 中，但是需要更改一个全局变量。先验地知道全局变量存在程序中一个固定的地址处。&lt;/p&gt;
&lt;p&gt;查看 &lt;code class=&quot;language-text&quot;&gt;bang&lt;/code&gt; 中比较两数的代码：&lt;/p&gt;
&lt;p&gt;（图挂）&lt;/p&gt;
&lt;p&gt;不难发现 &lt;code class=&quot;language-text&quot;&gt;0x804d2a0&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;0x804d298&lt;/code&gt; 中存着全局变量和 cookie ，通过 GDB 调试进一步确定各自保存的东西（我在图中已经标出，另，据说也可通过 &lt;code class=&quot;language-text&quot;&gt;objdump -D&lt;/code&gt; 查看，此处不提）。知道了全局变量的保存地址，接下来就是自己构造代码了。思路如下：让代码以字符串的形式输入，然后修改 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 的返回地址为保存的字符串的起始位置，使程序执行这些代码，然后 &lt;code class=&quot;language-text&quot;&gt;ret&lt;/code&gt; 到 &lt;code class=&quot;language-text&quot;&gt;bang&lt;/code&gt; 中。我们需要手写汇编代码，然后使用 gcc 编译后再利用 objdump 反编译得到对应的 char 。代码如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-assembly line-numbers&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;movl $0xcookie, 0x804d2a0   # 把你的 cookie 放入全局变量，不用反序
push $0x8048d08             # 让这段代码执行完后返回 bang 函数
ret                         # 如果看不懂，复习本文之前的内容&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;反编译得到 char 后任意填充到 40 字节，再任意 4 字节覆盖旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; ，最后 4 字节写为保存字符串的起始地址即可。具体的就不再给出了。&lt;/p&gt;
&lt;h1&gt;Level 3：Dynamite&lt;/h1&gt;
&lt;p&gt;需要使 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 返回 cookie 而不是 1 。返回值保存在 &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; 中，只需要使 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 先返回到我们输入的代码处，替换掉 &lt;code class=&quot;language-text&quot;&gt;%eax&lt;/code&gt; 后再返回原来的 &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; 中即可。但是我们想让电脑以为什么错误都没发生，而之前的代码都把旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 覆盖掉了，这次不能覆盖它。（可以手工推一下，因为之前都是跳转到别的函数然后退出程序，这次返回到 &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; 中，而 &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; 是 &lt;code class=&quot;language-text&quot;&gt;getbuf&lt;/code&gt; 真正的调用者，返回后 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 要读自己指向的内容即旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 才能恢复 &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; 的栈帧，若被覆盖则不能还原）
因此这题的答案要注意两点。一是手工编写的汇编代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-assembly line-numbers&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;movl $0xcookie, %eax  # 把 %eax 改为你的cookie
push $0x8048d75       # 返回地址设为 test 中 call&amp;lt;getbuf&amp;gt; 的下一条，即正常状态下的返回地址
ret&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;二是要先用 GDB 调试读出旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 的值，其地址即为此刻 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 的值。然后要用这个值反序写在答案中覆盖旧的 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 的部分。&lt;/p&gt;
&lt;h1&gt;Level 4：Nitroglycerin&lt;/h1&gt;
&lt;p&gt;运行一次程序，会提示你输入 5 次字符串，要求每次的字符串都要相等，但 5 次字符串保存的位置不一样。其余要求同上一题。同样面临两个问题。一是无法得知 &lt;code class=&quot;language-text&quot;&gt;getbufn&lt;/code&gt; 的返回地址应该设在哪里，因不知道每次字符串的保存位置。解决方法是用 &lt;code class=&quot;language-text&quot;&gt;nop&lt;/code&gt; 指令，至于为什么，可以参考文首给出的两篇博客，我虽可理解但也未必讲得出所以然。只想说注意跳转的位置指向 5 次随机数的最高处。这个静下心来想一想可以想清楚。还有就是不知道 &lt;code class=&quot;language-text&quot;&gt;%ebp&lt;/code&gt; 要恢复成哪一个值，解决方法是依靠其与 &lt;code class=&quot;language-text&quot;&gt;%esp&lt;/code&gt; 的数量关系，那两篇博客也讲得很好了，此处不提。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[解决 JSP 与 MySQL 下各种中文乱码问题]]></title><description><![CDATA[近来 Web 课需要处理 JSP、MySQL 前台后台各种，不可避免地遇到了乱码问题。经过无数折腾以后终于（算是）解决，遂将经验总结如下： 本文记录了解决过程。想看结论及解决方案可以直接拉到最后。 Lab7 中已经遇到了连接数据库乱码的问题，当时的情况是： MySQL…]]></description><link>https://maliut.space/p/jsp-mysql-deal-messy-code/</link><guid isPermaLink="false">https://maliut.space/p/jsp-mysql-deal-messy-code/</guid><pubDate>Fri, 22 May 2015 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;近来 Web 课需要处理 JSP、MySQL 前台后台各种，不可避免地遇到了乱码问题。经过无数折腾以后终于（算是）解决，遂将经验总结如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本文记录了解决过程。想看结论及解决方案可以直接拉到最后。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!--more--&gt;
&lt;p&gt;Lab7 中已经遇到了连接数据库乱码的问题，当时的情况是：&lt;/p&gt;
&lt;p&gt;MySQL 默认安装的编码是 Latin1（ISO8859-1）
Eclipse 默认编码是 GBK ，后改为 UTF-8&lt;/p&gt;
&lt;p&gt;当时的现象：
MySQL 使用 UTF-8 建的数据库&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sql&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-sql line-numbers&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;CHARACTER&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;SET&lt;/span&gt; utf8 &lt;span class=&quot;token keyword&quot;&gt;COLLATE&lt;/span&gt; utf8_general_ci&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在命令行中可以正常输入中文并在命令行中显示，但是从 Java 中读取而且从 Java 中插入数据库的中文会乱码。&lt;/p&gt;
&lt;p&gt;当时的解决方法：
读取时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; sql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SELECT * FROM user&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Statement&lt;/span&gt; stm &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createStatement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;ResultSet&lt;/span&gt; rs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; stm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;executeQuery&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; isbn &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; bookName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Username&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    bookName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bookName&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;iso8859-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;gbk&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bookName &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;:&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; isbn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;写入时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; sql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;INSERT INTO ISBN_LIST (ISBN, BOOK_NAME) VALUES (&apos;%s&apos; , &apos;%s&apos;);&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; isbn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; bookName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
sql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;gbk&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;iso8859-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Statement&lt;/span&gt; stm &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createStatement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; row &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; stm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;executeUpdate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ok,&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; row &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;row(s) affected&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;为什么要转字符而且和 UTF-8 完全无关？不明！&lt;/strong&gt;
（ PS ：后来了解到 MySQL 变量因此转 ISO8859-1 应该是这方面的原因，但是 GBK 为什么有仍然不明）&lt;/p&gt;
&lt;p&gt;后来的探索：
因写 Lab 时中文是从 Eclipse 中打进去的，而 Project 的中文是从表单中用户输入获得的，上文的方法依旧导致乱码。
（ PS ：后来意识到中文从前台传到后台还没写入数据库就已经乱码，因此如果再转一次可能可以解决，但已经没办法回去试了，而且这样也不是长久之计，因为 MySQL 本身设置有问题）&lt;/p&gt;
&lt;p&gt;网上查询各种方法未果。
因为数据库建成时已经指定了 UTF-8 ，因此网上说的临时改字符集的方法都是没有用的。
网上某处看到 &lt;code class=&quot;language-text&quot;&gt;show variables like &amp;#39;character_set_%&amp;#39;;&lt;/code&gt;
查看 MySQL 的环境变量，发现除了指定了 database 是 UTF-8 ，其他有好多 Latin1 ，通过 &lt;code class=&quot;language-text&quot;&gt;SET character_set_database = utf8;&lt;/code&gt; 之类的方法全改成 UTF-8 并若干次重开 MySQL 服务（伴随删除数据表再新建）后发现重启 MySQL 后仍然还原成默认设置。也通过修改 my.ini 尝试过，但是仍有两项为 Latin1
这时候我认为把所有的改成 UTF-8 可以解决问题，因此在这种思路下在网上找到了真正的永久修改的方法：在 MySQL 安装目录下 bin 下找到 MYSQLInstanceConfig.exe 重新配置安装选项，在选择编码时选择 UTF-8 ，这样成功将所有环境变量变成 UTF-8 。（ PS ：这样也解决了 mysqldump 导出后中文乱码的问题）&lt;/p&gt;
&lt;p&gt;然而仍然不成功，而且发现这时候在命令行下也无法输入中文的值了。因为之前也看到过命令行的默认编码是 GBK ，会影响中文的显示（但是试过改成 UTF-8 结果出了一堆窗口上的变化导致不敢乱试而且觉得并不是主要），因此使用 &lt;code class=&quot;language-text&quot;&gt;SET NAMES &amp;#39;GBK&amp;#39;&lt;/code&gt; ，这样可以在命令行显示中文了，但在命令行看并没有什么用，最终还是要解决 JSP 下获取的问题.&lt;/p&gt;
&lt;p&gt;寄希望于能在 JSP 下正常得到，新建了一个 servlet 用来在网页中输出当前数据库的各条记录，使用本文开头 Lab 里所用的转换编码的方法多次尝试，但发现一点用处没有。这使我将目光转向生成 SQL 语句时的编码。生成 SQL 语句后同样按照本文开头 Lab 中的方法对其自身转换编码，虽然回回得到的还是乱码，但是乱码的形式在改变，证明这里可以起作用，或许只要找到正确的转换即可解决。这个时候我注意到之前插的一句调试语句：输出从前台得到的 name 的值，如果从前台得到的就是乱码，那么插进去肯定还是乱码（我也真是迟钝明明之前已经放了这个语句然而写完居然忘记了又去试验别的方法）
发现果然这个值得到的时候就已经是乱码了，观察乱码的形式感觉像是西欧文字，因此将转换的语句写为&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;sql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;iso8859-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;utf8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;果然可以正常显示中文了，我认为至此得到了使用上的解决
以前因为网页啊 Eclipse 啊都是 UTF-8 因此前一个编码认为应该是 UTF-8 ，但是后面不管怎么试都没用。这样确定了前面是西欧文字后，因为 MySQL 等都被我改成了 UTF-8 ，后面自然就觉得是 UTF-8
&lt;strong&gt;但是，为什么从前台得到的中文是西欧文字，并不知道&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;另：此时重开 MySQL 命令行，因为没有设置 &lt;code class=&quot;language-text&quot;&gt;SET NAMES ‘GBK’&lt;/code&gt; ，所以在 MySQL 中显示中文变了乱码，但是既然 JSP 得到是正常了，我认为命令行中 &lt;code class=&quot;language-text&quot;&gt;SET NAMES ‘GBK’&lt;/code&gt; ，或者把命令行编码改成 UTF-8 应该能显示正常。
（ PS: 的确如此）&lt;/p&gt;
&lt;p&gt;// 一天过去了 5.22
昨天只解决了 name 字段的中文乱码问题，而 name 字段只是一个普通的字段。今天当测试 username 字段为中文时出现了其他的问题。
username 字段需要用在登录页面中进行 SQL 查询，而且需要保存在 cookie 中
首先登录时使用中文名字果然无法登录，提示用户名或密码错误，结合昨天的经验容易想到在登录验证的 SQL 查询语句后增加&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;sql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;iso8859-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;utf8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然而并没有什么用（事实上是可以的，只是 Eclipse 的默认浏览器出了问题）&lt;/p&gt;
&lt;p&gt;又想到使用 Ajax 进行实时检测时也要进行 SQL 查询，试验后发现对于中文名字重复无法正常提示用户名已被占用，怀疑是编码的问题但是无论怎么改都没用，而后调试输出发现并没有什么问题，最后去掉了改编码的代码，在 chrome 下可以正常提示，网上的说法是 Ajax 是默认用 UTF-8 传值的，看来这个问题已经得到了解决
PS：此时 Eclipse 默认浏览器还是错误的。这个浏览器真是害人不浅，浪费了我大量时间，现在已经把运行的默认浏览器改成了 chrome &lt;del&gt;，只不过无法通过 &lt;code class=&quot;language-text&quot;&gt;system.out.println&lt;/code&gt; 方便调试了&lt;/del&gt;（更正：可以调试）。
知道了 Eclipse 浏览器的问题，换用 chrome ，登录问题也可以得到解决.&lt;/p&gt;
&lt;p&gt;此外我还探索了为什么前台后台传值使用 ISO8859-1 的问题，网上有说法说要改 Tomcat 的 server.xml 文件。我在安装目录和 Eclipse 的 project explorer 下的 Tomcat 都做了修改然而并没有什么用。或许是我没改对吧。不过更多的地方说更改这个文件并不是什么好方法，因为实际情况下有时不能改变服务器配置。因此作罢。&lt;/p&gt;
&lt;p&gt;随后是 cookie 存中文的问题，存中文会报错说有控制字符。这其实是一个小问题了，查阅网上资料后得知只要 &lt;code class=&quot;language-text&quot;&gt;URLEncoder.encode(username, &amp;quot;UTF-8&amp;quot;)&lt;/code&gt; 即可，这时候中文变成  &lt;code class=&quot;language-text&quot;&gt;%C3%A5%C2%95%C2%8A%C3%A5%C2%95%C2%8A%C3%A5%C2%95%C2%8A&lt;/code&gt; 这样的形式，可以正常存储了，但是在读取时却出了问题。
首先是 JS 读取 cookies 问题，用于在主页显示当前登录用户的用户名。然而用 JS 读出来并解码后发现还是乱码，西欧字符。经过检查， JS 读取 cookies 的内容是没问题的，就是之前存入的 cookies 的内容，这样问题就很明显了。因为从前台到后台得到的中文本来就是西欧字符，为了方便起见我在构成 SQL 查询字符串后进行了转码，这样不用单独对每一个得到的有可能是中文的前台表单元素在后台获得时就挨个进行转码。但是这样的话在存进 cookies 时所用来编码的 username 仍然是西欧字符的 username 。
因此，在保存 cookies 时先将 username 转码再 encode 存储即可。
注意： JS 解码时应使用 &lt;code class=&quot;language-text&quot;&gt;decodeURI&lt;/code&gt; 函数而不是 &lt;code class=&quot;language-text&quot;&gt;unescape&lt;/code&gt; 函数，后者仍然使用西欧编码解码。
注意：这样 SQL 和 cookie 处都有需要解码的地方，感觉看起来略杂乱，觉得还是不能偷懒，在获得前台表单值时就应立即转码。&lt;/p&gt;
&lt;p&gt;接下来是 servlet(JSP) 读取 cookies 问题，用于访问主页时根据 cookies 中是否有值判断应跳转至主页还是登录页面。既然前面已经将 cookies 正确储存了，这里就没什么问题了，直接在得到 cookies 以后 &lt;code class=&quot;language-text&quot;&gt;URLDecoder.decode(cUsername,&amp;quot;UTF-8&amp;quot;)&lt;/code&gt; 即可。
注意：这里的 SQL 查询构建 SQL 语句后就不用从西欧转到 UTF-8 了，因为这里有可能是中文的字段并不是从前台得到，而是从 cookie 中格式正确的中文得到。&lt;/p&gt;
&lt;h1&gt;结论&lt;/h1&gt;
&lt;p&gt;为了消灭乱码，请如下操作：&lt;/p&gt;
&lt;p&gt;一次性操作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;将 Eclipse 默认编码设置为 UTF-8&lt;/li&gt;
&lt;li&gt;在 MySQL 安装目录下 bin 下找到 MYSQLInstanceConfig.exe 重新配置安装选项，在选择编码时选择 UTF-8
（这样也不需要在每次建库时用长长一串指定 UTF-8 了）&lt;/li&gt;
&lt;li&gt;（补充）Eclipse：Window =&gt; Preference =&gt; Web=&gt; Jsp file下也改编码为 UTF-8 ，这个值不随 Eclipse 默认值改变，如果不改的话每次新建 Jsp 还要手动把三处 ISO8859-1 改成 UTF-8&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;编程时需要注意的：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;后台接收前台传来的值时，如果值有可能是中文，接收完立即调用 &lt;code class=&quot;language-text&quot;&gt;str = new String(str.getBytes(&amp;quot;iso8859-1&amp;quot;), &amp;quot;utf8&amp;quot;)&lt;/code&gt;转码（立即调用：这样进行 SQL 查询和存 cookie 时都不用额外转码）
（5.23 PS：按 ltl 同学的方法，在接收值之前加上&lt;code class=&quot;language-text&quot;&gt;request.setCharacterEncoding(&amp;quot;UTF-8&amp;quot;)&lt;/code&gt;可以解决这个问题，照原理来看应该也是可以的，然而我之前试验过没有成功，可能是那时候 Eclipse 自带浏览器的问题，待试验。如果这个证明可行，那么这一点可以和“其他”下的第 2 点归结为同一点，即后台 servlet 的 &lt;code class=&quot;language-text&quot;&gt;doGet&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;doPost&lt;/code&gt; 在开始写代码前都要把 request 和 response 的编码设一遍。）&lt;/li&gt;
&lt;li&gt;中文存进 cookies 时对可能为中文的字段需额外编码， &lt;code class=&quot;language-text&quot;&gt;URLEncoder.encode(str,&amp;quot;UTF-8&amp;quot;)&lt;/code&gt;
使用 Java 读取时使用 &lt;code class=&quot;language-text&quot;&gt;URLDecoder.decode(str, ”UTF-8″)&lt;/code&gt; 解码。使用 JS 读取时使用 &lt;code class=&quot;language-text&quot;&gt;decodeURI(str)&lt;/code&gt;解码&lt;/li&gt;
&lt;li&gt;以上步骤正确，那么 Ajax 不需要额外操作&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其他：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Eclipse 自带浏览器难以信任，请使用外部浏览器测试。（然而 chrome 多次测试后也出现了不正常的现象，可能需要休息一会？）&lt;/li&gt;
&lt;li&gt;关于在 servlet 中使用 &lt;code class=&quot;language-text&quot;&gt;out.print&lt;/code&gt; 输出引起乱码的问题：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setCharacterEncoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setContentType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;text/html&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setCharacterEncoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;PrintWriter&lt;/span&gt; out &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Java 使用 Gson 操作 JSON 数据]]></title><description><![CDATA[Lab8 需要操作 JSON 格式。毕竟用处广泛，而 Java 中有许多包可以用于操作 JSON （参见：http://www.json.org/） 起初使用 org.json ，但是将对象保存为 JSON…]]></description><link>https://maliut.space/p/java-use-gson/</link><guid isPermaLink="false">https://maliut.space/p/java-use-gson/</guid><pubDate>Fri, 12 Dec 2014 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Lab8 需要操作 JSON 格式。毕竟用处广泛，而 Java 中有许多包可以用于操作 JSON （参见：&lt;a href=&quot;http://www.json.org/&quot;&gt;http://www.json.org/&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;起初使用 org.json ，但是将对象保存为 JSON 时似乎需要将对象的每个属性都手工写入，而我的设想是自动探测对象的所有属性并写为 JSON （毕竟重复劳动）。遍寻网络无果，后来在某个角落发现 Gson 似乎可以实现。遂用之，发现功能强大。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1&gt;生成 JSON&lt;/h1&gt;
&lt;p&gt;需要生成 JSON 的数据类：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Player&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; deposit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Player&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; deposit&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;deposit &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; deposit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用于生成的代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;com&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;google&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gson&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Gson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token class-name&quot;&gt;Player&lt;/span&gt; players &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Player&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    players&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Player&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token class-name&quot;&gt;Gson&lt;/span&gt; gson &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Gson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// create Gson object&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; str &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; gson&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toJson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;players&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注：生成 Gson 对象除了用 &lt;code class=&quot;language-text&quot;&gt;new Gson()&lt;/code&gt; 外还有一种据说更高端的方法，反正我也不知道用处和区别就不写了&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;toJson&lt;/code&gt; 方法后的参数可以为对象，也可以为对象数组。都可以生成符合规范的 JSON 格式&lt;/p&gt;
&lt;h1&gt;读取 JSON&lt;/h1&gt;
&lt;p&gt;以从 OpenWeatherMap 的 API 返回的 JSON 为例（查询天气：&lt;a href=&quot;http://api.openweathermap.org/data/2.5/weather?q=London&quot;&gt;http://api.openweathermap.org/data/2.5/weather?q=London&lt;/a&gt;，各参数可参考 &lt;a href=&quot;http://openweathermap.org/weather-data#current&quot;&gt;http://openweathermap.org/weather-data#current&lt;/a&gt;）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-json line-numbers&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;88319&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;dt&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1345284000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Benghazi&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;coord&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;lat&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32.12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;lon&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20.07&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;temp&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;306.15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;pressure&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1013&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;humidity&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;44&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;temp_min&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;306&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;temp_max&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;306&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;wind&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;speed&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;deg&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;-7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;weather&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;520&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;rain&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;light intensity shower rain&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;icon&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;09d&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;rain&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;light rain&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;icon&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;10d&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;701&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mist&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mist&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;icon&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;50d&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;clouds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;all&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;90&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;rain&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token property&quot;&gt;&quot;3h&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一个复杂的 JSON 数据，为了读取需要先根据数据生成特定的类结构。结构如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WeatherState&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Main&lt;/span&gt; main&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Weather&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; weather&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Main&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;double&lt;/span&gt; temp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; temp_min&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; temp_max&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Weather&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;类名随意&lt;/li&gt;
&lt;li&gt;变量名需要严格符合 JSON 中的内容&lt;/li&gt;
&lt;li&gt;内部类需要 static ，这里使用内部类看起来更加清晰，用继承也可以&lt;/li&gt;
&lt;li&gt;变量 private + get/set 方法应该也可以，图方便用 public&lt;/li&gt;
&lt;li&gt;不需要把 JSON 中所有的数据都建构出来，你建了多少就会读出来多少（这一点非常好啊）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;用于读取的代码&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber NaN&quot; class=&quot;language-java line-numbers&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; jsonWeather &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/* 前面的 Json 数据 */&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Gson&lt;/span&gt; gson &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Gson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// create gson object&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;WeatherState&lt;/span&gt; w &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; gson&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fromJson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jsonWeather&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WeatherState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;w&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;w&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;main&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;temp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;w&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;weather&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以上即为 Gson 的基本用法&lt;/p&gt;</content:encoded></item><item><title><![CDATA[直与弯：我们喜欢的究竟是什么？]]></title><description><![CDATA[草稿 涉及到爱情本质的问题有空再写 喜欢 康德：物自体不可知 我们对外界事物的任何认识，实质上只不过是在脑中建构出关于事物的概念，也就是说我们并不是认识事物本身，而是它带给我们的感觉。 同理，当我们说『喜欢xxx』时，我们喜欢的也并不是xxx…]]></description><link>https://maliut.space/p/bent-and-straight/</link><guid isPermaLink="false">https://maliut.space/p/bent-and-straight/</guid><pubDate>Mon, 08 Dec 2014 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;草稿&lt;/h1&gt;
&lt;p&gt;涉及到爱情本质的问题有空再写&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1&gt;喜欢&lt;/h1&gt;
&lt;p&gt;康德：物自体不可知&lt;/p&gt;
&lt;p&gt;我们对外界事物的任何认识，实质上只不过是在脑中建构出关于事物的概念，也就是说我们并不是认识事物本身，而是它带给我们的感觉。&lt;/p&gt;
&lt;p&gt;同理，当我们说『喜欢xxx』时，我们喜欢的也并不是xxx本身，而是它带给我们的感觉。&lt;/p&gt;
&lt;h1&gt;性别&lt;/h1&gt;
&lt;p&gt;性别可以分成生理学性别和社会学性别&lt;/p&gt;
&lt;p&gt;生理学性别就是生理学上根据拥有染色体、器官种类等定义出来的。用哲学一点的话讲，就是根据第一世界的东西定义在第三世界中的概念。&lt;/p&gt;
&lt;p&gt;相对来说社会学性别就是第四世界中的概念（对较为公认的社会学性别来说）。&lt;/p&gt;
&lt;h1&gt;&lt;/h1&gt;
&lt;p&gt;这就是所谓【可爱的男孩子】，当你不知道他是男孩子之前也会蠢蠢欲动。也用来解释有些bl一个人扮演女生的角色。（当然心理学上也存在男生喜欢肌肉男的这并不否认）&lt;/p&gt;
&lt;p&gt;【所以只是喜欢看jpg也是很正常的啊&lt;/p&gt;
&lt;p&gt;【待续&lt;/p&gt;</content:encoded></item><item><title><![CDATA[游戏的艺术性]]></title><description><![CDATA[这篇文章需要重写 2018.08.0…]]></description><link>https://maliut.space/p/the-art-of-game/</link><guid isPermaLink="false">https://maliut.space/p/the-art-of-game/</guid><pubDate>Mon, 08 Dec 2014 00:00:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;这篇文章需要重写 2018.08.02&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;首先我坚信游戏是一门艺术。&lt;/p&gt;
&lt;p&gt;但是游戏之所以成其为艺术，必有其独特之处。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;关于游戏的艺术性，我前后也看了不少他人的观点，接触了不少思想（关于何谓游戏，何谓艺术，以及游戏的艺术性本身），观点也有一个发展的过程。&lt;/p&gt;
&lt;p&gt;现在我的基本观点如下：游戏的艺术性，最重要的在于交互性，这是游戏特有的。（在这里，交互性的定义不应该太过于广泛，比如你被动的看然后心里产生思想，但是并不影响你被看的事物）&lt;/p&gt;
&lt;p&gt;一般我们说游戏很有艺术感，往往是指游戏的音乐啊美术啊之类，这些只不过是音乐艺术，美术艺术用在游戏中，不能将其称为游戏艺术。但是它们也不是独立的，它们用在游戏中，帮助展现了游戏的交互性，因此已经不是纯粹的音乐和美术艺术了。因此它们也是游戏艺术不可分割的一部分。&lt;/p&gt;
&lt;h1&gt;交互性所带来的&lt;/h1&gt;
&lt;p&gt;为什么游戏仅仅多了交互性就能显得如此种类丰富且让人入迷呢？交互性使得表现形式的多样性大大增加，而更为关键的是给了玩家代入感。其他的所有艺术形式，观众永远只能位于观赏者的地位，即使与作品产生共情，也难以改变作品本身。而对于玩家而言，每一位玩家的游戏过程，都是一个不同的故事（不考虑某些特殊、极端情况，下文不加说明时同）。而为了配合这份交互性，很多游戏都是由一个主角作为世界中的观察者，而不是全局视角。这就让玩家真切地感受到自己是这个世界的一份子，而不是世界的旁观者。不可否认人总是关注自己比关注别人更多一点。&lt;/p&gt;
&lt;p&gt;有人认为游戏的交互性让玩家可以改变世界，这说法没有错，但其实不严谨。改变世界只是交互性可以带来的结果之一，但即使并没有改变世界，玩家的输入能够得到反馈，也让玩家有能够改变世界的错觉，甚至在有些游戏中玩家知道不能改变世界，但仍喜欢着交互性本身，这些玩家会对诸如打击感之类的有很高的要求。有些高自由度的游戏像 minecraft ，玩家可以随意改变世界，而 RPG 这种游戏类型，尤其是那些单线的 RPG ，玩家能够操作的仅仅是走路、打怪等，这只是给了玩家自由度的错觉，而结局早已确定。而 never alone 这种游戏（ps：写到这里我正在下载这个游戏，我不确定这里是否合适，这里只是用其指代我心目中的一类理想游戏），交互性的引入根本不是追求改变世界，而是为了提供一种体验。顺带一提，正如果文字教程的效果不如视频教程，而视频教程又不如亲自动手实践，这样的交互性正是未来实现教育游戏化的重要手段。&lt;del&gt;（大蛋糕啊）&lt;/del&gt;&lt;/p&gt;
&lt;h1&gt;游戏的定义&lt;/h1&gt;
&lt;p&gt;游戏的定义是什么？现在我们所说的游戏，颇有点折衷的感觉。要从词语本身来看，游戏就是跟干正事相对的娱乐活动。然而，现在越来越多的游戏不再追求娱乐，而是给人以震撼、感动或是启示等。毕竟在古代小说戏剧什么也不过是娱乐而已，这是游戏词义的正常变化。如果从交互来看，我们和现实世界进行着远远更加频繁和真实的交互，这也是为什么很多人说一切都是游戏。这也是完全正确的，&lt;del&gt;毕竟现实就是个垃圾游戏（当然从这里也有很多可以说，比如为什么人们更愿意沉迷游戏等，不过现在不想扯了，而且已经有很多人扯的很好了）&lt;/del&gt;。当然大部分人的直觉当然是把发生在虚拟中的才叫做游戏，但是随着增强现实的兴起，这一划分界限也在慢慢模糊。比如我带着 Google Glass 玩 Ingress 或者玩体感的 Kinect 算什么？&lt;/p&gt;
&lt;p&gt;游戏和体育的界限也很模糊。本来体育也不过是一些原始的工作（狩猎活动）和游戏活动（篮球etc）而已，只不过后来为了追求更高更快更强而逐渐专业化走上了一条不归路（大误）。现在电子竞技也成为体育运动了。其实这类竞技运动和别的游戏也挺好区分的，前者主要是一局一局的有着一个或几个对手的竞技活动。 66rpg 的某次短篇比赛就曾举例将单纯的黑白棋游戏和一个主角通过黑白棋一步步战胜敌人最终如何如何这两类做对比。其实我个人是挺不喜欢把前者叫做游戏的，不过这样说起来我倒是异端了。不过反正也是个定义的问题也没有对错，曾经也将后者定义为交互艺术，（然而也很难说体育不能成为艺术&lt;del&gt;虽然这样又扯远了但是大概就算说体育是艺术这两个艺术所指代的概念也是不一样的&lt;/del&gt;）。写到这里感觉一些SLG游戏的区分就有点模糊了像三国志啊海岛大亨什么的……大家怎么想呢？&lt;/p&gt;
&lt;h1&gt;如何欣赏一个游戏？&lt;/h1&gt;
&lt;p&gt;从哪个角度评价游戏的好坏呢？当然是有多少玩家氪金了！唔开个玩笑。我尚不知道最好的方法，然而很多人将游戏与电影对比，毕竟它们更为接近。我也上了一学期的电影赏析课，就就着两者的区别和共同点慢慢探索吧。&lt;/p&gt;
&lt;p&gt;一部电影一般来说是讲述一个故事，但其与现实世界的不同在于电影通过剪辑可以打破线性的结构，也可以通过不同的视角来讲故事。但一部电影的目的并不单纯是展示一种剪辑风格，而是将其作为一种手段，为导演所想要表达的内容服务，这有可能是一个好故事，有可能是一种思想，也有可能就是想展现一种镜头语言和剪辑风格。类比到游戏，游戏的交互性也是为主题、故事、或是玩法服务的。&lt;/p&gt;
&lt;p&gt;【待续，待整理&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Hello World Again！]]></title><description><![CDATA[from the start of wordpress@aliyun…]]></description><link>https://maliut.space/p/Hello-world-again/</link><guid isPermaLink="false">https://maliut.space/p/Hello-world-again/</guid><pubDate>Sun, 07 Dec 2014 00:00:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;from the start of wordpress@aliyun&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们总是希望有一个地方来记录自己，哪怕只是一次又一次的开坑。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;我们总是渴望被人理解，却又逃避社交，渴望从回忆中得到慰藉。藉由回忆的极端化效应【←我自己编的你来打我啊】而使看待现实的眼光更加消极。&lt;/p&gt;
&lt;p&gt;但是我就是我。追求真实但是明明知道根本找不到真实，追求所谓的真实但有不忍直视。雪之下主张改变，大老师主张面对，这两者又有什么区别呢？关键是，我正走在成为我所希望成为的人的道路上，这就够了。&lt;/p&gt;</content:encoded></item></channel></rss>